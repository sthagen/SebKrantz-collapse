<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head><link rel="shortcut icon" href="https://sebkrantz.github.io/collapse/favicon.ico" type="image/x-icon">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>*collapse* and *data.table* • collapse</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="*collapse* and *data.table*">
<meta property="og:description" content="collapse">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">collapse</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.5.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Documentation</a>
</li>
<li>
  <a href="../articles/index.html">Vignettes</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
<li>
  <a href="https://sebkrantz.github.io/Rblog/" target="_blank">Blog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://twitter.com/collapse_R" target="_blank">
    <span class="fa fa-twitter"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/SebKrantz/collapse" target="_blank">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="collapse_and_data.table_files/accessible-code-block-0.0.1/empty-anchor.js"></script><link href="collapse_and_data.table_files/anchor-sections-1.0/anchor-sections.css" rel="stylesheet">
<script src="collapse_and_data.table_files/anchor-sections-1.0/anchor-sections.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>
<em>collapse</em> and <em>data.table</em>
</h1>
            <h3 class="subtitle">Harmony and High Performance</h3>
                        <h4 class="author">Sebastian Krantz</h4>
            
            <h4 class="date">2021-01-04</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/SebKrantz/collapse/blob/master/vignettes/collapse_and_data.table.Rmd"><code>vignettes/collapse_and_data.table.Rmd</code></a></small>
      <div class="hidden name"><code>collapse_and_data.table.Rmd</code></div>

    </div>

    
    
<style type="text/css">
pre {
  max-height: 500px;
  overflow-y: auto;
}

pre[class] {
  max-height: 500px;
}
</style>
<!--
*collapse* is a C/C++ based package for data transformation and statistical computing in R. It's aims are:

1. To facilitate complex data transformation, exploration and computing tasks in R.
2. To help make R code fast, flexible, parsimonious and programmer friendly. 
--><p>This vignette focuses on using <em>collapse</em> with the popular <em>data.table</em> package by Matt Dowle and Arun Srinivasan. In contrast to <em>dplyr</em> and <em>plm</em> whose methods (<em>grouped_df</em>, <em>pseries</em>, <em>pdata.frame</em>) <em>collapse</em> supports, there is no deep integration between <em>collapse</em> and <em>data.table</em>.</p>
<p>However, <em>collapse</em> functions non-destructively handle <em>data.table</em>’s and the two packages work similarly on the C/C++ side of things, while largely complementary in functionality.</p>
<div id="purpose-and-strengths-of-each-package" class="section level2">
<h2 class="hasAnchor">
<a href="#purpose-and-strengths-of-each-package" class="anchor"></a>Purpose and Strengths of each Package</h2>
<p>Needless to say both <em>data.table</em> and <em>collapse</em> are high-performance packages that also work well together, but for effective use it is good to also understand where each has its strengths.</p>
<ul>
<li><p><em>data.table</em> offers an enhanced data frame based class to contain data (including list columns). For this class it provides a concise data manipulation syntax which also includes fast aggregation / slit-apply-combine computing, (rolling, non-equi) joins, keying, reshaping, some time-series functionality like lagging and rolling statistics, set operations on tables and a number of very useful other functions like the fast csv reader, fast switches, list-transpose etc.. <em>data.table</em> makes data management, and computations on data very easy and salable, supporting huge datasets in a very memory efficient way. The package caters well to the end user by compressing an enormous amount of functionality into two square brackets <code>[]</code>. Some of the exported functions are great for programming and also support other classes, but a lot of the functionality and optimization of <em>data.table</em> happens under the hood and can only be accessed through the non-standard evaluation table <code>[i, j, by]</code> syntax. This syntax has a cost of about 1-3 milliseconds for each call. Memory efficiency and thread-parallelization make <em>data.table</em> the star performer on huge data.</p></li>
<li><p><em>collapse</em> is class-agnostic in nature, supporting vectors, matrices, data frames and non-destructively handling all major R classes and objects. It’s functionality focuses on advanced statistical computations, by proving fast column-wise grouped and weighted statistical functions, fast and complex data aggregation and transformations, liner fitting, time series and panel data computations, some advanced summary statistics, and recursive processing of lists of data objects. It also offers some powerful supporting functions to perform fast data manipulation, grouping, factor generation, recoding, handling outliers and missing values. <em>collapse</em> supports both <em>tidyverse</em> (piped) and base R / standard evaluation programming. It is very programmer friendly by making accessible most of it’s internal C/C++ based functionality (like grouping objects). <em>collapse</em> functions are simple, access the underlying serial C/C++ code quickly and are very strongly optimized on the R side of things (resulting in basic function execution speeds of 10-50 microseconds). This makes <em>collapse</em> ideal for advanced and high-performance statistical computing on matrices and large datasets, and tasks requiring fast programs with repeated function executions.</p></li>
</ul>
<!-- (< 10 mio obs.). --><!-- 
Thus you don't need to choose between these two. I created *collapse* because I wanted more flexibility and programmability and *data.table* fell short on my statistical demands. I still manage most of my data using *data.table*. -->
</div>
<div id="interoperating-and-some-dos-and-donts" class="section level2">
<h2 class="hasAnchor">
<a href="#interoperating-and-some-dos-and-donts" class="anchor"></a>Interoperating and some Do’s and Dont’s</h2>
<p>Applying <em>collapse</em> functions to a data.table always gives a data.table back e.g. </p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://sebkrantz.github.io/collapse/">collapse</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org">magrittr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://Rdatatable.gitlab.io/data.table">data.table</a></span><span class="op">)</span>

<span class="va">DT</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/A4-quick-conversion.html">qDT</a></span><span class="op">(</span><span class="va">wlddev</span><span class="op">)</span> <span class="co"># collapse::qDT converts objects to data.table using a shallow copy</span>


<span class="va">DT</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">gby</a></span><span class="op">(</span><span class="va">country</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">gv</a></span><span class="op">(</span><span class="fl">9</span><span class="op">:</span><span class="fl">12</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">fmean</span>
<span class="co">#                    country      PCGDP   LIFEEX     GINI        ODA</span>
<span class="co">#   1:           Afghanistan   482.1631 47.88216       NA 1351073448</span>
<span class="co">#   2:               Albania  2710.1591 71.34056 29.66000  300307000</span>
<span class="co">#   3:               Algeria  3474.3201 62.72084 34.36667  583888276</span>
<span class="co">#   4:        American Samoa 10189.2155       NA       NA         NA</span>
<span class="co">#   5:               Andorra 40071.4635       NA       NA         NA</span>
<span class="co">#  ---                                                              </span>
<span class="co"># 212: Virgin Islands (U.S.) 36049.6948 73.43375       NA         NA</span>
<span class="co"># 213:    West Bank and Gaza  2268.0728 71.12307 34.52500 1491175200</span>
<span class="co"># 214:           Yemen, Rep.  1084.5999 53.01923 35.46667  639058966</span>
<span class="co"># 215:                Zambia  1299.2385 49.32509 52.68889  683860862</span>
<span class="co"># 216:              Zimbabwe  1205.5424 54.07304 43.20000  358268214</span>

<span class="co"># Same thing, but notice that fmean give's NA's for missing countries</span>
<span class="va">DT</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">.SD</span>, <span class="va">mean</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, keyby <span class="op">=</span> <span class="va">country</span>, .SDcols <span class="op">=</span> <span class="fl">9</span><span class="op">:</span><span class="fl">12</span><span class="op">]</span>
<span class="co">#                    country      PCGDP   LIFEEX     GINI        ODA</span>
<span class="co">#   1:           Afghanistan   482.1631 47.88216      NaN 1351073448</span>
<span class="co">#   2:               Albania  2710.1591 71.34056 29.66000  300307000</span>
<span class="co">#   3:               Algeria  3474.3201 62.72084 34.36667  583888276</span>
<span class="co">#   4:        American Samoa 10189.2155      NaN      NaN        NaN</span>
<span class="co">#   5:               Andorra 40071.4635      NaN      NaN        NaN</span>
<span class="co">#  ---                                                              </span>
<span class="co"># 212: Virgin Islands (U.S.) 36049.6948 73.43375      NaN        NaN</span>
<span class="co"># 213:    West Bank and Gaza  2268.0728 71.12307 34.52500 1491175200</span>
<span class="co"># 214:           Yemen, Rep.  1084.5999 53.01923 35.46667  639058966</span>
<span class="co"># 215:                Zambia  1299.2385 49.32509 52.68889  683860862</span>
<span class="co"># 216:              Zimbabwe  1205.5424 54.07304 43.20000  358268214</span>

<span class="co"># This also works without magrittr pipes with the collap() function</span>
<span class="fu"><a href="../reference/collap.html">collap</a></span><span class="op">(</span><span class="va">DT</span>, <span class="op">~</span> <span class="va">country</span>, <span class="va">fmean</span>, cols <span class="op">=</span> <span class="fl">9</span><span class="op">:</span><span class="fl">12</span><span class="op">)</span>
<span class="co">#                    country      PCGDP   LIFEEX     GINI        ODA</span>
<span class="co">#   1:           Afghanistan   482.1631 47.88216       NA 1351073448</span>
<span class="co">#   2:               Albania  2710.1591 71.34056 29.66000  300307000</span>
<span class="co">#   3:               Algeria  3474.3201 62.72084 34.36667  583888276</span>
<span class="co">#   4:        American Samoa 10189.2155       NA       NA         NA</span>
<span class="co">#   5:               Andorra 40071.4635       NA       NA         NA</span>
<span class="co">#  ---                                                              </span>
<span class="co"># 212: Virgin Islands (U.S.) 36049.6948 73.43375       NA         NA</span>
<span class="co"># 213:    West Bank and Gaza  2268.0728 71.12307 34.52500 1491175200</span>
<span class="co"># 214:           Yemen, Rep.  1084.5999 53.01923 35.46667  639058966</span>
<span class="co"># 215:                Zambia  1299.2385 49.32509 52.68889  683860862</span>
<span class="co"># 216:              Zimbabwe  1205.5424 54.07304 43.20000  358268214</span></pre></div>
<p>By default, <em>collapse</em> orders groups in aggregations, which is equivalent to using <code>keyby</code> with <em>data.table</em>. <code>gby / fgroup_by</code> has an argument <code>sort = FALSE</code> to yield an unordered grouping equivalent to <em>data.table</em>’s <code>by</code> on character data<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>.</p>
<p>At this data size <em>collapse</em> outperforms <em>data.table</em> (which might reverse as data size grows, depending in your computer, the number of <em>data.table</em> threads used, and the function in question):</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/joshuaulrich/microbenchmark/">microbenchmark</a></span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>collapse <span class="op">=</span> <span class="va">DT</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">gby</a></span><span class="op">(</span><span class="va">country</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">get_vars</a></span><span class="op">(</span><span class="fl">9</span><span class="op">:</span><span class="fl">12</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">fmean</span>,
               data.table <span class="op">=</span> <span class="va">DT</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">.SD</span>, <span class="va">mean</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, keyby <span class="op">=</span> <span class="va">country</span>, .SDcols <span class="op">=</span> <span class="fl">9</span><span class="op">:</span><span class="fl">12</span><span class="op">]</span><span class="op">)</span>
<span class="co"># Unit: microseconds</span>
<span class="co">#        expr      min        lq      mean   median        uq      max neval cld</span>
<span class="co">#    collapse  410.103  463.8755  511.2001  494.890  545.0925  877.325   100  a </span>
<span class="co">#  data.table 1812.215 2135.5215 2446.3601 2433.392 2623.9400 7492.509   100   b</span></pre></div>
<p>It is critical to never do something like this:</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="va">DT</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">.SD</span>, <span class="va">fmean</span><span class="op">)</span>, keyby <span class="op">=</span> <span class="va">country</span>, .SDcols <span class="op">=</span> <span class="fl">9</span><span class="op">:</span><span class="fl">12</span><span class="op">]</span>
<span class="co">#                    country      PCGDP   LIFEEX     GINI        ODA</span>
<span class="co">#   1:           Afghanistan   482.1631 47.88216       NA 1351073448</span>
<span class="co">#   2:               Albania  2710.1591 71.34056 29.66000  300307000</span>
<span class="co">#   3:               Algeria  3474.3201 62.72084 34.36667  583888276</span>
<span class="co">#   4:        American Samoa 10189.2155       NA       NA         NA</span>
<span class="co">#   5:               Andorra 40071.4635       NA       NA         NA</span>
<span class="co">#  ---                                                              </span>
<span class="co"># 212: Virgin Islands (U.S.) 36049.6948 73.43375       NA         NA</span>
<span class="co"># 213:    West Bank and Gaza  2268.0728 71.12307 34.52500 1491175200</span>
<span class="co"># 214:           Yemen, Rep.  1084.5999 53.01923 35.46667  639058966</span>
<span class="co"># 215:                Zambia  1299.2385 49.32509 52.68889  683860862</span>
<span class="co"># 216:              Zimbabwe  1205.5424 54.07304 43.20000  358268214</span></pre></div>
<p>The reason is that <em>collapse</em> functions are S3 generic with methods for vectors, matrices and data frames among others. So you incur a method-dispatch for every column and every group the function is applied to.</p>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="va">fmean</span>
<span class="co"># function(x, ...) UseMethod("fmean")</span>
<span class="co"># &lt;bytecode: 0x00000000121ac368&gt;</span>
<span class="co"># &lt;environment: namespace:collapse&gt;</span>
<span class="fu"><a href="https://rdrr.io/r/utils/methods.html">methods</a></span><span class="op">(</span><span class="va">fmean</span><span class="op">)</span>
<span class="co"># [1] fmean.data.frame  fmean.default     fmean.grouped_df* fmean.list*       fmean.matrix     </span>
<span class="co"># see '?methods' for accessing help and source code</span></pre></div>
<p>You may now contend that <code><a href="https://rdrr.io/r/base/mean.html">base::mean</a></code> is also S3 generic, but in this <code>DT[, lapply(.SD, mean, na.rm = TRUE), by = country, .SDcols = 9:12]</code> code <em>data.table</em> does not use <code><a href="https://rdrr.io/r/base/mean.html">base::mean</a></code>, but <code>data.table:::gmean</code>, an internal optimized mean function which is efficiently applied over those groups (see <code><a href="https://rdrr.io/pkg/data.table/man/datatable-optimize.html">?data.table::GForce</a></code>). <code>fmean</code> works similar, and includes this functionality explicitly.</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">fmean.data.frame</span><span class="op">)</span>
<span class="co"># function (x, g = NULL, w = NULL, TRA = NULL, na.rm = TRUE, use.g.names = TRUE, drop = TRUE, </span>
<span class="co">#     ...)  </span>
<span class="co">#  - attr(*, "srcref")= 'srcref' int [1:8] 63 21 90 1 21 1 4720 4747</span>
<span class="co">#   ..- attr(*, "srcfile")=Classes 'srcfilealias', 'srcfile' &lt;environment: 0x00000000121a9748&gt;</span></pre></div>
<p>Here we can see the <code>x</code> argument for the data, the <code>g</code> argument for grouping vectors, a weight vector <code>w</code>, different options <code>TRA</code> to transform the original data using the computed means, and some functionality regarding missing values (default: removed / skipped), group names (which are added as row-names to a data frame, but not to a <em>data.table</em>) etc. So we can also do</p>
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">gv</a></span><span class="op">(</span><span class="va">DT</span>, <span class="fl">9</span><span class="op">:</span><span class="fl">12</span><span class="op">)</span>, <span class="va">DT</span><span class="op">$</span><span class="va">country</span><span class="op">)</span>
<span class="co">#           PCGDP   LIFEEX     GINI        ODA</span>
<span class="co">#   1:   482.1631 47.88216       NA 1351073448</span>
<span class="co">#   2:  2710.1591 71.34056 29.66000  300307000</span>
<span class="co">#   3:  3474.3201 62.72084 34.36667  583888276</span>
<span class="co">#   4: 10189.2155       NA       NA         NA</span>
<span class="co">#   5: 40071.4635       NA       NA         NA</span>
<span class="co">#  ---                                        </span>
<span class="co"># 212: 36049.6948 73.43375       NA         NA</span>
<span class="co"># 213:  2268.0728 71.12307 34.52500 1491175200</span>
<span class="co"># 214:  1084.5999 53.01923 35.46667  639058966</span>
<span class="co"># 215:  1299.2385 49.32509 52.68889  683860862</span>
<span class="co"># 216:  1205.5424 54.07304 43.20000  358268214</span>

<span class="co"># Or</span>
<span class="va">g</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">GRP</a></span><span class="op">(</span><span class="va">DT</span>, <span class="st">"country"</span><span class="op">)</span>
<span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">add_vars</a></span><span class="op">(</span><span class="va">g</span><span class="op">[[</span><span class="st">"groups"</span><span class="op">]</span><span class="op">]</span>, <span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">gv</a></span><span class="op">(</span><span class="va">DT</span>, <span class="fl">9</span><span class="op">:</span><span class="fl">12</span><span class="op">)</span>, <span class="va">g</span><span class="op">)</span><span class="op">)</span>
<span class="co">#                    country      PCGDP   LIFEEX     GINI        ODA</span>
<span class="co">#   1:           Afghanistan   482.1631 47.88216       NA 1351073448</span>
<span class="co">#   2:               Albania  2710.1591 71.34056 29.66000  300307000</span>
<span class="co">#   3:               Algeria  3474.3201 62.72084 34.36667  583888276</span>
<span class="co">#   4:        American Samoa 10189.2155       NA       NA         NA</span>
<span class="co">#   5:               Andorra 40071.4635       NA       NA         NA</span>
<span class="co">#  ---                                                              </span>
<span class="co"># 212: Virgin Islands (U.S.) 36049.6948 73.43375       NA         NA</span>
<span class="co"># 213:    West Bank and Gaza  2268.0728 71.12307 34.52500 1491175200</span>
<span class="co"># 214:           Yemen, Rep.  1084.5999 53.01923 35.46667  639058966</span>
<span class="co"># 215:                Zambia  1299.2385 49.32509 52.68889  683860862</span>
<span class="co"># 216:              Zimbabwe  1205.5424 54.07304 43.20000  358268214</span></pre></div>
<p>To give us the same result obtained through the high-level functions <code>gby / fgroup_by</code> or <code>collap</code>. This is however not what <em>data.table</em> is doing in <code>DT[, lapply(.SD, fmean), by = country, .SDcols = 9:12]</code>. Since <code>fmean</code> is not a function it recognizes and is able to optimize, it does something like this,</p>
<div class="sourceCode" id="cb7"><pre class="downlit">
<span class="fu"><a href="../reference/BY.html">BY</a></span><span class="op">(</span><span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">gv</a></span><span class="op">(</span><span class="va">DT</span>, <span class="fl">9</span><span class="op">:</span><span class="fl">12</span><span class="op">)</span>, <span class="va">g</span>, <span class="va">fmean</span><span class="op">)</span> <span class="co"># using collapse::BY</span>
<span class="co">#           PCGDP   LIFEEX     GINI        ODA</span>
<span class="co">#   1:   482.1631 47.88216       NA 1351073448</span>
<span class="co">#   2:  2710.1591 71.34056 29.66000  300307000</span>
<span class="co">#   3:  3474.3201 62.72084 34.36667  583888276</span>
<span class="co">#   4: 10189.2155       NA       NA         NA</span>
<span class="co">#   5: 40071.4635       NA       NA         NA</span>
<span class="co">#  ---                                        </span>
<span class="co"># 212: 36049.6948 73.43375       NA         NA</span>
<span class="co"># 213:  2268.0728 71.12307 34.52500 1491175200</span>
<span class="co"># 214:  1084.5999 53.01923 35.46667  639058966</span>
<span class="co"># 215:  1299.2385 49.32509 52.68889  683860862</span>
<span class="co"># 216:  1205.5424 54.07304 43.20000  358268214</span></pre></div>
<p>which applies <code>fmean</code> to every group in every column of the data.</p>
<p>More generally, it is very important to understand that <em>collapse</em> is not based around applying functions to data by groups using some universal mechanism: The <em>dplyr</em> <code>data %&gt;% group_by(...) %&gt;% summarize(...) / mutate(...)</code> and <em>data.table</em> <code>[i, j, by]</code> syntax are essentially universal mechanisms to apply any function to data by groups. <em>data.table</em> additionally internally optimizes some functions (<code>min, max, mean, median, var, sd, sum, prod, first, last, head, tail</code>) which they called GForce, <code><a href="https://rdrr.io/pkg/data.table/man/datatable-optimize.html">?data.table::GForce</a></code>.</p>
<p><em>collapse</em> instead provides grouped statistical and transformation functions where all grouped computation is done efficiently in C++, and some supporting mechanisms (<code>fgroup_by</code>, <code>collap</code>) to operate them. In <em>data.table</em> words, everything<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a> in <em>collapse</em>, the <em>Fast Statistical Functions</em>, data transformations, time series etc. is GForce optimized.</p>
<p>The full set of optimized grouped statistical and transformation functions in <em>collapse</em> is:</p>
<div class="sourceCode" id="cb8"><pre class="downlit">
<span class="va">.FAST_FUN</span>
<span class="co">#  [1] "fmean"      "fmedian"    "fmode"      "fsum"       "fprod"      "fsd"        "fvar"      </span>
<span class="co">#  [8] "fmin"       "fmax"       "fnth"       "ffirst"     "flast"      "fNobs"      "fNdistinct"</span>
<span class="co"># [15] "fscale"     "fbetween"   "fwithin"    "fHDbetween" "fHDwithin"  "flag"       "fdiff"     </span>
<span class="co"># [22] "fgrowth"</span></pre></div>
<p>Additional optimized grouped functions include <code>TRA</code>, <code>qsu</code>, <code>varying</code>, <code>fFtest</code>, <code>psmat</code>, <code>psacf</code>, <code>pspacf</code>, <code>psccf</code>.</p>
<p>The nice thing about those GForce (fast) functions provided by <em>collapse</em> is that they can be accessed explicitly and programmatically without any overhead as incurred through <em>data.table</em>, they cover a broader range of statistical operations (such as mode, distinct values, order statistics), support sampling weights, operate in a class-agnostic way on vectors, matrices, data.frame’s and many related classes, and cover transformations (replacing and sweeping, scaling, (higher order) centering, linear fitting) and time series functionality (lags, differences and growth rates, including irregular time series and unbalanced panels).</p>
<!-- *collapse* allows you to do explicitly and programmatically with the *Fast Statistical Functions*. -->
<p>So if we would want to use <code>fmean</code> inside the <em>data.table</em>, we should do something like this:</p>
<div class="sourceCode" id="cb9"><pre class="downlit">
<span class="co"># This does not save the grouping columns, we are simply passing a grouping vector to g</span>
<span class="co"># and aggregating the subset of the data table (.SD).</span>
<span class="va">DT</span><span class="op">[</span>, <span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="va">.SD</span>, <span class="va">country</span><span class="op">)</span>, .SDcols <span class="op">=</span> <span class="fl">9</span><span class="op">:</span><span class="fl">12</span><span class="op">]</span>
<span class="co">#           PCGDP   LIFEEX     GINI        ODA</span>
<span class="co">#   1:   482.1631 47.88216       NA 1351073448</span>
<span class="co">#   2:  2710.1591 71.34056 29.66000  300307000</span>
<span class="co">#   3:  3474.3201 62.72084 34.36667  583888276</span>
<span class="co">#   4: 10189.2155       NA       NA         NA</span>
<span class="co">#   5: 40071.4635       NA       NA         NA</span>
<span class="co">#  ---                                        </span>
<span class="co"># 212: 36049.6948 73.43375       NA         NA</span>
<span class="co"># 213:  2268.0728 71.12307 34.52500 1491175200</span>
<span class="co"># 214:  1084.5999 53.01923 35.46667  639058966</span>
<span class="co"># 215:  1299.2385 49.32509 52.68889  683860862</span>
<span class="co"># 216:  1205.5424 54.07304 43.20000  358268214</span>

<span class="co"># If we want to keep the grouping columns, we need to group .SD first.</span>
<span class="va">DT</span><span class="op">[</span>, <span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="fu"><a href="../reference/GRP,%20fgroup_by.html">gby</a></span><span class="op">(</span><span class="va">.SD</span>, <span class="va">country</span><span class="op">)</span><span class="op">)</span>, .SDcols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1L</span>, <span class="fl">9</span><span class="op">:</span><span class="fl">12</span><span class="op">)</span><span class="op">]</span>
<span class="co">#                    country      PCGDP   LIFEEX     GINI        ODA</span>
<span class="co">#   1:           Afghanistan   482.1631 47.88216       NA 1351073448</span>
<span class="co">#   2:               Albania  2710.1591 71.34056 29.66000  300307000</span>
<span class="co">#   3:               Algeria  3474.3201 62.72084 34.36667  583888276</span>
<span class="co">#   4:        American Samoa 10189.2155       NA       NA         NA</span>
<span class="co">#   5:               Andorra 40071.4635       NA       NA         NA</span>
<span class="co">#  ---                                                              </span>
<span class="co"># 212: Virgin Islands (U.S.) 36049.6948 73.43375       NA         NA</span>
<span class="co"># 213:    West Bank and Gaza  2268.0728 71.12307 34.52500 1491175200</span>
<span class="co"># 214:           Yemen, Rep.  1084.5999 53.01923 35.46667  639058966</span>
<span class="co"># 215:                Zambia  1299.2385 49.32509 52.68889  683860862</span>
<span class="co"># 216:              Zimbabwe  1205.5424 54.07304 43.20000  358268214</span></pre></div>
<p>Needless to say this kind of programming seems a bit arcane, so there is actually not that great of a scope to use collapse’s <em>Fast Statistical Functions</em> for aggregations inside <em>data.table</em>. I drive this point home with a benchmark:</p>
<div class="sourceCode" id="cb10"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>collapse <span class="op">=</span> <span class="va">DT</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">gby</a></span><span class="op">(</span><span class="va">country</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">get_vars</a></span><span class="op">(</span><span class="fl">9</span><span class="op">:</span><span class="fl">12</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">fmean</span>,
               data.table <span class="op">=</span> <span class="va">DT</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">.SD</span>, <span class="va">mean</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, keyby <span class="op">=</span> <span class="va">country</span>, .SDcols <span class="op">=</span> <span class="fl">9</span><span class="op">:</span><span class="fl">12</span><span class="op">]</span>,
               data.table_base <span class="op">=</span> <span class="va">DT</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">.SD</span>, <span class="fu">base</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, keyby <span class="op">=</span> <span class="va">country</span>, .SDcols <span class="op">=</span> <span class="fl">9</span><span class="op">:</span><span class="fl">12</span><span class="op">]</span>,
               hybrid_bad <span class="op">=</span> <span class="va">DT</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">.SD</span>, <span class="va">fmean</span><span class="op">)</span>, keyby <span class="op">=</span> <span class="va">country</span>, .SDcols <span class="op">=</span> <span class="fl">9</span><span class="op">:</span><span class="fl">12</span><span class="op">]</span>,
               hybrid_ok <span class="op">=</span> <span class="va">DT</span><span class="op">[</span>, <span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="fu"><a href="../reference/GRP,%20fgroup_by.html">gby</a></span><span class="op">(</span><span class="va">.SD</span>, <span class="va">country</span><span class="op">)</span><span class="op">)</span>, .SDcols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1L</span>, <span class="fl">9</span><span class="op">:</span><span class="fl">12</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
<span class="co"># Unit: microseconds</span>
<span class="co">#             expr       min         lq       mean     median        uq       max neval  cld</span>
<span class="co">#         collapse   375.741   449.1495   524.2707   483.2875   535.275  1855.947   100 a   </span>
<span class="co">#       data.table  1794.365  2083.3105  2558.8638  2567.4895  2860.006  6004.717   100  b  </span>
<span class="co">#  data.table_base 13112.559 14219.7020 16158.3515 14555.2805 17105.143 33718.966   100    d</span>
<span class="co">#       hybrid_bad  6815.550  7450.7845  9087.5431  7698.2295  8474.701 21975.051   100   c </span>
<span class="co">#        hybrid_ok  1091.077  1222.7205  1338.6381  1279.8405  1367.528  2480.695   100 a</span></pre></div>
<p>It is evident that <em>data.table</em> has some overhead, so there is absolutely no need to do this kind of syntax manipulation.</p>
<p>There is more scope to use <em>collapse</em> transformation functions inside <em>data.table</em>. <!--
Note that `:=` operations (transformations) are not GForce optimized in *data.table*, nor are any weighted computations. So *collapse* gives you a lot of extra speed on these areas. --></p>
<p>Below some basic examples:</p>
<div class="sourceCode" id="cb11"><pre class="downlit">
<span class="co"># Computing a column containing the sum of ODA received by country</span>
<span class="va">DT</span><span class="op">[</span>, <span class="va">sum_ODA</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">ODA</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">country</span><span class="op">]</span>
<span class="co"># Same using fsum; "replace_fill" overwrites missing values, "replace" keeps the</span>
<span class="va">DT</span><span class="op">[</span>, <span class="va">sum_ODA</span> <span class="op">:=</span> <span class="fu"><a href="../reference/fsum.html">fsum</a></span><span class="op">(</span><span class="va">ODA</span>, <span class="va">country</span>, TRA <span class="op">=</span> <span class="st">"replace_fill"</span><span class="op">)</span><span class="op">]</span>  
<span class="co"># Same: A native collapse solution using settransform (or its shortcut form)</span>
<span class="fu"><a href="../reference/ftransform.html">settfm</a></span><span class="op">(</span><span class="va">DT</span>, sum_ODA <span class="op">=</span> <span class="fu"><a href="../reference/fsum.html">fsum</a></span><span class="op">(</span><span class="va">ODA</span>, <span class="va">country</span>, TRA <span class="op">=</span> <span class="st">"replace_fill"</span><span class="op">)</span><span class="op">)</span>  

<span class="co"># settfm may be more convenient than `:=` for multiple column modifications,</span>
<span class="co"># each involving a different grouping:</span>
  <span class="co"># This computes the percentage of total ODA distributed received by </span>
  <span class="co"># each country both over time and within a given year</span>
<span class="fu"><a href="../reference/ftransform.html">settfm</a></span><span class="op">(</span><span class="va">DT</span>, perc_c_ODA <span class="op">=</span> <span class="fu"><a href="../reference/fsum.html">fsum</a></span><span class="op">(</span><span class="va">ODA</span>, <span class="va">country</span>, TRA <span class="op">=</span> <span class="st">"%"</span><span class="op">)</span>,
           perc_y_ODA <span class="op">=</span> <span class="fu"><a href="../reference/fsum.html">fsum</a></span><span class="op">(</span><span class="va">ODA</span>, <span class="va">year</span>, TRA <span class="op">=</span> <span class="st">"%"</span><span class="op">)</span><span class="op">)</span></pre></div>
<p>The <code>TRA</code> argument is available to all <em>Fast Statistical Functions</em> (see the macro <code>.FAST_STAT_FUN</code>) and offers 10 different replacing and sweeping operations. Note that <code><a href="../reference/TRA.html">TRA()</a></code> can also be called directly to replace or sweep with a previously aggregated <em>data.table</em>. A set of operators <code><a href="../reference/arithmetic.html">%rr%</a></code>, <code><a href="../reference/arithmetic.html">%r+%</a></code>, <code><a href="../reference/arithmetic.html">%r-%</a></code>, <code><a href="../reference/arithmetic.html">%r*%</a></code>, <code><a href="../reference/arithmetic.html">%r/%</a></code>, <code><a href="../reference/arithmetic.html">%cr%</a></code>, <code><a href="../reference/arithmetic.html">%c+%</a></code>, <code><a href="../reference/arithmetic.html">%c-%</a></code>, <code><a href="../reference/arithmetic.html">%c*%</a></code>, <code><a href="../reference/arithmetic.html">%c/%</a></code> additionally facilitate row- or column-wise replacing or sweeping out vectors of statistics or other <em>data.table</em>’s.</p>
<p>Similarly, we can use the following vector valued functions</p>
<div class="sourceCode" id="cb12"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/pkg/data.table/man/setops.html">setdiff</a></span><span class="op">(</span><span class="va">.FAST_FUN</span>, <span class="va">.FAST_STAT_FUN</span><span class="op">)</span>
<span class="co"># [1] "fscale"     "fbetween"   "fwithin"    "fHDbetween" "fHDwithin"  "flag"       "fdiff"     </span>
<span class="co"># [8] "fgrowth"</span></pre></div>
<p>for very efficient data transformations:</p>
<div class="sourceCode" id="cb13"><pre class="downlit">
<span class="co"># Centering GDP</span>
<span class="va">DT</span><span class="op">[</span>, <span class="va">demean_PCGDP</span> <span class="op">:=</span> <span class="va">PCGDP</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">PCGDP</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">country</span><span class="op">]</span>
<span class="va">DT</span><span class="op">[</span>, <span class="va">demean_PCGDP</span> <span class="op">:=</span> <span class="fu"><a href="../reference/fbetween,%20fwithin.html">fwithin</a></span><span class="op">(</span><span class="va">PCGDP</span>, <span class="va">country</span><span class="op">)</span><span class="op">]</span>

<span class="co"># Lagging GDP</span>
<span class="va">DT</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/data.table/man/setorder.html">order</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span>, <span class="va">lag_PCGDP</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/pkg/data.table/man/shift.html">shift</a></span><span class="op">(</span><span class="va">PCGDP</span>, <span class="fl">1L</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">country</span><span class="op">]</span>
<span class="va">DT</span><span class="op">[</span>, <span class="va">lag_PCGDP</span> <span class="op">:=</span> <span class="fu"><a href="../reference/flag.html">flag</a></span><span class="op">(</span><span class="va">PCGDP</span>, <span class="fl">1L</span>, <span class="va">country</span>, <span class="va">year</span><span class="op">)</span><span class="op">]</span>

<span class="co"># Computing a growth rate</span>
<span class="va">DT</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/data.table/man/setorder.html">order</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span>, <span class="va">growth_PCGDP</span> <span class="op">:=</span> <span class="op">(</span><span class="va">PCGDP</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/pkg/data.table/man/shift.html">shift</a></span><span class="op">(</span><span class="va">PCGDP</span>, <span class="fl">1L</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span>, by <span class="op">=</span> <span class="va">country</span><span class="op">]</span>
<span class="va">DT</span><span class="op">[</span>, <span class="va">lag_PCGDP</span> <span class="op">:=</span> <span class="fu"><a href="../reference/fgrowth.html">fgrowth</a></span><span class="op">(</span><span class="va">PCGDP</span>, <span class="fl">1L</span>, <span class="fl">1L</span>, <span class="va">country</span>, <span class="va">year</span><span class="op">)</span><span class="op">]</span> <span class="co"># 1 lag, 1 iteration</span>

<span class="co"># Several Growth rates</span>
<span class="va">DT</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/data.table/man/setorder.html">order</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"growth_"</span>, <span class="fu"><a href="../reference/AA2-small-helpers.html">.c</a></span><span class="op">(</span><span class="va">PCGDP</span>, <span class="va">LIFEEX</span>, <span class="va">GINI</span>, <span class="va">ODA</span><span class="op">)</span><span class="op">)</span> <span class="op">:=</span> <span class="op">(</span><span class="va">.SD</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/pkg/data.table/man/shift.html">shift</a></span><span class="op">(</span><span class="va">.SD</span>, <span class="fl">1L</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span>, 
   by <span class="op">=</span> <span class="va">country</span>, .SDcols <span class="op">=</span> <span class="fl">9</span><span class="op">:</span><span class="fl">12</span><span class="op">]</span>

<span class="co"># Same thing using collapse</span>
<span class="va">DT</span> <span class="op">%&lt;&gt;%</span> <span class="fu"><a href="../reference/ftransform.html">tfm</a></span><span class="op">(</span><span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">gv</a></span><span class="op">(</span><span class="va">.</span>, <span class="fl">9</span><span class="op">:</span><span class="fl">12</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/fgrowth.html">fgrowth</a></span><span class="op">(</span><span class="fl">1L</span>, <span class="fl">1L</span>, <span class="va">country</span>, <span class="va">year</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/AA2-small-helpers.html">add_stub</a></span><span class="op">(</span><span class="st">"growth_"</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Or even simpler using settransform and the Growth operator</span>
<span class="fu"><a href="../reference/ftransform.html">settfmv</a></span><span class="op">(</span><span class="va">DT</span>, <span class="fl">9</span><span class="op">:</span><span class="fl">12</span>, <span class="va">G</span>, <span class="fl">1L</span>, <span class="fl">1L</span>, <span class="va">country</span>, <span class="va">year</span>, apply <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">DT</span><span class="op">)</span>
<span class="co">#        country iso3c       date year decade     region     income  OECD PCGDP LIFEEX GINI       ODA</span>
<span class="co"># 1: Afghanistan   AFG 1961-01-01 1960   1960 South Asia Low income FALSE    NA 32.292   NA 114440000</span>
<span class="co"># 2: Afghanistan   AFG 1962-01-01 1961   1960 South Asia Low income FALSE    NA 32.742   NA 233350000</span>
<span class="co"># 3: Afghanistan   AFG 1963-01-01 1962   1960 South Asia Low income FALSE    NA 33.185   NA 114880000</span>
<span class="co"># 4: Afghanistan   AFG 1964-01-01 1963   1960 South Asia Low income FALSE    NA 33.624   NA 236450000</span>
<span class="co"># 5: Afghanistan   AFG 1965-01-01 1964   1960 South Asia Low income FALSE    NA 34.060   NA 302480000</span>
<span class="co"># 6: Afghanistan   AFG 1966-01-01 1965   1960 South Asia Low income FALSE    NA 34.495   NA 370250000</span>
<span class="co">#        sum_ODA perc_c_ODA perc_y_ODA demean_PCGDP lag_PCGDP growth_PCGDP growth_LIFEEX growth_GINI</span>
<span class="co"># 1: 78362260000  0.1460397  0.4534359           NA        NA           NA            NA          NA</span>
<span class="co"># 2: 78362260000  0.2977837  0.7746781           NA        NA           NA      1.393534          NA</span>
<span class="co"># 3: 78362260000  0.1466012  0.3674502           NA        NA           NA      1.353002          NA</span>
<span class="co"># 4: 78362260000  0.3017396  0.6966903           NA        NA           NA      1.322887          NA</span>
<span class="co"># 5: 78362260000  0.3860021  0.8739274           NA        NA           NA      1.296693          NA</span>
<span class="co"># 6: 78362260000  0.4724851  0.9918527           NA        NA           NA      1.277158          NA</span>
<span class="co">#    growth_ODA G1.PCGDP G1.LIFEEX G1.GINI    G1.ODA</span>
<span class="co"># 1:         NA       NA        NA      NA        NA</span>
<span class="co"># 2:  103.90598       NA  1.393534      NA 103.90598</span>
<span class="co"># 3:  -50.76923       NA  1.353002      NA -50.76923</span>
<span class="co"># 4:  105.82347       NA  1.322887      NA 105.82347</span>
<span class="co"># 5:   27.92557       NA  1.296693      NA  27.92557</span>
<span class="co"># 6:   22.40479       NA  1.277158      NA  22.40479</span></pre></div>
<!--
# av(DT) <- DT %>% gby(country) %>% slt(year, 9:12) %>% 
#     fgrowth(1L, 1L, year, keep.ids = FALSE) %>% add_stub("growth_")
-->
<p>Since transformations (<code>:=</code> operations) are not highly optimized in <em>data.table</em>, <em>collapse</em> will be faster in most circumstances. <!-- even on very large data with a strong computer. --> Also time series functionality in <em>collapse</em> is significantly faster as it does not require data to be ordered or balanced to compute. For example <code>flag</code> computes an ordered lag without sorting the entire data first.</p>
<div class="sourceCode" id="cb14"><pre class="downlit">
<span class="co"># Lets generate a large dataset and benchmark this stuff</span>
<span class="va">DT_large</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">replicate</a></span><span class="op">(</span><span class="fl">1000</span>, <span class="fu"><a href="../reference/A4-quick-conversion.html">qDT</a></span><span class="op">(</span><span class="va">wlddev</span><span class="op">)</span>, simplify <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">tfm</span>, country <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">country</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="va">rbindlist</span>

<span class="co"># 12.7 million Obs</span>
<span class="fu"><a href="../reference/AA2-small-helpers.html">fdim</a></span><span class="op">(</span><span class="va">DT_large</span><span class="op">)</span>
<span class="co"># [1] 12744000       12</span>

<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>
  S1 <span class="op">=</span> <span class="va">DT_large</span><span class="op">[</span>, <span class="va">sum_ODA</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">ODA</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">country</span><span class="op">]</span>,
  S2 <span class="op">=</span> <span class="va">DT_large</span><span class="op">[</span>, <span class="va">sum_ODA</span> <span class="op">:=</span> <span class="fu"><a href="../reference/fsum.html">fsum</a></span><span class="op">(</span><span class="va">ODA</span>, <span class="va">country</span>, TRA <span class="op">=</span> <span class="st">"replace_fill"</span><span class="op">)</span><span class="op">]</span>,
  S3 <span class="op">=</span> <span class="fu"><a href="../reference/ftransform.html">settfm</a></span><span class="op">(</span><span class="va">DT_large</span>, sum_ODA <span class="op">=</span> <span class="fu"><a href="../reference/fsum.html">fsum</a></span><span class="op">(</span><span class="va">ODA</span>, <span class="va">country</span>, TRA <span class="op">=</span> <span class="st">"replace_fill"</span><span class="op">)</span><span class="op">)</span>,
  W1 <span class="op">=</span> <span class="va">DT_large</span><span class="op">[</span>, <span class="va">demean_PCGDP</span> <span class="op">:=</span> <span class="va">PCGDP</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">PCGDP</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">country</span><span class="op">]</span>,
  W2 <span class="op">=</span> <span class="va">DT_large</span><span class="op">[</span>, <span class="va">demean_PCGDP</span> <span class="op">:=</span> <span class="fu"><a href="../reference/fbetween,%20fwithin.html">fwithin</a></span><span class="op">(</span><span class="va">PCGDP</span>, <span class="va">country</span><span class="op">)</span><span class="op">]</span>,
  L1 <span class="op">=</span> <span class="va">DT_large</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/data.table/man/setorder.html">order</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span>, <span class="va">lag_PCGDP</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/pkg/data.table/man/shift.html">shift</a></span><span class="op">(</span><span class="va">PCGDP</span>, <span class="fl">1L</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">country</span><span class="op">]</span>,
  L2 <span class="op">=</span> <span class="va">DT_large</span><span class="op">[</span>, <span class="va">lag_PCGDP</span> <span class="op">:=</span> <span class="fu"><a href="../reference/flag.html">flag</a></span><span class="op">(</span><span class="va">PCGDP</span>, <span class="fl">1L</span>, <span class="va">country</span>, <span class="va">year</span><span class="op">)</span><span class="op">]</span>,
  L3 <span class="op">=</span> <span class="va">DT_large</span><span class="op">[</span>, <span class="va">lag_PCGDP</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/pkg/data.table/man/shift.html">shift</a></span><span class="op">(</span><span class="va">PCGDP</span>, <span class="fl">1L</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">country</span><span class="op">]</span>, <span class="co"># Not ordered</span>
  L4 <span class="op">=</span> <span class="va">DT_large</span><span class="op">[</span>, <span class="va">lag_PCGDP</span> <span class="op">:=</span> <span class="fu"><a href="../reference/flag.html">flag</a></span><span class="op">(</span><span class="va">PCGDP</span>, <span class="fl">1L</span>, <span class="va">country</span><span class="op">)</span><span class="op">]</span>, <span class="co"># Not ordered</span>
  times <span class="op">=</span> <span class="fl">5</span>
<span class="op">)</span>
<span class="co"># Unit: milliseconds</span>
<span class="co">#  expr       min        lq      mean    median        uq       max neval  cld</span>
<span class="co">#    S1  807.7054  819.1454  947.6065  956.3783 1043.0081 1111.7955     5 a   </span>
<span class="co">#    S2  779.1812  840.2400  873.2774  896.8988  916.9831  933.0842     5 a   </span>
<span class="co">#    S3  572.7164  637.6085  728.1451  704.9009  785.2180  940.2817     5 a   </span>
<span class="co">#    W1 2589.6564 2884.5239 3361.1192 3468.7727 3745.6822 4116.9608     5  b  </span>
<span class="co">#    W2  496.4106  551.9150  677.7814  685.2410  812.0648  843.2758     5 a   </span>
<span class="co">#    L1 7104.3043 8308.1849 8598.5633 8936.2521 8997.4613 9646.6138     5    d</span>
<span class="co">#    L2  893.7496  983.5089 1181.3931 1211.6698 1349.7212 1468.3157     5 a   </span>
<span class="co">#    L3 5594.4888 5962.2300 6529.3950 6323.2083 6801.5766 7965.4715     5   c </span>
<span class="co">#    L4  595.7107  625.7699  785.5333  686.1491  988.7791 1031.2575     5 a</span>

<span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">DT_large</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/gc.html">gc</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#            used  (Mb) gc trigger   (Mb)  max used   (Mb)</span>
<span class="co"># Ncells  2228832 119.1    4373105  233.6   4373105  233.6</span>
<span class="co"># Vcells 21788159 166.3  282271479 2153.6 352507146 2689.5</span></pre></div>
</div>
<div id="further-collapse-features-supporting-data-tables" class="section level2">
<h2 class="hasAnchor">
<a href="#further-collapse-features-supporting-data-tables" class="anchor"></a>Further <em>collapse</em> features supporting <em>data.table</em>’s</h2>
<p>As mentioned, <code>qDT</code> is a flexible and very fast function to create / column-wise convert R objects to <em>data.table</em>’s. You can also row-wise convert a matrix to data.table using <code>mrtl</code>:</p>
<div class="sourceCode" id="cb15"><pre class="downlit">
<span class="co"># Creating a matrix from mtcars</span>
<span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/A4-quick-conversion.html">qM</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span> 
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span>
<span class="co">#  num [1:32, 1:11] 21 21 22.8 21.4 18.7 18.1 14.3 24.4 22.8 19.2 ...</span>
<span class="co">#  - attr(*, "dimnames")=List of 2</span>
<span class="co">#   ..$ : chr [1:32] "Mazda RX4" "Mazda RX4 Wag" "Datsun 710" "Hornet 4 Drive" ...</span>
<span class="co">#   ..$ : chr [1:11] "mpg" "cyl" "disp" "hp" ...</span>

<span class="co"># Demonstrating another nice feature of qDT</span>
<span class="fu"><a href="../reference/A4-quick-conversion.html">qDT</a></span><span class="op">(</span><span class="va">m</span>, row.names.col <span class="op">=</span> <span class="st">"car"</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">head</span>
<span class="co">#                  car  mpg cyl disp  hp drat    wt  qsec vs am gear carb</span>
<span class="co"># 1:         Mazda RX4 21.0   6  160 110 3.90 2.620 16.46  0  1    4    4</span>
<span class="co"># 2:     Mazda RX4 Wag 21.0   6  160 110 3.90 2.875 17.02  0  1    4    4</span>
<span class="co"># 3:        Datsun 710 22.8   4  108  93 3.85 2.320 18.61  1  1    4    1</span>
<span class="co"># 4:    Hornet 4 Drive 21.4   6  258 110 3.08 3.215 19.44  1  0    3    1</span>
<span class="co"># 5: Hornet Sportabout 18.7   8  360 175 3.15 3.440 17.02  0  0    3    2</span>
<span class="co"># 6:           Valiant 18.1   6  225 105 2.76 3.460 20.22  1  0    3    1</span>

<span class="co"># Row-wise conversion to data.table</span>
<span class="fu"><a href="../reference/A4-quick-conversion.html">mrtl</a></span><span class="op">(</span><span class="va">m</span>, names <span class="op">=</span> <span class="cn">TRUE</span>, return <span class="op">=</span> <span class="st">"data.table"</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>
<span class="co">#    Mazda RX4 Mazda RX4 Wag Datsun 710 Hornet 4 Drive Hornet Sportabout Valiant Duster 360 Merc 240D</span>
<span class="co"># 1:        21            21       22.8           21.4              18.7    18.1       14.3      24.4</span>
<span class="co"># 2:         6             6        4.0            6.0               8.0     6.0        8.0       4.0</span>
<span class="co">#    Merc 230 Merc 280 Merc 280C Merc 450SE Merc 450SL Merc 450SLC Cadillac Fleetwood</span>
<span class="co"># 1:     22.8     19.2      17.8       16.4       17.3        15.2               10.4</span>
<span class="co"># 2:      4.0      6.0       6.0        8.0        8.0         8.0                8.0</span>
<span class="co">#    Lincoln Continental Chrysler Imperial Fiat 128 Honda Civic Toyota Corolla Toyota Corona</span>
<span class="co"># 1:                10.4              14.7     32.4        30.4           33.9          21.5</span>
<span class="co"># 2:                 8.0               8.0      4.0         4.0            4.0           4.0</span>
<span class="co">#    Dodge Challenger AMC Javelin Camaro Z28 Pontiac Firebird Fiat X1-9 Porsche 914-2 Lotus Europa</span>
<span class="co"># 1:             15.5        15.2       13.3             19.2      27.3            26         30.4</span>
<span class="co"># 2:              8.0         8.0        8.0              8.0       4.0             4          4.0</span>
<span class="co">#    Ford Pantera L Ferrari Dino Maserati Bora Volvo 142E</span>
<span class="co"># 1:           15.8         19.7            15       21.4</span>
<span class="co"># 2:            8.0          6.0             8        4.0</span></pre></div>
<p>The computational efficiency of these functions makes them very useful to use in <em>data.table</em> based workflows.</p>
<div class="sourceCode" id="cb16"><pre class="downlit">
<span class="co"># Benchmark</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="../reference/A4-quick-conversion.html">qDT</a></span><span class="op">(</span><span class="va">m</span>, <span class="st">"car"</span><span class="op">)</span>, <span class="fu"><a href="../reference/A4-quick-conversion.html">mrtl</a></span><span class="op">(</span><span class="va">m</span>, <span class="cn">TRUE</span>, <span class="st">"data.table"</span><span class="op">)</span><span class="op">)</span>
<span class="co"># Unit: microseconds</span>
<span class="co">#                         expr    min     lq     mean median     uq    max neval cld</span>
<span class="co">#                qDT(m, "car") 11.603 12.495 14.45871 12.942 13.834 52.658   100   b</span>
<span class="co">#  mrtl(m, TRUE, "data.table")  5.801  6.694  8.14874  7.140  8.033 40.162   100  a</span></pre></div>
<p>For example we could regress the growth rate of GDP per capita on the Growth rate of life expectancy in each country and save results in a <em>data.table</em>:</p>
<div class="sourceCode" id="cb17"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">lmtest</span><span class="op">)</span>

<span class="va">wlddev</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">fselect</a></span><span class="op">(</span><span class="va">country</span>, <span class="va">PCGDP</span>, <span class="va">LIFEEX</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="co"># This counts missing values on PCGDP and LIFEEX only</span>
  <span class="fu"><a href="../reference/AA2-small-helpers.html">na_omit</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="op">-</span><span class="fl">1L</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="co"># This removes countries with less than 20 observations</span>
  <span class="fu"><a href="../reference/fsubset.html">fsubset</a></span><span class="op">(</span><span class="fu"><a href="../reference/fNobs.html">fNobs</a></span><span class="op">(</span><span class="va">PCGDP</span>, <span class="va">country</span>, <span class="st">"replace_fill"</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">20L</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="va">qDT</span> <span class="op">%&gt;%</span> 
  <span class="co"># Run estimations by country using data.table</span>
  <span class="va">.</span><span class="op">[</span>, <span class="fu"><a href="../reference/A4-quick-conversion.html">qDT</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/lmtest/man/coeftest.html">coeftest</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="fu"><a href="../reference/fgrowth.html">G</a></span><span class="op">(</span><span class="va">PCGDP</span><span class="op">)</span> <span class="op">~</span> <span class="fu"><a href="../reference/fgrowth.html">G</a></span><span class="op">(</span><span class="va">LIFEEX</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, <span class="st">"Coef"</span><span class="op">)</span>, keyby <span class="op">=</span> <span class="va">country</span><span class="op">]</span> <span class="op">%&gt;%</span> <span class="va">head</span>
<span class="co">#    country        Coef   Estimate Std. Error    t value    Pr(&gt;|t|)</span>
<span class="co"># 1: Albania (Intercept) -4.5601369   2.642304 -1.7258186 0.093458980</span>
<span class="co"># 2: Albania   G(LIFEEX) 23.7190961   7.721912  3.0716609 0.004171056</span>
<span class="co"># 3: Algeria (Intercept)  0.7775839   1.873481  0.4150477 0.679751420</span>
<span class="co"># 4: Algeria   G(LIFEEX)  0.7589775   1.777133  0.4270798 0.671019328</span>
<span class="co"># 5:  Angola (Intercept) -4.0318568   1.867152 -2.1593617 0.037966192</span>
<span class="co"># 6:  Angola   G(LIFEEX)  4.0824305   1.321935  3.0882227 0.003994191</span></pre></div>
<p>If we only need the coefficients, not the standard errors, we can also use <code><a href="../reference/flm.html">collapse::flm</a></code> together with <code>mrtl</code>:</p>
<div class="sourceCode" id="cb18"><pre class="downlit">
<span class="va">wlddev</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">fselect</a></span><span class="op">(</span><span class="va">country</span>, <span class="va">PCGDP</span>, <span class="va">LIFEEX</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../reference/AA2-small-helpers.html">na_omit</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="op">-</span><span class="fl">1L</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../reference/fsubset.html">fsubset</a></span><span class="op">(</span><span class="fu"><a href="../reference/fNobs.html">fNobs</a></span><span class="op">(</span><span class="va">PCGDP</span>, <span class="va">country</span>, <span class="st">"replace_fill"</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">20L</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="va">qDT</span> <span class="op">%&gt;%</span> 
  <span class="va">.</span><span class="op">[</span>, <span class="fu"><a href="../reference/A4-quick-conversion.html">mrtl</a></span><span class="op">(</span><span class="fu"><a href="../reference/flm.html">flm</a></span><span class="op">(</span><span class="fu"><a href="../reference/fgrowth.html">fgrowth</a></span><span class="op">(</span><span class="va">PCGDP</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fl">1L</span><span class="op">]</span>, 
               <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span>Intercept <span class="op">=</span> <span class="fl">1</span>, 
                     LIFEEX <span class="op">=</span> <span class="fu"><a href="../reference/fgrowth.html">fgrowth</a></span><span class="op">(</span><span class="va">LIFEEX</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fl">1L</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>, <span class="cn">TRUE</span><span class="op">)</span>, 
    keyby <span class="op">=</span> <span class="va">country</span><span class="op">]</span> <span class="op">%&gt;%</span> <span class="va">head</span>
<span class="co">#                country  Intercept     LIFEEX</span>
<span class="co"># 1:             Albania -4.5601369 23.7190961</span>
<span class="co"># 2:             Algeria  0.7775839  0.7589775</span>
<span class="co"># 3:              Angola -4.0318568  4.0824305</span>
<span class="co"># 4: Antigua and Barbuda -8.2491200 38.0097698</span>
<span class="co"># 5:           Argentina  1.9612901 -2.5533460</span>
<span class="co"># 6:             Armenia -1.0018625 13.2867613</span></pre></div>
<p>… which provides a significant speed gain here:</p>
<div class="sourceCode" id="cb19"><pre class="downlit">

<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>
  
A <span class="op">=</span> <span class="va">wlddev</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">fselect</a></span><span class="op">(</span><span class="va">country</span>, <span class="va">PCGDP</span>, <span class="va">LIFEEX</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../reference/AA2-small-helpers.html">na_omit</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="op">-</span><span class="fl">1L</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../reference/fsubset.html">fsubset</a></span><span class="op">(</span><span class="fu"><a href="../reference/fNobs.html">fNobs</a></span><span class="op">(</span><span class="va">PCGDP</span>, <span class="va">country</span>, <span class="st">"replace_fill"</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">20L</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="va">qDT</span> <span class="op">%&gt;%</span> 
  <span class="va">.</span><span class="op">[</span>, <span class="fu"><a href="../reference/A4-quick-conversion.html">qDT</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/lmtest/man/coeftest.html">coeftest</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="fu"><a href="../reference/fgrowth.html">G</a></span><span class="op">(</span><span class="va">PCGDP</span><span class="op">)</span> <span class="op">~</span> <span class="fu"><a href="../reference/fgrowth.html">G</a></span><span class="op">(</span><span class="va">LIFEEX</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, <span class="st">"Coef"</span><span class="op">)</span>, keyby <span class="op">=</span> <span class="va">country</span><span class="op">]</span>,

B <span class="op">=</span> <span class="va">wlddev</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">fselect</a></span><span class="op">(</span><span class="va">country</span>, <span class="va">PCGDP</span>, <span class="va">LIFEEX</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../reference/AA2-small-helpers.html">na_omit</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="op">-</span><span class="fl">1L</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../reference/fsubset.html">fsubset</a></span><span class="op">(</span><span class="fu"><a href="../reference/fNobs.html">fNobs</a></span><span class="op">(</span><span class="va">PCGDP</span>, <span class="va">country</span>, <span class="st">"replace_fill"</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">20L</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="va">qDT</span> <span class="op">%&gt;%</span> 
  <span class="va">.</span><span class="op">[</span>, <span class="fu"><a href="../reference/A4-quick-conversion.html">mrtl</a></span><span class="op">(</span><span class="fu"><a href="../reference/flm.html">flm</a></span><span class="op">(</span><span class="fu"><a href="../reference/fgrowth.html">fgrowth</a></span><span class="op">(</span><span class="va">PCGDP</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fl">1L</span><span class="op">]</span>, 
               <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span>Intercept <span class="op">=</span> <span class="fl">1</span>, 
                     LIFEEX <span class="op">=</span> <span class="fu"><a href="../reference/fgrowth.html">fgrowth</a></span><span class="op">(</span><span class="va">LIFEEX</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fl">1L</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>, <span class="cn">TRUE</span><span class="op">)</span>, 
    keyby <span class="op">=</span> <span class="va">country</span><span class="op">]</span>
<span class="op">)</span>
<span class="co"># Unit: milliseconds</span>
<span class="co">#  expr       min        lq      mean    median        uq       max neval cld</span>
<span class="co">#     A 257.92972 306.74727 367.57479 357.35540 419.40064 561.11080   100   b</span>
<span class="co">#     B  10.30923  11.89006  15.07969  13.48027  16.54019  31.82107   100  a</span></pre></div>
<p>Another feature to highlight at this point are <em>collapse</em>’s list processing functions, in particular <code>rsplit</code>, <code>rapply2d</code>, <code>get_elem</code> and <code>unlist2d</code>. <code>rsplit</code> is an efficient recursive generalization of <code>split</code>:</p>
<div class="sourceCode" id="cb20"><pre class="downlit">
<span class="va">DT_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rsplit.html">rsplit</a></span><span class="op">(</span><span class="va">DT</span>, <span class="va">country</span> <span class="op">+</span> <span class="va">year</span> <span class="op">+</span> <span class="va">PCGDP</span> <span class="op">+</span> <span class="va">LIFEEX</span> <span class="op">~</span> <span class="va">region</span> <span class="op">+</span> <span class="va">income</span><span class="op">)</span> 

<span class="co"># Note: rsplit(DT, year + PCGDP + LIFEEX ~ region + income, flatten = TRUE) </span>
<span class="co"># would yield a simple list with interacted categories (like split) </span>

<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">DT_list</span>, give.attr <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="co"># List of 7</span>
<span class="co">#  $ East Asia &amp; Pacific       :List of 3</span>
<span class="co">#   ..$ High income        :Classes 'data.table' and 'data.frame':  767 obs. of  4 variables:</span>
<span class="co">#   .. ..$ country: chr [1:767] "Australia" "Australia" "Australia" "Australia" ...</span>
<span class="co">#   .. ..$ year   : int [1:767] 1960 1961 1962 1963 1964 1965 1966 1967 1968 1969 ...</span>
<span class="co">#   .. ..$ PCGDP  : num [1:767] 19387 19478 19255 20063 21046 ...</span>
<span class="co">#   .. ..$ LIFEEX : num [1:767] 70.8 71 70.9 70.9 70.9 ...</span>
<span class="co">#   ..$ Lower middle income:Classes 'data.table' and 'data.frame':  767 obs. of  4 variables:</span>
<span class="co">#   .. ..$ country: chr [1:767] "Cambodia" "Cambodia" "Cambodia" "Cambodia" ...</span>
<span class="co">#   .. ..$ year   : int [1:767] 1960 1961 1962 1963 1964 1965 1966 1967 1968 1969 ...</span>
<span class="co">#   .. ..$ PCGDP  : num [1:767] NA NA NA NA NA NA NA NA NA NA ...</span>
<span class="co">#   .. ..$ LIFEEX : num [1:767] 41.2 41.4 41.5 41.7 41.9 ...</span>
<span class="co">#   ..$ Upper middle income:Classes 'data.table' and 'data.frame':  590 obs. of  4 variables:</span>
<span class="co">#   .. ..$ country: chr [1:590] "American Samoa" "American Samoa" "American Samoa" "American Samoa" ...</span>
<span class="co">#   .. ..$ year   : int [1:590] 1960 1961 1962 1963 1964 1965 1966 1967 1968 1969 ...</span>
<span class="co">#   .. ..$ PCGDP  : num [1:590] NA NA NA NA NA NA NA NA NA NA ...</span>
<span class="co">#   .. ..$ LIFEEX : num [1:590] NA NA NA NA NA NA NA NA NA NA ...</span>
<span class="co">#  $ Europe &amp; Central Asia     :List of 4</span>
<span class="co">#   ..$ High income        :Classes 'data.table' and 'data.frame':  2183 obs. of  4 variables:</span>
<span class="co">#   .. ..$ country: chr [1:2183] "Andorra" "Andorra" "Andorra" "Andorra" ...</span>
<span class="co">#   .. ..$ year   : int [1:2183] 1960 1961 1962 1963 1964 1965 1966 1967 1968 1969 ...</span>
<span class="co">#   .. ..$ PCGDP  : num [1:2183] NA NA NA NA NA NA NA NA NA NA ...</span>
<span class="co">#   .. ..$ LIFEEX : num [1:2183] NA NA NA NA NA NA NA NA NA NA ...</span>
<span class="co">#   ..$ Low income         :Classes 'data.table' and 'data.frame':  59 obs. of  4 variables:</span>
<span class="co">#   .. ..$ country: chr [1:59] "Tajikistan" "Tajikistan" "Tajikistan" "Tajikistan" ...</span>
<span class="co">#   .. ..$ year   : int [1:59] 1960 1961 1962 1963 1964 1965 1966 1967 1968 1969 ...</span>
<span class="co">#   .. ..$ PCGDP  : num [1:59] NA NA NA NA NA NA NA NA NA NA ...</span>
<span class="co">#   .. ..$ LIFEEX : num [1:59] 56.2 56.6 57 57.4 57.8 ...</span>
<span class="co">#   ..$ Lower middle income:Classes 'data.table' and 'data.frame':  354 obs. of  4 variables:</span>
<span class="co">#   .. ..$ country: chr [1:354] "Georgia" "Georgia" "Georgia" "Georgia" ...</span>
<span class="co">#   .. ..$ year   : int [1:354] 1960 1961 1962 1963 1964 1965 1966 1967 1968 1969 ...</span>
<span class="co">#   .. ..$ PCGDP  : num [1:354] NA NA NA NA NA ...</span>
<span class="co">#   .. ..$ LIFEEX : num [1:354] 63.7 64.1 64.5 64.9 65.3 ...</span>
<span class="co">#   ..$ Upper middle income:Classes 'data.table' and 'data.frame':  826 obs. of  4 variables:</span>
<span class="co">#   .. ..$ country: chr [1:826] "Albania" "Albania" "Albania" "Albania" ...</span>
<span class="co">#   .. ..$ year   : int [1:826] 1960 1961 1962 1963 1964 1965 1966 1967 1968 1969 ...</span>
<span class="co">#   .. ..$ PCGDP  : num [1:826] NA NA NA NA NA NA NA NA NA NA ...</span>
<span class="co">#   .. ..$ LIFEEX : num [1:826] 62.3 63.3 64.2 64.9 65.5 ...</span>
<span class="co">#  $ Latin America &amp; Caribbean :List of 4</span>
<span class="co">#   ..$ High income        :Classes 'data.table' and 'data.frame':  1062 obs. of  4 variables:</span>
<span class="co">#   .. ..$ country: chr [1:1062] "Antigua and Barbuda" "Antigua and Barbuda" "Antigua and Barbuda" "Antigua and Barbuda" ...</span>
<span class="co">#   .. ..$ year   : int [1:1062] 1960 1961 1962 1963 1964 1965 1966 1967 1968 1969 ...</span>
<span class="co">#   .. ..$ PCGDP  : num [1:1062] NA NA NA NA NA NA NA NA NA NA ...</span>
<span class="co">#   .. ..$ LIFEEX : num [1:1062] 62.1 62.6 63 63.4 63.8 ...</span>
<span class="co">#   ..$ Low income         :Classes 'data.table' and 'data.frame':  59 obs. of  4 variables:</span>
<span class="co">#   .. ..$ country: chr [1:59] "Haiti" "Haiti" "Haiti" "Haiti" ...</span>
<span class="co">#   .. ..$ year   : int [1:59] 1960 1961 1962 1963 1964 1965 1966 1967 1968 1969 ...</span>
<span class="co">#   .. ..$ PCGDP  : num [1:59] 1018 969 1025 986 950 ...</span>
<span class="co">#   .. ..$ LIFEEX : num [1:59] 42.1 42.7 43.3 43.8 44.4 ...</span>
<span class="co">#   ..$ Lower middle income:Classes 'data.table' and 'data.frame':  236 obs. of  4 variables:</span>
<span class="co">#   .. ..$ country: chr [1:236] "Bolivia" "Bolivia" "Bolivia" "Bolivia" ...</span>
<span class="co">#   .. ..$ year   : int [1:236] 1960 1961 1962 1963 1964 1965 1966 1967 1968 1969 ...</span>
<span class="co">#   .. ..$ PCGDP  : num [1:236] 995 997 1033 1082 1102 ...</span>
<span class="co">#   .. ..$ LIFEEX : num [1:236] 42.1 42.5 42.8 43.1 43.5 ...</span>
<span class="co">#   ..$ Upper middle income:Classes 'data.table' and 'data.frame':  1121 obs. of  4 variables:</span>
<span class="co">#   .. ..$ country: chr [1:1121] "Belize" "Belize" "Belize" "Belize" ...</span>
<span class="co">#   .. ..$ year   : int [1:1121] 1960 1961 1962 1963 1964 1965 1966 1967 1968 1969 ...</span>
<span class="co">#   .. ..$ PCGDP  : num [1:1121] 1072 1093 1115 1138 1161 ...</span>
<span class="co">#   .. ..$ LIFEEX : num [1:1121] 60 60.5 61.1 61.7 62.2 ...</span>
<span class="co">#  $ Middle East &amp; North Africa:List of 4</span>
<span class="co">#   ..$ High income        :Classes 'data.table' and 'data.frame':  472 obs. of  4 variables:</span>
<span class="co">#   .. ..$ country: chr [1:472] "Bahrain" "Bahrain" "Bahrain" "Bahrain" ...</span>
<span class="co">#   .. ..$ year   : int [1:472] 1960 1961 1962 1963 1964 1965 1966 1967 1968 1969 ...</span>
<span class="co">#   .. ..$ PCGDP  : num [1:472] NA NA NA NA NA NA NA NA NA NA ...</span>
<span class="co">#   .. ..$ LIFEEX : num [1:472] 51.9 53.2 54.6 55.9 57.2 ...</span>
<span class="co">#   ..$ Low income         :Classes 'data.table' and 'data.frame':  118 obs. of  4 variables:</span>
<span class="co">#   .. ..$ country: chr [1:118] "Syrian Arab Republic" "Syrian Arab Republic" "Syrian Arab Republic" "Syrian Arab Republic" ...</span>
<span class="co">#   .. ..$ year   : int [1:118] 1960 1961 1962 1963 1964 1965 1966 1967 1968 1969 ...</span>
<span class="co">#   .. ..$ PCGDP  : num [1:118] NA NA NA NA NA NA NA NA NA NA ...</span>
<span class="co">#   .. ..$ LIFEEX : num [1:118] 52 52.6 53.2 53.8 54.4 ...</span>
<span class="co">#   ..$ Lower middle income:Classes 'data.table' and 'data.frame':  295 obs. of  4 variables:</span>
<span class="co">#   .. ..$ country: chr [1:295] "Djibouti" "Djibouti" "Djibouti" "Djibouti" ...</span>
<span class="co">#   .. ..$ year   : int [1:295] 1960 1961 1962 1963 1964 1965 1966 1967 1968 1969 ...</span>
<span class="co">#   .. ..$ PCGDP  : num [1:295] NA NA NA NA NA NA NA NA NA NA ...</span>
<span class="co">#   .. ..$ LIFEEX : num [1:295] 44 44.5 44.9 45.3 45.7 ...</span>
<span class="co">#   ..$ Upper middle income:Classes 'data.table' and 'data.frame':  354 obs. of  4 variables:</span>
<span class="co">#   .. ..$ country: chr [1:354] "Algeria" "Algeria" "Algeria" "Algeria" ...</span>
<span class="co">#   .. ..$ year   : int [1:354] 1960 1961 1962 1963 1964 1965 1966 1967 1968 1969 ...</span>
<span class="co">#   .. ..$ PCGDP  : num [1:354] 2466 2078 1628 2133 2201 ...</span>
<span class="co">#   .. ..$ LIFEEX : num [1:354] 46.1 46.6 47.1 47.5 48 ...</span>
<span class="co">#  $ North America             :List of 1</span>
<span class="co">#   ..$ High income:Classes 'data.table' and 'data.frame':  177 obs. of  4 variables:</span>
<span class="co">#   .. ..$ country: chr [1:177] "Bermuda" "Bermuda" "Bermuda" "Bermuda" ...</span>
<span class="co">#   .. ..$ year   : int [1:177] 1960 1961 1962 1963 1964 1965 1966 1967 1968 1969 ...</span>
<span class="co">#   .. ..$ PCGDP  : num [1:177] 27838 28437 29007 28641 31042 ...</span>
<span class="co">#   .. ..$ LIFEEX : num [1:177] NA NA NA NA NA ...</span>
<span class="co">#  $ South Asia                :List of 3</span>
<span class="co">#   ..$ Low income         :Classes 'data.table' and 'data.frame':  118 obs. of  4 variables:</span>
<span class="co">#   .. ..$ country: chr [1:118] "Afghanistan" "Afghanistan" "Afghanistan" "Afghanistan" ...</span>
<span class="co">#   .. ..$ year   : int [1:118] 1960 1961 1962 1963 1964 1965 1966 1967 1968 1969 ...</span>
<span class="co">#   .. ..$ PCGDP  : num [1:118] NA NA NA NA NA NA NA NA NA NA ...</span>
<span class="co">#   .. ..$ LIFEEX : num [1:118] 32.3 32.7 33.2 33.6 34.1 ...</span>
<span class="co">#   ..$ Lower middle income:Classes 'data.table' and 'data.frame':  295 obs. of  4 variables:</span>
<span class="co">#   .. ..$ country: chr [1:295] "Bangladesh" "Bangladesh" "Bangladesh" "Bangladesh" ...</span>
<span class="co">#   .. ..$ year   : int [1:295] 1960 1961 1962 1963 1964 1965 1966 1967 1968 1969 ...</span>
<span class="co">#   .. ..$ PCGDP  : num [1:295] 371 382 391 379 408 ...</span>
<span class="co">#   .. ..$ LIFEEX : num [1:295] 45.8 46.5 47.1 47.7 48.3 ...</span>
<span class="co">#   ..$ Upper middle income:Classes 'data.table' and 'data.frame':  59 obs. of  4 variables:</span>
<span class="co">#   .. ..$ country: chr [1:59] "Maldives" "Maldives" "Maldives" "Maldives" ...</span>
<span class="co">#   .. ..$ year   : int [1:59] 1960 1961 1962 1963 1964 1965 1966 1967 1968 1969 ...</span>
<span class="co">#   .. ..$ PCGDP  : num [1:59] NA NA NA NA NA NA NA NA NA NA ...</span>
<span class="co">#   .. ..$ LIFEEX : num [1:59] 37.4 38 38.6 39.3 40 ...</span>
<span class="co">#  $ Sub-Saharan Africa        :List of 4</span>
<span class="co">#   ..$ High income        :Classes 'data.table' and 'data.frame':  59 obs. of  4 variables:</span>
<span class="co">#   .. ..$ country: chr [1:59] "Seychelles" "Seychelles" "Seychelles" "Seychelles" ...</span>
<span class="co">#   .. ..$ year   : int [1:59] 1960 1961 1962 1963 1964 1965 1966 1967 1968 1969 ...</span>
<span class="co">#   .. ..$ PCGDP  : num [1:59] 2830 2617 2763 2966 3064 ...</span>
<span class="co">#   .. ..$ LIFEEX : num [1:59] NA NA NA NA NA NA NA NA NA NA ...</span>
<span class="co">#   ..$ Low income         :Classes 'data.table' and 'data.frame':  1593 obs. of  4 variables:</span>
<span class="co">#   .. ..$ country: chr [1:1593] "Benin" "Benin" "Benin" "Benin" ...</span>
<span class="co">#   .. ..$ year   : int [1:1593] 1960 1961 1962 1963 1964 1965 1966 1967 1968 1969 ...</span>
<span class="co">#   .. ..$ PCGDP  : num [1:1593] 520 529 504 519 544 ...</span>
<span class="co">#   .. ..$ LIFEEX : num [1:1593] 37.3 37.7 38.2 38.7 39.1 ...</span>
<span class="co">#   ..$ Lower middle income:Classes 'data.table' and 'data.frame':  826 obs. of  4 variables:</span>
<span class="co">#   .. ..$ country: chr [1:826] "Angola" "Angola" "Angola" "Angola" ...</span>
<span class="co">#   .. ..$ year   : int [1:826] 1960 1961 1962 1963 1964 1965 1966 1967 1968 1969 ...</span>
<span class="co">#   .. ..$ PCGDP  : num [1:826] NA NA NA NA NA NA NA NA NA NA ...</span>
<span class="co">#   .. ..$ LIFEEX : num [1:826] 33.3 33.6 33.9 34.3 34.6 ...</span>
<span class="co">#   ..$ Upper middle income:Classes 'data.table' and 'data.frame':  354 obs. of  4 variables:</span>
<span class="co">#   .. ..$ country: chr [1:354] "Botswana" "Botswana" "Botswana" "Botswana" ...</span>
<span class="co">#   .. ..$ year   : int [1:354] 1960 1961 1962 1963 1964 1965 1966 1967 1968 1969 ...</span>
<span class="co">#   .. ..$ PCGDP  : num [1:354] 391 406 422 436 453 ...</span>
<span class="co">#   .. ..$ LIFEEX : num [1:354] 50.7 51 51.4 51.7 52.1 ...</span></pre></div>
<p>We can use <code>rapply2d</code> to apply a function to each data frame / data.table in an arbitrary nested structure:</p>
<div class="sourceCode" id="cb21"><pre class="downlit">
<span class="co"># This runs region-income level regressions, with country fixed effects</span>
<span class="co"># following Mundlak (1978)</span>
<span class="va">lm_summary_list</span> <span class="op">&lt;-</span> <span class="va">DT_list</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../reference/rapply2d.html">rapply2d</a></span><span class="op">(</span><span class="va">lm</span>, formula <span class="op">=</span> <span class="fu"><a href="../reference/fgrowth.html">G</a></span><span class="op">(</span><span class="va">PCGDP</span><span class="op">)</span> <span class="op">~</span> <span class="fu"><a href="../reference/fgrowth.html">G</a></span><span class="op">(</span><span class="va">LIFEEX</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="../reference/fbetween,%20fwithin.html">B</a></span><span class="op">(</span><span class="fu"><a href="../reference/fgrowth.html">G</a></span><span class="op">(</span><span class="va">LIFEEX</span><span class="op">)</span>, <span class="va">country</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="co"># Summarizing the results</span>
  <span class="fu"><a href="../reference/rapply2d.html">rapply2d</a></span><span class="op">(</span><span class="va">summary</span>, classes <span class="op">=</span> <span class="st">"lm"</span><span class="op">)</span>

<span class="co"># This is a nested list of linear model summaries</span>
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">lm_summary_list</span>, give.attr <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="co"># List of 7</span>
<span class="co">#  $ East Asia &amp; Pacific       :List of 3</span>
<span class="co">#   ..$ High income        :List of 12</span>
<span class="co">#   .. ..$ call         : language FUN(formula = ..1, data = y)</span>
<span class="co">#   .. ..$ terms        :Classes 'terms', 'formula'  language G(PCGDP) ~ G(LIFEEX) + B(G(LIFEEX), country)</span>
<span class="co">#   .. ..$ residuals    : Named num [1:415] -1.39 -2.64 2.7 3.41 2.43 ...</span>
<span class="co">#   .. ..$ coefficients : num [1:3, 1:4] -0.47 1.381 7.4 0.649 0.724 ...</span>
<span class="co">#   .. ..$ aliased      : Named logi [1:3] FALSE FALSE FALSE</span>
<span class="co">#   .. ..$ sigma        : num 4.6</span>
<span class="co">#   .. ..$ df           : int [1:3] 3 412 3</span>
<span class="co">#   .. ..$ r.squared    : num 0.0897</span>
<span class="co">#   .. ..$ adj.r.squared: num 0.0853</span>
<span class="co">#   .. ..$ fstatistic   : Named num [1:3] 20.3 2 412</span>
<span class="co">#   .. ..$ cov.unscaled : num [1:3, 1:3] 2.00e-02 -4.68e-05 -4.13e-02 -4.68e-05 2.48e-02 ...</span>
<span class="co">#   .. ..$ na.action    : 'omit' Named int [1:352] 1 58 59 60 61 62 63 64 65 66 ...</span>
<span class="co">#   ..$ Lower middle income:List of 12</span>
<span class="co">#   .. ..$ call         : language FUN(formula = ..1, data = y)</span>
<span class="co">#   .. ..$ terms        :Classes 'terms', 'formula'  language G(PCGDP) ~ G(LIFEEX) + B(G(LIFEEX), country)</span>
<span class="co">#   .. ..$ residuals    : Named num [1:501] -40.7 2.61 -1.21 -3 -2.29 ...</span>
<span class="co">#   .. ..$ coefficients : num [1:3, 1:4] 0.187 0.91 2.619 0.89 0.888 ...</span>
<span class="co">#   .. ..$ aliased      : Named logi [1:3] FALSE FALSE FALSE</span>
<span class="co">#   .. ..$ sigma        : num 6.6</span>
<span class="co">#   .. ..$ df           : int [1:3] 3 498 3</span>
<span class="co">#   .. ..$ r.squared    : num 0.0167</span>
<span class="co">#   .. ..$ adj.r.squared: num 0.0128</span>
<span class="co">#   .. ..$ fstatistic   : Named num [1:3] 4.24 2 498</span>
<span class="co">#   .. ..$ cov.unscaled : num [1:3, 1:3] 0.018183 -0.000238 -0.024148 -0.000238 0.018093 ...</span>
<span class="co">#   .. ..$ na.action    : 'omit' Named int [1:266] 1 2 3 4 5 6 7 8 9 10 ...</span>
<span class="co">#   ..$ Upper middle income:List of 12</span>
<span class="co">#   .. ..$ call         : language FUN(formula = ..1, data = y)</span>
<span class="co">#   .. ..$ terms        :Classes 'terms', 'formula'  language G(PCGDP) ~ G(LIFEEX) + B(G(LIFEEX), country)</span>
<span class="co">#   .. ..$ residuals    : Named num [1:294] -31.49 -10.87 3.58 11.85 10.86 ...</span>
<span class="co">#   .. ..$ coefficients : num [1:3, 1:4] 1.898 -0.481 3.404 0.536 0.501 ...</span>
<span class="co">#   .. ..$ aliased      : Named logi [1:3] FALSE FALSE FALSE</span>
<span class="co">#   .. ..$ sigma        : num 4.6</span>
<span class="co">#   .. ..$ df           : int [1:3] 3 291 3</span>
<span class="co">#   .. ..$ r.squared    : num 0.0452</span>
<span class="co">#   .. ..$ adj.r.squared: num 0.0386</span>
<span class="co">#   .. ..$ fstatistic   : Named num [1:3] 6.89 2 291</span>
<span class="co">#   .. ..$ cov.unscaled : num [1:3, 1:3] 0.013585 0.000335 -0.018191 0.000335 0.011841 ...</span>
<span class="co">#   .. ..$ na.action    : 'omit' Named int [1:296] 1 2 3 4 5 6 7 8 9 10 ...</span>
<span class="co">#  $ Europe &amp; Central Asia     :List of 4</span>
<span class="co">#   ..$ High income        :List of 12</span>
<span class="co">#   .. ..$ call         : language FUN(formula = ..1, data = y)</span>
<span class="co">#   .. ..$ terms        :Classes 'terms', 'formula'  language G(PCGDP) ~ G(LIFEEX) + B(G(LIFEEX), country)</span>
<span class="co">#   .. ..$ residuals    : Named num [1:1214] 2.698 -0.596 0.966 3.01 0.211 ...</span>
<span class="co">#   .. ..$ coefficients : num [1:3, 1:4] 3.199 -0.194 -2.218 0.38 0.251 ...</span>
<span class="co">#   .. ..$ aliased      : Named logi [1:3] FALSE FALSE FALSE</span>
<span class="co">#   .. ..$ sigma        : num 3.31</span>
<span class="co">#   .. ..$ df           : int [1:3] 3 1211 3</span>
<span class="co">#   .. ..$ r.squared    : num 0.00287</span>
<span class="co">#   .. ..$ adj.r.squared: num 0.00122</span>
<span class="co">#   .. ..$ fstatistic   : Named num [1:3] 1.74 2 1211</span>
<span class="co">#   .. ..$ cov.unscaled : num [1:3, 1:3] 0.01318 -0.00103 -0.04478 -0.00103 0.00577 ...</span>
<span class="co">#   .. ..$ na.action    : 'omit' Named int [1:969] 1 2 3 4 5 6 7 8 9 10 ...</span>
<span class="co">#   ..$ Low income         :List of 12</span>
<span class="co">#   .. ..$ call         : language FUN(formula = ..1, data = y)</span>
<span class="co">#   .. ..$ terms        :Classes 'terms', 'formula'  language G(PCGDP) ~ G(LIFEEX) + B(G(LIFEEX), country)</span>
<span class="co">#   .. ..$ residuals    : Named num [1:31] 3.345 1.032 17.941 0.176 6.946 ...</span>
<span class="co">#   .. ..$ coefficients : num [1:2, 1:4] -4.53 11.48 2.27 4.42 -2 ...</span>
<span class="co">#   .. ..$ aliased      : Named logi [1:3] FALSE FALSE TRUE</span>
<span class="co">#   .. ..$ sigma        : num 9.37</span>
<span class="co">#   .. ..$ df           : int [1:3] 2 29 3</span>
<span class="co">#   .. ..$ r.squared    : num 0.189</span>
<span class="co">#   .. ..$ adj.r.squared: num 0.161</span>
<span class="co">#   .. ..$ fstatistic   : Named num [1:3] 6.75 1 29</span>
<span class="co">#   .. ..$ cov.unscaled : num [1:2, 1:2] 0.0587 -0.0768 -0.0768 0.2224</span>
<span class="co">#   .. ..$ na.action    : 'omit' Named int [1:28] 1 2 3 4 5 6 7 8 9 10 ...</span>
<span class="co">#   ..$ Lower middle income:List of 12</span>
<span class="co">#   .. ..$ call         : language FUN(formula = ..1, data = y)</span>
<span class="co">#   .. ..$ terms        :Classes 'terms', 'formula'  language G(PCGDP) ~ G(LIFEEX) + B(G(LIFEEX), country)</span>
<span class="co">#   .. ..$ residuals    : Named num [1:176] 2.44723 1.5123 -0.00885 0.45619 7.76215 ...</span>
<span class="co">#   .. ..$ coefficients : num [1:3, 1:4] 0.433 5.375 0.995 1.605 1.166 ...</span>
<span class="co">#   .. ..$ aliased      : Named logi [1:3] FALSE FALSE FALSE</span>
<span class="co">#   .. ..$ sigma        : num 7.69</span>
<span class="co">#   .. ..$ df           : int [1:3] 3 173 3</span>
<span class="co">#   .. ..$ r.squared    : num 0.112</span>
<span class="co">#   .. ..$ adj.r.squared: num 0.102</span>
<span class="co">#   .. ..$ fstatistic   : Named num [1:3] 10.9 2 173</span>
<span class="co">#   .. ..$ cov.unscaled : num [1:3, 1:3] 0.04353 -0.00139 -0.1401 -0.00139 0.02298 ...</span>
<span class="co">#   .. ..$ na.action    : 'omit' Named int [1:178] 1 2 3 4 5 6 58 59 60 61 ...</span>
<span class="co">#   ..$ Upper middle income:List of 12</span>
<span class="co">#   .. ..$ call         : language FUN(formula = ..1, data = y)</span>
<span class="co">#   .. ..$ terms        :Classes 'terms', 'formula'  language G(PCGDP) ~ G(LIFEEX) + B(G(LIFEEX), country)</span>
<span class="co">#   .. ..$ residuals    : Named num [1:397] 0.812 -2.093 -4.025 -6.405 -3.361 ...</span>
<span class="co">#   .. ..$ coefficients : num [1:3, 1:4] 2.907 3.942 -3.026 0.803 0.854 ...</span>
<span class="co">#   .. ..$ aliased      : Named logi [1:3] FALSE FALSE FALSE</span>
<span class="co">#   .. ..$ sigma        : num 8.51</span>
<span class="co">#   .. ..$ df           : int [1:3] 3 394 3</span>
<span class="co">#   .. ..$ r.squared    : num 0.0517</span>
<span class="co">#   .. ..$ adj.r.squared: num 0.0469</span>
<span class="co">#   .. ..$ fstatistic   : Named num [1:3] 10.7 2 394</span>
<span class="co">#   .. ..$ cov.unscaled : num [1:3, 1:3] 0.008913 0.000103 -0.01683 0.000103 0.010069 ...</span>
<span class="co">#   .. ..$ na.action    : 'omit' Named int [1:429] 1 2 3 4 5 6 7 8 9 10 ...</span>
<span class="co">#  $ Latin America &amp; Caribbean :List of 4</span>
<span class="co">#   ..$ High income        :List of 12</span>
<span class="co">#   .. ..$ call         : language FUN(formula = ..1, data = y)</span>
<span class="co">#   .. ..$ terms        :Classes 'terms', 'formula'  language G(PCGDP) ~ G(LIFEEX) + B(G(LIFEEX), country)</span>
<span class="co">#   .. ..$ residuals    : Named num [1:517] 1.72 5.75 6.26 2.32 -1.26 ...</span>
<span class="co">#   .. ..$ coefficients : num [1:3, 1:4] 1.182 0.107 2.167 0.701 0.962 ...</span>
<span class="co">#   .. ..$ aliased      : Named logi [1:3] FALSE FALSE FALSE</span>
<span class="co">#   .. ..$ sigma        : num 4.89</span>
<span class="co">#   .. ..$ df           : int [1:3] 3 514 3</span>
<span class="co">#   .. ..$ r.squared    : num 0.00265</span>
<span class="co">#   .. ..$ adj.r.squared: num -0.00123</span>
<span class="co">#   .. ..$ fstatistic   : Named num [1:3] 0.684 2 514</span>
<span class="co">#   .. ..$ cov.unscaled : num [1:3, 1:3] 0.0206 0.00126 -0.05589 0.00126 0.03875 ...</span>
<span class="co">#   .. ..$ na.action    : 'omit' Named int [1:545] 1 2 3 4 5 6 7 8 9 10 ...</span>
<span class="co">#   ..$ Low income         :List of 12</span>
<span class="co">#   .. ..$ call         : language FUN(formula = ..1, data = y)</span>
<span class="co">#   .. ..$ terms        :Classes 'terms', 'formula'  language G(PCGDP) ~ G(LIFEEX) + B(G(LIFEEX), country)</span>
<span class="co">#   .. ..$ residuals    : Named num [1:56] -3.84 6.73 -2.89 -2.68 1.01 ...</span>
<span class="co">#   .. ..$ coefficients : num [1:2, 1:4] 0.01235 -0.72315 1.7478 2.27714 0.00706 ...</span>
<span class="co">#   .. ..$ aliased      : Named logi [1:3] FALSE FALSE TRUE</span>
<span class="co">#   .. ..$ sigma        : num 3.96</span>
<span class="co">#   .. ..$ df           : int [1:3] 2 54 3</span>
<span class="co">#   .. ..$ r.squared    : num 0.00186</span>
<span class="co">#   .. ..$ adj.r.squared: num -0.0166</span>
<span class="co">#   .. ..$ fstatistic   : Named num [1:3] 0.101 1 54</span>
<span class="co">#   .. ..$ cov.unscaled : num [1:2, 1:2] 0.195 -0.242 -0.242 0.331</span>
<span class="co">#   .. ..$ na.action    : 'omit' Named int [1:3] 1 58 59</span>
<span class="co">#   ..$ Lower middle income:List of 12</span>
<span class="co">#   .. ..$ call         : language FUN(formula = ..1, data = y)</span>
<span class="co">#   .. ..$ terms        :Classes 'terms', 'formula'  language G(PCGDP) ~ G(LIFEEX) + B(G(LIFEEX), country)</span>
<span class="co">#   .. ..$ residuals    : Named num [1:219] -1.198 2.214 3.396 0.596 1.518 ...</span>
<span class="co">#   .. ..$ coefficients : num [1:3, 1:4] -1.6 -0.227 3.517 3.113 0.768 ...</span>
<span class="co">#   .. ..$ aliased      : Named logi [1:3] FALSE FALSE FALSE</span>
<span class="co">#   .. ..$ sigma        : num 4.03</span>
<span class="co">#   .. ..$ df           : int [1:3] 3 216 3</span>
<span class="co">#   .. ..$ r.squared    : num 0.00377</span>
<span class="co">#   .. ..$ adj.r.squared: num -0.00546</span>
<span class="co">#   .. ..$ fstatistic   : Named num [1:3] 0.408 2 216</span>
<span class="co">#   .. ..$ cov.unscaled : num [1:3, 1:3] 0.5966 0.0077 -0.7315 0.0077 0.0363 ...</span>
<span class="co">#   .. ..$ na.action    : 'omit' Named int [1:17] 1 58 59 60 61 62 63 64 65 117 ...</span>
<span class="co">#   ..$ Upper middle income:List of 12</span>
<span class="co">#   .. ..$ call         : language FUN(formula = ..1, data = y)</span>
<span class="co">#   .. ..$ terms        :Classes 'terms', 'formula'  language G(PCGDP) ~ G(LIFEEX) + B(G(LIFEEX), country)</span>
<span class="co">#   .. ..$ residuals    : Named num [1:956] 0.102 0.1392 0.1791 0.1765 0.0504 ...</span>
<span class="co">#   .. ..$ coefficients : num [1:3, 1:4] 2.0093 -0.1695 0.0472 0.385 0.5152 ...</span>
<span class="co">#   .. ..$ aliased      : Named logi [1:3] FALSE FALSE FALSE</span>
<span class="co">#   .. ..$ sigma        : num 4.23</span>
<span class="co">#   .. ..$ df           : int [1:3] 3 953 3</span>
<span class="co">#   .. ..$ r.squared    : num 0.000143</span>
<span class="co">#   .. ..$ adj.r.squared: num -0.00196</span>
<span class="co">#   .. ..$ fstatistic   : Named num [1:3] 0.0681 2 953</span>
<span class="co">#   .. ..$ cov.unscaled : num [1:3, 1:3] 0.008283 0.000483 -0.015813 0.000483 0.014836 ...</span>
<span class="co">#   .. ..$ na.action    : 'omit' Named int [1:165] 1 58 59 60 117 118 119 176 177 178 ...</span>
<span class="co">#  $ Middle East &amp; North Africa:List of 4</span>
<span class="co">#   ..$ High income        :List of 12</span>
<span class="co">#   .. ..$ call         : language FUN(formula = ..1, data = y)</span>
<span class="co">#   .. ..$ terms        :Classes 'terms', 'formula'  language G(PCGDP) ~ G(LIFEEX) + B(G(LIFEEX), country)</span>
<span class="co">#   .. ..$ residuals    : Named num [1:310] -10.844 -12.117 2.016 0.844 -8.769 ...</span>
<span class="co">#   .. ..$ coefficients : num [1:3, 1:4] 1.8 3.83 -2.94 1.16 1.06 ...</span>
<span class="co">#   .. ..$ aliased      : Named logi [1:3] FALSE FALSE FALSE</span>
<span class="co">#   .. ..$ sigma        : num 8.61</span>
<span class="co">#   .. ..$ df           : int [1:3] 3 307 3</span>
<span class="co">#   .. ..$ r.squared    : num 0.0414</span>
<span class="co">#   .. ..$ adj.r.squared: num 0.0351</span>
<span class="co">#   .. ..$ fstatistic   : Named num [1:3] 6.62 2 307</span>
<span class="co">#   .. ..$ cov.unscaled : num [1:3, 1:3] 0.0182 0.00135 -0.025 0.00135 0.01504 ...</span>
<span class="co">#   .. ..$ na.action    : 'omit' Named int [1:162] 1 2 3 4 5 6 7 8 9 10 ...</span>
<span class="co">#   ..$ Low income         :List of 12</span>
<span class="co">#   .. ..$ call         : language FUN(formula = ..1, data = y)</span>
<span class="co">#   .. ..$ terms        :Classes 'terms', 'formula'  language G(PCGDP) ~ G(LIFEEX) + B(G(LIFEEX), country)</span>
<span class="co">#   .. ..$ residuals    : Named num [1:26] -2.172 1.655 -0.723 3.193 3.244 ...</span>
<span class="co">#   .. ..$ coefficients : num [1:2, 1:4] -13.32 28.2 6.53 14.47 -2.04 ...</span>
<span class="co">#   .. ..$ aliased      : Named logi [1:3] FALSE FALSE TRUE</span>
<span class="co">#   .. ..$ sigma        : num 5.68</span>
<span class="co">#   .. ..$ df           : int [1:3] 2 24 3</span>
<span class="co">#   .. ..$ r.squared    : num 0.137</span>
<span class="co">#   .. ..$ adj.r.squared: num 0.101</span>
<span class="co">#   .. ..$ fstatistic   : Named num [1:3] 3.8 1 24</span>
<span class="co">#   .. ..$ cov.unscaled : num [1:2, 1:2] 1.32 -2.88 -2.88 6.49</span>
<span class="co">#   .. ..$ na.action    : 'omit' Named int [1:92] 1 2 3 4 5 6 7 8 9 10 ...</span>
<span class="co">#   ..$ Lower middle income:List of 12</span>
<span class="co">#   .. ..$ call         : language FUN(formula = ..1, data = y)</span>
<span class="co">#   .. ..$ terms        :Classes 'terms', 'formula'  language G(PCGDP) ~ G(LIFEEX) + B(G(LIFEEX), country)</span>
<span class="co">#   .. ..$ residuals    : Named num [1:179] -1.159 -2.252 4.333 5.389 -0.925 ...</span>
<span class="co">#   .. ..$ coefficients : num [1:3, 1:4] 3.074 1.286 -1.554 1.188 0.701 ...</span>
<span class="co">#   .. ..$ aliased      : Named logi [1:3] FALSE FALSE FALSE</span>
<span class="co">#   .. ..$ sigma        : num 4.47</span>
<span class="co">#   .. ..$ df           : int [1:3] 3 176 3</span>
<span class="co">#   .. ..$ r.squared    : num 0.0191</span>
<span class="co">#   .. ..$ adj.r.squared: num 0.00794</span>
<span class="co">#   .. ..$ fstatistic   : Named num [1:3] 1.71 2 176</span>
<span class="co">#   .. ..$ cov.unscaled : num [1:3, 1:3] 0.070589 -0.000639 -0.082158 -0.000639 0.02456 ...</span>
<span class="co">#   .. ..$ na.action    : 'omit' Named int [1:116] 1 2 3 4 5 6 7 8 9 10 ...</span>
<span class="co">#   ..$ Upper middle income:List of 12</span>
<span class="co">#   .. ..$ call         : language FUN(formula = ..1, data = y)</span>
<span class="co">#   .. ..$ terms        :Classes 'terms', 'formula'  language G(PCGDP) ~ G(LIFEEX) + B(G(LIFEEX), country)</span>
<span class="co">#   .. ..$ residuals    : Named num [1:246] -18.053 -23.964 28.706 0.876 1.165 ...</span>
<span class="co">#   .. ..$ coefficients : num [1:3, 1:4] 4.613 0.827 -3.458 3.931 1.399 ...</span>
<span class="co">#   .. ..$ aliased      : Named logi [1:3] FALSE FALSE FALSE</span>
<span class="co">#   .. ..$ sigma        : num 14.2</span>
<span class="co">#   .. ..$ df           : int [1:3] 3 243 3</span>
<span class="co">#   .. ..$ r.squared    : num 0.00264</span>
<span class="co">#   .. ..$ adj.r.squared: num -0.00557</span>
<span class="co">#   .. ..$ fstatistic   : Named num [1:3] 0.321 2 243</span>
<span class="co">#   .. ..$ cov.unscaled : num [1:3, 1:3] 0.076158 0.000698 -0.094605 0.000698 0.009642 ...</span>
<span class="co">#   .. ..$ na.action    : 'omit' Named int [1:108] 1 58 59 60 117 118 119 120 121 122 ...</span>
<span class="co">#  $ North America             :List of 1</span>
<span class="co">#   ..$ High income:List of 12</span>
<span class="co">#   .. ..$ call         : language FUN(formula = ..1, data = y)</span>
<span class="co">#   .. ..$ terms        :Classes 'terms', 'formula'  language G(PCGDP) ~ G(LIFEEX) + B(G(LIFEEX), country)</span>
<span class="co">#   .. ..$ residuals    : Named num [1:125] 4.331 -3.606 1.301 0.101 -0.476 ...</span>
<span class="co">#   .. ..$ coefficients : num [1:3, 1:4] 4.362 -0.968 -9.885 2.178 0.614 ...</span>
<span class="co">#   .. ..$ aliased      : Named logi [1:3] FALSE FALSE FALSE</span>
<span class="co">#   .. ..$ sigma        : num 2.31</span>
<span class="co">#   .. ..$ df           : int [1:3] 3 122 3</span>
<span class="co">#   .. ..$ r.squared    : num 0.0313</span>
<span class="co">#   .. ..$ adj.r.squared: num 0.0154</span>
<span class="co">#   .. ..$ fstatistic   : Named num [1:3] 1.97 2 122</span>
<span class="co">#   .. ..$ cov.unscaled : num [1:3, 1:3] 8.88e-01 -8.29e-05 -3.65 -8.29e-05 7.05e-02 ...</span>
<span class="co">#   .. ..$ na.action    : 'omit' Named int [1:52] 1 2 3 4 5 6 7 8 9 10 ...</span>
<span class="co">#  $ South Asia                :List of 3</span>
<span class="co">#   ..$ Low income         :List of 12</span>
<span class="co">#   .. ..$ call         : language FUN(formula = ..1, data = y)</span>
<span class="co">#   .. ..$ terms        :Classes 'terms', 'formula'  language G(PCGDP) ~ G(LIFEEX) + B(G(LIFEEX), country)</span>
<span class="co">#   .. ..$ residuals    : Named num [1:70] -0.143 -6.864 3.149 -1.887 6.779 ...</span>
<span class="co">#   .. ..$ coefficients : num [1:3, 1:4] 113.08 -1.04 -88.58 67.81 1.36 ...</span>
<span class="co">#   .. ..$ aliased      : Named logi [1:3] FALSE FALSE FALSE</span>
<span class="co">#   .. ..$ sigma        : num 3.66</span>
<span class="co">#   .. ..$ df           : int [1:3] 3 67 3</span>
<span class="co">#   .. ..$ r.squared    : num 0.0734</span>
<span class="co">#   .. ..$ adj.r.squared: num 0.0457</span>
<span class="co">#   .. ..$ fstatistic   : Named num [1:3] 2.65 2 67</span>
<span class="co">#   .. ..$ cov.unscaled : num [1:3, 1:3] 344.155 2.955 -280.751 2.955 0.138 ...</span>
<span class="co">#   .. ..$ na.action    : 'omit' Named int [1:48] 1 2 3 4 5 6 7 8 9 10 ...</span>
<span class="co">#   ..$ Lower middle income:List of 12</span>
<span class="co">#   .. ..$ call         : language FUN(formula = ..1, data = y)</span>
<span class="co">#   .. ..$ terms        :Classes 'terms', 'formula'  language G(PCGDP) ~ G(LIFEEX) + B(G(LIFEEX), country)</span>
<span class="co">#   .. ..$ residuals    : Named num [1:259] -0.171 -0.767 -6.554 4.427 -4.754 ...</span>
<span class="co">#   .. ..$ coefficients : num [1:3, 1:4] 1.3742 -0.0169 2.3037 0.6744 0.4604 ...</span>
<span class="co">#   .. ..$ aliased      : Named logi [1:3] FALSE FALSE FALSE</span>
<span class="co">#   .. ..$ sigma        : num 3.36</span>
<span class="co">#   .. ..$ df           : int [1:3] 3 256 3</span>
<span class="co">#   .. ..$ r.squared    : num 0.0303</span>
<span class="co">#   .. ..$ adj.r.squared: num 0.0228</span>
<span class="co">#   .. ..$ fstatistic   : Named num [1:3] 4 2 256</span>
<span class="co">#   .. ..$ cov.unscaled : num [1:3, 1:3] 0.040224 -0.000657 -0.04521 -0.000657 0.018743 ...</span>
<span class="co">#   .. ..$ na.action    : 'omit' Named int [1:36] 1 58 59 60 61 62 63 64 65 66 ...</span>
<span class="co">#   ..$ Upper middle income:List of 12</span>
<span class="co">#   .. ..$ call         : language FUN(formula = ..1, data = y)</span>
<span class="co">#   .. ..$ terms        :Classes 'terms', 'formula'  language G(PCGDP) ~ G(LIFEEX) + B(G(LIFEEX), country)</span>
<span class="co">#   .. ..$ residuals    : Named num [1:21] 1.995 2.675 1.824 0.429 -2.042 ...</span>
<span class="co">#   .. ..$ coefficients : num [1:2, 1:4] 2.589 0.853 3.351 3.674 0.773 ...</span>
<span class="co">#   .. ..$ aliased      : Named logi [1:3] FALSE FALSE TRUE</span>
<span class="co">#   .. ..$ sigma        : num 7.66</span>
<span class="co">#   .. ..$ df           : int [1:3] 2 19 3</span>
<span class="co">#   .. ..$ r.squared    : num 0.00283</span>
<span class="co">#   .. ..$ adj.r.squared: num -0.0497</span>
<span class="co">#   .. ..$ fstatistic   : Named num [1:3] 0.0539 1 19</span>
<span class="co">#   .. ..$ cov.unscaled : num [1:2, 1:2] 0.191 -0.182 -0.182 0.23</span>
<span class="co">#   .. ..$ na.action    : 'omit' Named int [1:38] 1 2 3 4 5 6 7 8 9 10 ...</span>
<span class="co">#  $ Sub-Saharan Africa        :List of 4</span>
<span class="co">#   ..$ High income        :List of 12</span>
<span class="co">#   .. ..$ call         : language FUN(formula = ..1, data = y)</span>
<span class="co">#   .. ..$ terms        :Classes 'terms', 'formula'  language G(PCGDP) ~ G(LIFEEX) + B(G(LIFEEX), country)</span>
<span class="co">#   .. ..$ residuals    : Named num [1:36] -11.209 -5.094 -2.981 0.536 7.877 ...</span>
<span class="co">#   .. ..$ coefficients : num [1:2, 1:4] 2.501 -0.727 0.838 0.596 2.984 ...</span>
<span class="co">#   .. ..$ aliased      : Named logi [1:3] FALSE FALSE TRUE</span>
<span class="co">#   .. ..$ sigma        : num 4.98</span>
<span class="co">#   .. ..$ df           : int [1:3] 2 34 3</span>
<span class="co">#   .. ..$ r.squared    : num 0.0419</span>
<span class="co">#   .. ..$ adj.r.squared: num 0.0137</span>
<span class="co">#   .. ..$ fstatistic   : Named num [1:3] 1.49 1 34</span>
<span class="co">#   .. ..$ cov.unscaled : num [1:2, 1:2] 0.0283 -0.00275 -0.00275 0.01432</span>
<span class="co">#   .. ..$ na.action    : 'omit' Named int [1:23] 1 2 3 4 5 6 7 8 9 10 ...</span>
<span class="co">#   ..$ Low income         :List of 12</span>
<span class="co">#   .. ..$ call         : language FUN(formula = ..1, data = y)</span>
<span class="co">#   .. ..$ terms        :Classes 'terms', 'formula'  language G(PCGDP) ~ G(LIFEEX) + B(G(LIFEEX), country)</span>
<span class="co">#   .. ..$ residuals    : Named num [1:1163] 0.741 -5.822 2.116 3.902 2.461 ...</span>
<span class="co">#   .. ..$ coefficients : num [1:3, 1:4] -0.31 0.565 0.665 0.679 0.136 ...</span>
<span class="co">#   .. ..$ aliased      : Named logi [1:3] FALSE FALSE FALSE</span>
<span class="co">#   .. ..$ sigma        : num 5.75</span>
<span class="co">#   .. ..$ df           : int [1:3] 3 1160 3</span>
<span class="co">#   .. ..$ r.squared    : num 0.0168</span>
<span class="co">#   .. ..$ adj.r.squared: num 0.0151</span>
<span class="co">#   .. ..$ fstatistic   : Named num [1:3] 9.88 2 1160</span>
<span class="co">#   .. ..$ cov.unscaled : num [1:3, 1:3] 1.39e-02 1.70e-06 -1.55e-02 1.70e-06 5.59e-04 ...</span>
<span class="co">#   .. ..$ na.action    : 'omit' Named int [1:430] 1 58 59 60 117 118 119 176 177 178 ...</span>
<span class="co">#   ..$ Lower middle income:List of 12</span>
<span class="co">#   .. ..$ call         : language FUN(formula = ..1, data = y)</span>
<span class="co">#   .. ..$ terms        :Classes 'terms', 'formula'  language G(PCGDP) ~ G(LIFEEX) + B(G(LIFEEX), country)</span>
<span class="co">#   .. ..$ residuals    : Named num [1:693] -7.23 -3.02 1.08 3 0.85 ...</span>
<span class="co">#   .. ..$ coefficients : num [1:3, 1:4] 2.97 1.127 -3.478 0.772 0.218 ...</span>
<span class="co">#   .. ..$ aliased      : Named logi [1:3] FALSE FALSE FALSE</span>
<span class="co">#   .. ..$ sigma        : num 5.29</span>
<span class="co">#   .. ..$ df           : int [1:3] 3 690 3</span>
<span class="co">#   .. ..$ r.squared    : num 0.0419</span>
<span class="co">#   .. ..$ adj.r.squared: num 0.0391</span>
<span class="co">#   .. ..$ fstatistic   : Named num [1:3] 15.1 2 690</span>
<span class="co">#   .. ..$ cov.unscaled : num [1:3, 1:3] 2.13e-02 7.37e-05 -3.31e-02 7.37e-05 1.70e-03 ...</span>
<span class="co">#   .. ..$ na.action    : 'omit' Named int [1:133] 1 2 3 4 5 6 7 8 9 10 ...</span>
<span class="co">#   ..$ Upper middle income:List of 12</span>
<span class="co">#   .. ..$ call         : language FUN(formula = ..1, data = y)</span>
<span class="co">#   .. ..$ terms        :Classes 'terms', 'formula'  language G(PCGDP) ~ G(LIFEEX) + B(G(LIFEEX), country)</span>
<span class="co">#   .. ..$ residuals    : Named num [1:280] 0.311 0.534 -0.287 0.508 -0.58 ...</span>
<span class="co">#   .. ..$ coefficients : num [1:3, 1:4] 1.272 0.571 3.614 2.025 0.676 ...</span>
<span class="co">#   .. ..$ aliased      : Named logi [1:3] FALSE FALSE FALSE</span>
<span class="co">#   .. ..$ sigma        : num 11.6</span>
<span class="co">#   .. ..$ df           : int [1:3] 3 277 3</span>
<span class="co">#   .. ..$ r.squared    : num 0.00866</span>
<span class="co">#   .. ..$ adj.r.squared: num 0.00151</span>
<span class="co">#   .. ..$ fstatistic   : Named num [1:3] 1.21 2 277</span>
<span class="co">#   .. ..$ cov.unscaled : num [1:3, 1:3] 0.030322 0.000224 -0.045458 0.000224 0.003379 ...</span>
<span class="co">#   .. ..$ na.action    : 'omit' Named int [1:74] 1 58 59 60 61 62 63 64 65 66 ...</span></pre></div>
<p>We can turn this list into a <em>data.table</em> again by calling first <code>get_elem</code> to recursively extract the coefficient matrices and then <code>unlist2d</code> to recursively bind them to a new <em>data.table</em>:</p>
<div class="sourceCode" id="cb22"><pre class="downlit">
<span class="va">lm_summary_list</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/has_elem,%20get_elem.html">get_elem</a></span><span class="op">(</span><span class="st">"coefficients"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../reference/unlist2d.html">unlist2d</a></span><span class="op">(</span>idcols <span class="op">=</span> <span class="fu"><a href="../reference/AA2-small-helpers.html">.c</a></span><span class="op">(</span><span class="va">Region</span>, <span class="va">Income</span><span class="op">)</span>, 
           row.names <span class="op">=</span> <span class="st">"Coef"</span>, 
           DT <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">head</span>
<span class="co">#                 Region              Income                  Coef   Estimate Std. Error    t value</span>
<span class="co"># 1: East Asia &amp; Pacific         High income           (Intercept) -0.4698378  0.6492898 -0.7236180</span>
<span class="co"># 2: East Asia &amp; Pacific         High income             G(LIFEEX)  1.3810085  0.7238075  1.9079775</span>
<span class="co"># 3: East Asia &amp; Pacific         High income B(G(LIFEEX), country)  7.4001516  1.5909029  4.6515420</span>
<span class="co"># 4: East Asia &amp; Pacific Lower middle income           (Intercept)  0.1867100  0.8902693  0.2097231</span>
<span class="co"># 5: East Asia &amp; Pacific Lower middle income             G(LIFEEX)  0.9104478  0.8880453  1.0252267</span>
<span class="co"># 6: East Asia &amp; Pacific Lower middle income B(G(LIFEEX), country)  2.6189241  1.4996172  1.7463951</span>
<span class="co">#        Pr(&gt;|t|)</span>
<span class="co"># 1: 4.697109e-01</span>
<span class="co"># 2: 5.708899e-02</span>
<span class="co"># 3: 4.445740e-06</span>
<span class="co"># 4: 8.339696e-01</span>
<span class="co"># 5: 3.057539e-01</span>
<span class="co"># 6: 8.135888e-02</span></pre></div>
<p>The fact that this is a nested list of matrices, and that we can save both the names of the lists at each level of nesting and the row- and column- names of the matrices make <code>unlist2d</code> a significant generalization of <code>rbindlist</code><a href="#fn3" class="footnote-ref" id="fnref3"><sup>3</sup></a>.</p>
<p>But why do all this fuzz if we could have simply done:?</p>
<div class="sourceCode" id="cb23"><pre class="downlit">
<span class="va">DT</span><span class="op">[</span>, <span class="fu"><a href="../reference/A4-quick-conversion.html">qDT</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/lmtest/man/coeftest.html">coeftest</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="fu"><a href="../reference/fgrowth.html">G</a></span><span class="op">(</span><span class="va">PCGDP</span><span class="op">)</span> <span class="op">~</span> <span class="fu"><a href="../reference/fgrowth.html">G</a></span><span class="op">(</span><span class="va">LIFEEX</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="../reference/fbetween,%20fwithin.html">B</a></span><span class="op">(</span><span class="fu"><a href="../reference/fgrowth.html">G</a></span><span class="op">(</span><span class="va">LIFEEX</span><span class="op">)</span>, <span class="va">country</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, <span class="st">"Coef"</span><span class="op">)</span>, 
   keyby <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">region</span>, <span class="va">income</span><span class="op">)</span><span class="op">]</span> <span class="op">%&gt;%</span> <span class="va">head</span>
<span class="co">#                 region              income                  Coef   Estimate Std. Error    t value</span>
<span class="co"># 1: East Asia &amp; Pacific         High income           (Intercept) -0.4698378  0.6492898 -0.7236180</span>
<span class="co"># 2: East Asia &amp; Pacific         High income             G(LIFEEX)  1.3810085  0.7238075  1.9079775</span>
<span class="co"># 3: East Asia &amp; Pacific         High income B(G(LIFEEX), country)  7.4001516  1.5909029  4.6515420</span>
<span class="co"># 4: East Asia &amp; Pacific Lower middle income           (Intercept)  0.1867100  0.8902693  0.2097231</span>
<span class="co"># 5: East Asia &amp; Pacific Lower middle income             G(LIFEEX)  0.9104478  0.8880453  1.0252267</span>
<span class="co"># 6: East Asia &amp; Pacific Lower middle income B(G(LIFEEX), country)  2.6189241  1.4996172  1.7463951</span>
<span class="co">#        Pr(&gt;|t|)</span>
<span class="co"># 1: 4.697109e-01</span>
<span class="co"># 2: 5.708899e-02</span>
<span class="co"># 3: 4.445740e-06</span>
<span class="co"># 4: 8.339696e-01</span>
<span class="co"># 5: 3.057539e-01</span>
<span class="co"># 6: 8.135888e-02</span></pre></div>
<p>Well we might want to do more things with that list of linear models first before tidying it, so this is a more general workflow. We might also be interested in additional statistics like the R-squared or the F-statistic:</p>
<div class="sourceCode" id="cb24"><pre class="downlit">
<span class="va">DT_sum</span> <span class="op">&lt;-</span> <span class="va">lm_summary_list</span> <span class="op">%&gt;%</span>
<span class="fu"><a href="../reference/has_elem,%20get_elem.html">get_elem</a></span><span class="op">(</span><span class="st">"coef|r.sq|fstat"</span>, regex <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../reference/unlist2d.html">unlist2d</a></span><span class="op">(</span>idcols <span class="op">=</span> <span class="fu"><a href="../reference/AA2-small-helpers.html">.c</a></span><span class="op">(</span><span class="va">Region</span>, <span class="va">Income</span>, <span class="va">Statistic</span><span class="op">)</span>, 
           row.names <span class="op">=</span> <span class="st">"Coef"</span>, 
           DT <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">DT_sum</span><span class="op">)</span>
<span class="co">#                 Region      Income     Statistic                  Coef   Estimate Std. Error</span>
<span class="co"># 1: East Asia &amp; Pacific High income  coefficients           (Intercept) -0.4698378  0.6492898</span>
<span class="co"># 2: East Asia &amp; Pacific High income  coefficients             G(LIFEEX)  1.3810085  0.7238075</span>
<span class="co"># 3: East Asia &amp; Pacific High income  coefficients B(G(LIFEEX), country)  7.4001516  1.5909029</span>
<span class="co"># 4: East Asia &amp; Pacific High income     r.squared                  &lt;NA&gt;         NA         NA</span>
<span class="co"># 5: East Asia &amp; Pacific High income adj.r.squared                  &lt;NA&gt;         NA         NA</span>
<span class="co"># 6: East Asia &amp; Pacific High income    fstatistic                  &lt;NA&gt;         NA         NA</span>
<span class="co">#      t value     Pr(&gt;|t|)         V1    value numdf dendf</span>
<span class="co"># 1: -0.723618 4.697109e-01         NA       NA    NA    NA</span>
<span class="co"># 2:  1.907977 5.708899e-02         NA       NA    NA    NA</span>
<span class="co"># 3:  4.651542 4.445740e-06         NA       NA    NA    NA</span>
<span class="co"># 4:        NA           NA 0.08968990       NA    NA    NA</span>
<span class="co"># 5:        NA           NA 0.08527092       NA    NA    NA</span>
<span class="co"># 6:        NA           NA         NA 20.29651     2   412</span>

<span class="co"># Reshaping to long form: </span>
<span class="va">DT_sum</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/data.table/man/melt.data.table.html">melt</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/roworder.html">roworderv</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">20</span><span class="op">)</span>
<span class="co">#                  Region              Income     Statistic                  Coef   variable</span>
<span class="co">#  1: East Asia &amp; Pacific         High income  coefficients           (Intercept)   Estimate</span>
<span class="co">#  2: East Asia &amp; Pacific         High income  coefficients             G(LIFEEX)   Estimate</span>
<span class="co">#  3: East Asia &amp; Pacific         High income  coefficients B(G(LIFEEX), country)   Estimate</span>
<span class="co">#  4: East Asia &amp; Pacific         High income  coefficients           (Intercept) Std. Error</span>
<span class="co">#  5: East Asia &amp; Pacific         High income  coefficients             G(LIFEEX) Std. Error</span>
<span class="co">#  6: East Asia &amp; Pacific         High income  coefficients B(G(LIFEEX), country) Std. Error</span>
<span class="co">#  7: East Asia &amp; Pacific         High income  coefficients           (Intercept)    t value</span>
<span class="co">#  8: East Asia &amp; Pacific         High income  coefficients             G(LIFEEX)    t value</span>
<span class="co">#  9: East Asia &amp; Pacific         High income  coefficients B(G(LIFEEX), country)    t value</span>
<span class="co"># 10: East Asia &amp; Pacific         High income  coefficients           (Intercept)   Pr(&gt;|t|)</span>
<span class="co"># 11: East Asia &amp; Pacific         High income  coefficients             G(LIFEEX)   Pr(&gt;|t|)</span>
<span class="co"># 12: East Asia &amp; Pacific         High income  coefficients B(G(LIFEEX), country)   Pr(&gt;|t|)</span>
<span class="co"># 13: East Asia &amp; Pacific         High income     r.squared                  &lt;NA&gt;         V1</span>
<span class="co"># 14: East Asia &amp; Pacific         High income adj.r.squared                  &lt;NA&gt;         V1</span>
<span class="co"># 15: East Asia &amp; Pacific         High income    fstatistic                  &lt;NA&gt;      value</span>
<span class="co"># 16: East Asia &amp; Pacific         High income    fstatistic                  &lt;NA&gt;      numdf</span>
<span class="co"># 17: East Asia &amp; Pacific         High income    fstatistic                  &lt;NA&gt;      dendf</span>
<span class="co"># 18: East Asia &amp; Pacific Lower middle income  coefficients           (Intercept)   Estimate</span>
<span class="co"># 19: East Asia &amp; Pacific Lower middle income  coefficients             G(LIFEEX)   Estimate</span>
<span class="co"># 20: East Asia &amp; Pacific Lower middle income  coefficients B(G(LIFEEX), country)   Estimate</span>
<span class="co">#             value</span>
<span class="co">#  1: -4.698378e-01</span>
<span class="co">#  2:  1.381008e+00</span>
<span class="co">#  3:  7.400152e+00</span>
<span class="co">#  4:  6.492898e-01</span>
<span class="co">#  5:  7.238075e-01</span>
<span class="co">#  6:  1.590903e+00</span>
<span class="co">#  7: -7.236180e-01</span>
<span class="co">#  8:  1.907977e+00</span>
<span class="co">#  9:  4.651542e+00</span>
<span class="co"># 10:  4.697109e-01</span>
<span class="co"># 11:  5.708899e-02</span>
<span class="co"># 12:  4.445740e-06</span>
<span class="co"># 13:  8.968990e-02</span>
<span class="co"># 14:  8.527092e-02</span>
<span class="co"># 15:  2.029651e+01</span>
<span class="co"># 16:  2.000000e+00</span>
<span class="co"># 17:  4.120000e+02</span>
<span class="co"># 18:  1.867100e-01</span>
<span class="co"># 19:  9.104478e-01</span>
<span class="co"># 20:  2.618924e+00</span></pre></div>
<p>As a final example of this kind, lets suppose we are interested in the within-country correlations of all these variables by region and income group:</p>
<div class="sourceCode" id="cb25"><pre class="downlit">
<span class="va">DT</span><span class="op">[</span>, <span class="fu"><a href="../reference/A4-quick-conversion.html">qDT</a></span><span class="op">(</span><span class="fu"><a href="../reference/pwcor,%20pwcov,%20pwNobs.html">pwcor</a></span><span class="op">(</span><span class="fu"><a href="../reference/fbetween,%20fwithin.html">W</a></span><span class="op">(</span><span class="va">.SD</span>, <span class="va">country</span><span class="op">)</span><span class="op">)</span>, <span class="st">"Variable"</span><span class="op">)</span>, 
   keyby <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">region</span>, <span class="va">income</span><span class="op">)</span>, .SDcols <span class="op">=</span> <span class="va">PCGDP</span><span class="op">:</span><span class="va">ODA</span><span class="op">]</span> <span class="op">%&gt;%</span> <span class="va">head</span>
<span class="co">#                 region              income Variable    W.PCGDP   W.LIFEEX     W.GINI       W.ODA</span>
<span class="co"># 1: East Asia &amp; Pacific         High income  W.PCGDP  1.0000000  0.7446393  0.7939673 -0.25771300</span>
<span class="co"># 2: East Asia &amp; Pacific         High income W.LIFEEX  0.7446393  1.0000000  0.4242715 -0.37949818</span>
<span class="co"># 3: East Asia &amp; Pacific         High income   W.GINI  0.7939673  0.4242715  1.0000000          NA</span>
<span class="co"># 4: East Asia &amp; Pacific         High income    W.ODA -0.2577130 -0.3794982         NA  1.00000000</span>
<span class="co"># 5: East Asia &amp; Pacific Lower middle income  W.PCGDP  1.0000000  0.4154066 -0.1200012 -0.02541587</span>
<span class="co"># 6: East Asia &amp; Pacific Lower middle income W.LIFEEX  0.4154066  1.0000000 -0.1668932  0.10671141</span></pre></div>
<p>In summary: The list processing features, statistical capabilities and efficient converters of <em>collapse</em> and the flexibility of <em>data.table</em> work well together, facilitating more complex workflows.</p>
</div>
<div id="additional-benchmarks" class="section level2">
<h2 class="hasAnchor">
<a href="#additional-benchmarks" class="anchor"></a>Additional Benchmarks</h2>
<p>See <a href="https://sebkrantz.github.io/Rblog/2020/08/31/welcome-to-collapse/">here</a> or <a href="https://sebkrantz.github.io/collapse/reference/fsum.html#benchmark">here</a>.</p>
<p>These are all run on a 2 core laptop, so I honestly don’t know how <em>collapse</em> scales on powerful multi-core machines. My own limited computational resources are part of the reason I did not opt for a thread-parallel package from the start. But a multi-core version of <em>collapse</em> will eventually be released, maybe by end of 2021.</p>
</div>
<div id="references" class="section level2">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<p>Mundlak, Yair. 1978. “On the Pooling of Time Series and Cross Section Data.” <em>Econometrica</em> 46 (1): 69–85.</p>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>Grouping on numeric variables in <em>collapse</em> is always ordered.<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
<li id="fn2"><p>Apart from <code><a href="../reference/BY.html">collapse::BY</a></code> which is only an auxiliary function written in base R to perform flexible split-apply combine computing on vectors, matrices and data frames.<a href="#fnref2" class="footnote-back">↩︎</a></p></li>
<li id="fn3"><p><code>unlist2d</code> can similarly bind nested lists of arrays, data frames or <em>data.table</em>’s<a href="#fnref3" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Sebastian Krantz.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
