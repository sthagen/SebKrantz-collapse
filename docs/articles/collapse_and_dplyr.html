<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head><link rel="shortcut icon" href="https://sebkrantz.github.io/collapse/favicon.ico" type="image/x-icon">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>*collapse* and *dplyr* • collapse</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="*collapse* and *dplyr*">
<meta property="og:description" content="collapse">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">collapse</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.5.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Documentation</a>
</li>
<li>
  <a href="../articles/index.html">Vignettes</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
<li>
  <a href="https://sebkrantz.github.io/Rblog/" target="_blank">Blog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://twitter.com/collapse_R" target="_blank">
    <span class="fa fa-twitter"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/SebKrantz/collapse" target="_blank">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="collapse_and_dplyr_files/accessible-code-block-0.0.1/empty-anchor.js"></script><link href="collapse_and_dplyr_files/anchor-sections-1.0/anchor-sections.css" rel="stylesheet">
<script src="collapse_and_dplyr_files/anchor-sections-1.0/anchor-sections.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>
<em>collapse</em> and <em>dplyr</em>
</h1>
            <h3 class="subtitle">Fast (Weighted) Aggregations and Transformations in a Piped Workflow</h3>
                        <h4 class="author">Sebastian Krantz</h4>
            
            <h4 class="date">2021-01-04</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/SebKrantz/collapse/blob/master/vignettes/collapse_and_dplyr.Rmd"><code>vignettes/collapse_and_dplyr.Rmd</code></a></small>
      <div class="hidden name"><code>collapse_and_dplyr.Rmd</code></div>

    </div>

    
    
<style type="text/css">
pre {
  max-height: 500px;
  overflow-y: auto;
}

pre[class] {
  max-height: 500px;
}
</style>
<!--
*collapse* is a C/C++ based package for data transformation and statistical computing in R. It's aims are:

1. To facilitate complex data transformation, exploration and computing tasks in R.
2. To help make R code fast, flexible, parsimonious and programmer friendly. 
--><p>This vignette focuses on the integration of <em>collapse</em> and the popular <em>dplyr</em> package by Hadley Wickham. In particular it will demonstrate how using <em>collapse</em>’s fast functions and some fast alternatives for <em>dplyr</em> verbs can substantially facilitate and speed up basic data manipulation, grouped and weighted aggregations and transformations, and panel data computations (i.e. between- and within-transformations, panel-lags, differences and growth rates) in a <em>dplyr</em> (piped) workflow.</p>
<hr>
<p><strong>Notes:</strong></p>
<ul>
<li><p>This vignette is targeted at <em>dplyr</em> / <em>tidyverse</em> users. <em>collapse</em> is a standalone package and can be programmed efficiently without pipes or <em>dplyr</em> verbs.</p></li>
<li><p>The ‘Introduction to <em>collapse</em>’ vignette provides a thorough introduction to the package and a built-in structured documentation is available under <code><a href="../reference/index.html">help("collapse-documentation")</a></code> after installing the package. In addition <code><a href="../reference/collapse-package.html">help("collapse-package")</a></code> provides a compact set of examples for quick-start.</p></li>
<li><p>Documentation and vignettes can also be viewed <a href="https://sebkrantz.github.io/collapse/">online</a>.</p></li>
</ul>
<hr>
<div id="fast-aggregations" class="section level2">
<h2 class="hasAnchor">
<a href="#fast-aggregations" class="anchor"></a>1. Fast Aggregations</h2>
<p>A key feature of <em>collapse</em> is it’s broad set of <em>Fast Statistical Functions</em> (<code>fsum, fprod, fmean, fmedian, fmode, fvar, fsd, fmin, fmax, fnth, ffirst, flast, fNobs, fNdistinct</code>) which are able to substantially speed-up column-wise, grouped and weighted computations on vectors, matrices or data frames. The functions are S3 generic, with a default (vector), matrix and data frame method, as well as a grouped_df method for grouped tibbles used by <em>dplyr</em>. The grouped tibble method has the following arguments:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw">FUN.grouped_df</span>(x, [<span class="dt">w =</span> <span class="ot">NULL</span>,] <span class="dt">TRA =</span> <span class="ot">NULL</span>, [<span class="dt">na.rm =</span> <span class="ot">TRUE</span>,]</span>
<span id="cb1-2"><a href="#cb1-2"></a>               <span class="dt">use.g.names =</span> <span class="ot">FALSE</span>, <span class="dt">keep.group_vars =</span> <span class="ot">TRUE</span>, [<span class="dt">keep.w =</span> <span class="ot">TRUE</span>,] ...)</span></code></pre></div>
<p>where <code>w</code> is a weight variable, and <code>TRA</code> and can be used to transform <code>x</code> using the computed statistics and one of 10 available transformations (<code>"replace_fill", "replace", "-", "-+", "/", "%", "+", "*", "%%", "-%%"</code>, discussed in section 2). <code>na.rm</code> efficiently removes missing values and is <code>TRUE</code> by default. <code>use.g.names</code> generates new row-names from the unique combinations of groups (default: disabled), whereas <code>keep.group_vars</code> (default: enabled) will keep the grouping columns as is custom in the native <code>data %&gt;% group_by(...) %&gt;% summarize(...)</code> workflow in <em>dplyr</em>. Finally, <code>keep.w</code> regulates whether a weighting variable used is also aggregated and saved in a column. For <code>fsum, fmean, fmedian, fnth, fvar, fsd</code> and <code>fmode</code> this will compute the sum of the weights in each group, whereas <code>fprod</code> returns the product of the weights.</p>
<p>With that in mind, let’s consider some straightforward applications.</p>
<div id="simple-aggregations" class="section level3">
<h3 class="hasAnchor">
<a href="#simple-aggregations" class="anchor"></a>1.1 Simple Aggregations</h3>
<p>Consider the Groningen Growth and Development Center 10-Sector Database included in <em>collapse</em> and introduced in the main vignette:</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://sebkrantz.github.io/collapse/">collapse</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">GGDC10S</span><span class="op">)</span>
<span class="co">#   Country Regioncode             Region Variable Year      AGR      MIN       MAN        PU</span>
<span class="co"># 1     BWA        SSA Sub-saharan Africa       VA 1960       NA       NA        NA        NA</span>
<span class="co"># 2     BWA        SSA Sub-saharan Africa       VA 1961       NA       NA        NA        NA</span>
<span class="co"># 3     BWA        SSA Sub-saharan Africa       VA 1962       NA       NA        NA        NA</span>
<span class="co"># 4     BWA        SSA Sub-saharan Africa       VA 1963       NA       NA        NA        NA</span>
<span class="co"># 5     BWA        SSA Sub-saharan Africa       VA 1964 16.30154 3.494075 0.7365696 0.1043936</span>
<span class="co"># 6     BWA        SSA Sub-saharan Africa       VA 1965 15.72700 2.495768 1.0181992 0.1350976</span>
<span class="co">#         CON      WRT      TRA     FIRE      GOV      OTH      SUM</span>
<span class="co"># 1        NA       NA       NA       NA       NA       NA       NA</span>
<span class="co"># 2        NA       NA       NA       NA       NA       NA       NA</span>
<span class="co"># 3        NA       NA       NA       NA       NA       NA       NA</span>
<span class="co"># 4        NA       NA       NA       NA       NA       NA       NA</span>
<span class="co"># 5 0.6600454 6.243732 1.658928 1.119194 4.822485 2.341328 37.48229</span>
<span class="co"># 6 1.3462312 7.064825 1.939007 1.246789 5.695848 2.678338 39.34710</span>

<span class="co"># Summarize the Data: </span>
<span class="co"># descr(GGDC10S, cols = is.categorical)</span>
<span class="co"># aperm(qsu(GGDC10S, ~Variable, cols = is.numeric))</span>

<span class="co"># Efficiently converting to tibble (no deep copy)</span>
<span class="va">GGDC10S</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/A4-quick-conversion.html">qTBL</a></span><span class="op">(</span><span class="va">GGDC10S</span><span class="op">)</span></pre></div>
<p>Simple column-wise computations using the fast functions and pipe operators are performed as follows:</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>

<span class="va">GGDC10S</span> <span class="op">%&gt;%</span> <span class="va">fNobs</span>                       <span class="co"># Number of Observations</span>
<span class="co">#    Country Regioncode     Region   Variable       Year        AGR        MIN        MAN         PU </span>
<span class="co">#       5027       5027       5027       5027       5027       4364       4355       4355       4354 </span>
<span class="co">#        CON        WRT        TRA       FIRE        GOV        OTH        SUM </span>
<span class="co">#       4355       4355       4355       4355       3482       4248       4364</span>
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span> <span class="va">fNdistinct</span>                  <span class="co"># Number of distinct values</span>
<span class="co">#    Country Regioncode     Region   Variable       Year        AGR        MIN        MAN         PU </span>
<span class="co">#         43          6          6          2         67       4353       4224       4353       4237 </span>
<span class="co">#        CON        WRT        TRA       FIRE        GOV        OTH        SUM </span>
<span class="co">#       4339       4344       4334       4349       3470       4238       4364</span>
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select_all.html">select_at</a></span><span class="op">(</span><span class="fl">6</span><span class="op">:</span><span class="fl">16</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">fmedian</span> <span class="co"># Median</span>
<span class="co">#        AGR        MIN        MAN         PU        CON        WRT        TRA       FIRE        GOV </span>
<span class="co">#  4394.5194   173.2234  3718.0981   167.9500  1473.4470  3773.6430  1174.8000   960.1251  3928.5127 </span>
<span class="co">#        OTH        SUM </span>
<span class="co">#  1433.1722 23186.1936</span>
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select_all.html">select_at</a></span><span class="op">(</span><span class="fl">6</span><span class="op">:</span><span class="fl">16</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">fmean</span>   <span class="co"># Mean</span>
<span class="co">#        AGR        MIN        MAN         PU        CON        WRT        TRA       FIRE        GOV </span>
<span class="co">#  2526696.5  1867908.9  5538491.4   335679.5  1801597.6  3392909.5  1473269.7  1657114.8  1712300.3 </span>
<span class="co">#        OTH        SUM </span>
<span class="co">#  1684527.3 21566436.8</span>
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span> <span class="va">fmode</span>                       <span class="co"># Mode</span>
<span class="co">#            Country         Regioncode             Region           Variable               Year </span>
<span class="co">#              "USA"              "ASI"             "Asia"              "EMP"             "2010" </span>
<span class="co">#                AGR                MIN                MAN                 PU                CON </span>
<span class="co"># "171.315882316326"                "0" "4645.12507642586"                "0" "1.34623115930777" </span>
<span class="co">#                WRT                TRA               FIRE                GOV                OTH </span>
<span class="co"># "21.8380052682527" "8.97743416914571" "40.0701608636442"                "0" "3626.84423577048" </span>
<span class="co">#                SUM </span>
<span class="co"># "37.4822945751317"</span>
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/fmode.html">fmode</a></span><span class="op">(</span>drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>         <span class="co"># Keep data structure intact</span>
<span class="co"># # A tibble: 1 x 16</span>
<span class="co">#   Country Regioncode Region Variable  Year   AGR   MIN   MAN    PU   CON   WRT   TRA  FIRE   GOV</span>
<span class="co"># * &lt;chr&gt;   &lt;chr&gt;      &lt;chr&gt;  &lt;chr&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co"># 1 USA     ASI        Asia   EMP       2010  171.     0 4645.     0  1.35  21.8  8.98  40.1     0</span>
<span class="co"># # ... with 2 more variables: OTH &lt;dbl&gt;, SUM &lt;dbl&gt;</span></pre></div>
<p>Moving on to grouped statistics, we can compute the average value added and employment by sector and country using:</p>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select_all.html">select_at</a></span><span class="op">(</span><span class="fl">6</span><span class="op">:</span><span class="fl">16</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">fmean</span>
<span class="co"># # A tibble: 85 x 13</span>
<span class="co">#    Variable Country     AGR     MIN     MAN     PU    CON    WRT    TRA   FIRE     GOV    OTH    SUM</span>
<span class="co">#    &lt;chr&gt;    &lt;chr&gt;     &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;</span>
<span class="co">#  1 EMP      ARG       1420.   52.1   1932.  1.02e2 7.42e2 1.98e3 6.49e2  628.   2043.  9.92e2 1.05e4</span>
<span class="co">#  2 EMP      BOL        964.   56.0    235.  5.35e0 1.23e2 2.82e2 1.15e2   44.6    NA   3.96e2 2.22e3</span>
<span class="co">#  3 EMP      BRA      17191.  206.    6991.  3.65e2 3.52e3 8.51e3 2.05e3 4414.   5307.  5.71e3 5.43e4</span>
<span class="co">#  4 EMP      BWA        188.   10.5     18.1 3.09e0 2.53e1 3.63e1 8.36e0   15.3    61.1 2.76e1 3.94e2</span>
<span class="co">#  5 EMP      CHL        702.  101.     625.  2.94e1 2.96e2 6.95e2 2.58e2  272.     NA   1.00e3 3.98e3</span>
<span class="co">#  6 EMP      CHN     287744. 7050.   67144.  1.61e3 2.09e4 2.89e4 1.39e4 4929.  22669.  3.10e4 4.86e5</span>
<span class="co">#  7 EMP      COL       3091.  145.    1175.  3.39e1 5.24e2 2.07e3 4.70e2  649.     NA   1.73e3 9.89e3</span>
<span class="co">#  8 EMP      CRI        231.    1.70   136.  1.43e1 5.76e1 1.57e2 4.24e1   54.9   128.  6.51e1 8.87e2</span>
<span class="co">#  9 EMP      DEW       2490.  407.    8473.  2.26e2 2.09e3 4.44e3 1.48e3 1689.   3945.  9.99e2 2.62e4</span>
<span class="co"># 10 EMP      DNK        236.    8.03   507.  1.38e1 1.71e2 4.55e2 1.61e2  181.    549.  1.11e2 2.39e3</span>
<span class="co"># # ... with 75 more rows</span></pre></div>
<p>Similarly we can aggregate using any other of the above functions.</p>
<!-- ```{r} -->
<!-- GGDC10S %>%  -->
<!--   group_by(Variable, Country) %>% -->
<!--   select_at(6:16) %>% fmedian -->
<!-- GGDC10S %>%  -->
<!--   group_by(Variable, Country) %>% -->
<!--   select_at(6:16) %>% fsd -->
<!-- ``` -->
<p>It is important to not use <em>dplyr</em>’s <code>summarize</code> together with these functions since that would eliminate their speed gain. These functions are fast because they are executed only once and carry out the grouped computations in C++, whereas <code>summarize</code> will apply the function to each group in the grouped tibble.</p>
<!-- - It will also work with the fast functions, but is slower than using primitive base functions since the fast functions are S3 generic -.  -->
<hr>
<div id="excursus-what-is-happening-behind-the-scenes" class="section level4">
<h4 class="hasAnchor">
<a href="#excursus-what-is-happening-behind-the-scenes" class="anchor"></a>Excursus: What is Happening Behind the Scenes?</h4>
<p>To better explain this point it is perhaps good to shed some light on what is happening behind the scenes of <em>dplyr</em> and <em>collapse</em>. Fundamentally both packages follow different computing paradigms:</p>
<p><em>dplyr</em> is an efficient implementation of the Split-Apply-Combine computing paradigm. Data is split into groups, these data-chunks are then passed to a function carrying out the computation, and finally recombined to produce the aggregated data.frame. <!-- The efficiency of that process depends on the efficiency of the grouping, splitting, the function(s) applied and the recombining.  --> This modus operandi is evident in the grouping mechanism of <em>dplyr</em>. When a data.frame is passed through <em>group_by</em>, a ‘groups’ attribute is attached:</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="st">"groups"</span><span class="op">)</span>
<span class="co"># # A tibble: 85 x 3</span>
<span class="co">#    Variable Country       .rows</span>
<span class="co">#  * &lt;chr&gt;    &lt;chr&gt;   &lt;list&lt;int&gt;&gt;</span>
<span class="co">#  1 EMP      ARG            [62]</span>
<span class="co">#  2 EMP      BOL            [61]</span>
<span class="co">#  3 EMP      BRA            [62]</span>
<span class="co">#  4 EMP      BWA            [52]</span>
<span class="co">#  5 EMP      CHL            [63]</span>
<span class="co">#  6 EMP      CHN            [62]</span>
<span class="co">#  7 EMP      COL            [61]</span>
<span class="co">#  8 EMP      CRI            [62]</span>
<span class="co">#  9 EMP      DEW            [61]</span>
<span class="co"># 10 EMP      DNK            [64]</span>
<span class="co"># # ... with 75 more rows</span></pre></div>
<p>This object is a data.frame giving the unique groups and in the third (last) column vectors containing the indices of the rows belonging to that group. A command like <code>summarize</code> uses this information to split the data.frame into groups which are then passed sequentially to the function used and later recombined. These steps are also done in C++ which makes <em>dplyr</em> quite efficient.</p>
<p>Now <em>collapse</em> is based around one-pass grouped computations at the C++ level using its own grouped statistical functions. In other words the data is not split and recombined at all but the entire computation is performed in a single C++ loop running through that data and completing the computations for each group simultaneously. This modus operandi is also evident in <em>collapse</em> grouping objects. The method <code>GRP.grouped_df</code> takes a <em>dplyr</em> grouping object from a grouped tibble and efficiently converts it to a <em>collapse</em> grouping object:</p>
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">GRP</span> <span class="op">%&gt;%</span> <span class="va">str</span>
<span class="co"># List of 8</span>
<span class="co">#  $ N.groups   : int 85</span>
<span class="co">#  $ group.id   : int [1:5027] 46 46 46 46 46 46 46 46 46 46 ...</span>
<span class="co">#  $ group.sizes: int [1:85] 62 61 62 52 63 62 61 62 61 64 ...</span>
<span class="co">#  $ groups     :List of 2</span>
<span class="co">#   ..$ Variable: chr [1:85] "EMP" "EMP" "EMP" "EMP" ...</span>
<span class="co">#   .. ..- attr(*, "label")= chr "Variable"</span>
<span class="co">#   .. ..- attr(*, "format.stata")= chr "%9s"</span>
<span class="co">#   ..$ Country : chr [1:85] "ARG" "BOL" "BRA" "BWA" ...</span>
<span class="co">#   .. ..- attr(*, "label")= chr "Country"</span>
<span class="co">#   .. ..- attr(*, "format.stata")= chr "%9s"</span>
<span class="co">#  $ group.vars : chr [1:2] "Variable" "Country"</span>
<span class="co">#  $ ordered    : logi [1:2] TRUE TRUE</span>
<span class="co">#  $ order      : NULL</span>
<span class="co">#  $ call       : language GRP.grouped_df(X = .)</span>
<span class="co">#  - attr(*, "class")= chr "GRP"</span></pre></div>
<p>This object is a list where the first three elements give the number of groups, the group-id to which each row belongs and a vector of group-sizes. A function like <code>fsum</code> uses this information to (for each column) create a result vector of size ‘N.groups’ and the run through the column using the ‘group.id’ vector to add the i’th data point to the ’group.id[i]’th element of the result vector. When the loop is finished, the grouped computation is also finished.</p>
<p>It is obvious that <em>collapse</em> is faster than <em>dplyr</em> since it’s method of computing involves less steps, and it does not need to call statistical functions multiple times. See the benchmark section. <!-- This performance gain is realized especially as data become large, since the conversion perfomed by `GRP.grouped_df` also involves a small computational cost.  --></p>
<hr>
</div>
</div>
<div id="more-speed-using-collapse-verbs" class="section level3">
<h3 class="hasAnchor">
<a href="#more-speed-using-collapse-verbs" class="anchor"></a>1.2 More Speed using <em>collapse</em> Verbs</h3>
<p><em>collapse</em> fast functions do not develop their maximal performance on a grouped tibble created with <code>group_by</code> because of the additional conversion cost of the grouping object incurred by <code>GRP.grouped_df</code>. This cost is already minimized through the use of C++, but we can do even better replacing <code>group_by</code> with <code><a href="../reference/GRP,%20fgroup_by.html">collapse::fgroup_by</a></code>. <code>fgroup_by</code> works like <code>group_by</code> but does the grouping with <code><a href="../reference/GRP,%20fgroup_by.html">collapse::GRP</a></code> (up to 10x faster than <code>group_by</code>) and simply attaches a <em>collapse</em> grouping object to the grouped_df. Thus the speed gain is 2-fold: Faster grouping and no conversion cost when calling <em>collapse</em> functions.</p>
<p>Another improvement comes from replacing the <em>dplyr</em> verb <code>select</code> with <code><a href="../reference/fselect,%20get_vars,%20add_vars.html">collapse::fselect</a></code>, and, for selection using column names, indices or functions use <code><a href="../reference/fselect,%20get_vars,%20add_vars.html">collapse::get_vars</a></code> instead of <code>select_at</code> or <code>select_if</code>. Next to <code>get_vars</code>, <em>collapse</em> also introduces the predicates <code>num_vars</code>, <code>cat_vars</code>, <code>char_vars</code>, <code>fact_vars</code>, <code>logi_vars</code> and <code>Date_vars</code> to efficiently select columns by type.</p>
<div class="sourceCode" id="cb7"><pre class="downlit">
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">get_vars</a></span><span class="op">(</span><span class="fl">6</span><span class="op">:</span><span class="fl">16</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">fmedian</span>
<span class="co"># # A tibble: 85 x 13</span>
<span class="co">#    Variable Country     AGR     MIN     MAN     PU    CON    WRT    TRA   FIRE     GOV    OTH    SUM</span>
<span class="co">#    &lt;chr&gt;    &lt;chr&gt;     &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;</span>
<span class="co">#  1 EMP      ARG       1325.   47.4   1988.  1.05e2 7.82e2 1.85e3 5.80e2  464.   1739.   866.  9.74e3</span>
<span class="co">#  2 EMP      BOL        943.   53.5    167.  4.46e0 6.60e1 1.32e2 9.70e1   15.3    NA    384.  1.84e3</span>
<span class="co">#  3 EMP      BRA      17481.  225.    7208.  3.76e2 4.05e3 6.45e3 1.58e3 4355.   4450.  4479.  5.19e4</span>
<span class="co">#  4 EMP      BWA        175.   12.2     13.1 3.71e0 1.90e1 2.11e1 6.75e0   10.4    53.8   31.2 3.61e2</span>
<span class="co">#  5 EMP      CHL        690.   93.9    607.  2.58e1 2.30e2 4.84e2 2.05e2  106.     NA    900.  3.31e3</span>
<span class="co">#  6 EMP      CHN     293915  8150.   61761.  1.14e3 1.06e4 1.70e4 9.56e3 4328.  19468.  9954.  4.45e5</span>
<span class="co">#  7 EMP      COL       3006.   84.0   1033.  3.71e1 4.19e2 1.55e3 3.91e2  655.     NA   1430.  8.63e3</span>
<span class="co">#  8 EMP      CRI        216.    1.49   114.  7.92e0 5.50e1 8.98e1 2.55e1   19.6   122.    60.6 7.19e2</span>
<span class="co">#  9 EMP      DEW       2178   320.    8459.  2.47e2 2.10e3 4.45e3 1.53e3 1656    3700    900   2.65e4</span>
<span class="co"># 10 EMP      DNK        187.    3.75   508.  1.36e1 1.65e2 4.61e2 1.61e2  169.    642.   104.  2.42e3</span>
<span class="co"># # ... with 75 more rows</span>

<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>collapse <span class="op">=</span> <span class="va">GGDC10S</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">get_vars</a></span><span class="op">(</span><span class="fl">6</span><span class="op">:</span><span class="fl">16</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">fmedian</span>,
               hybrid <span class="op">=</span> <span class="va">GGDC10S</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select_all.html">select_at</a></span><span class="op">(</span><span class="fl">6</span><span class="op">:</span><span class="fl">16</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">fmedian</span>,
               dplyr <span class="op">=</span> <span class="va">GGDC10S</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select_all.html">select_at</a></span><span class="op">(</span><span class="fl">6</span><span class="op">:</span><span class="fl">16</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise_all.html">summarise_all</a></span><span class="op">(</span><span class="va">median</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
<span class="co"># Unit: microseconds</span>
<span class="co">#      expr      min        lq       mean     median         uq        max neval cld</span>
<span class="co">#  collapse   718.46   796.777   927.1658   823.9975   887.3645   8953.525   100 a  </span>
<span class="co">#    hybrid 12246.39 12681.261 13564.9215 12951.6875 13480.7145  22790.793   100  b </span>
<span class="co">#     dplyr 56282.17 57989.072 62363.1482 59498.5065 64035.2900 135722.398   100   c</span></pre></div>
<p>Benchmarks on the different components of this code and with larger data are provided under ‘Benchmarks’. Note that a grouped tibble created with <code>fgroup_by</code> can no longer be used for grouped computations with <em>dplyr</em> verbs like <code>mutate</code> or <code>summarize</code>. <code>fgroup_by</code> first assigns the class <em>GDP_df</em> which is for printing grouping information and subsetting, then the object classes (<em>tbl_df</em>, <em>data.table</em> or whatever else), followed by classes <em>grouped_df</em> and <em>data.frame</em>, and adds the grouping object in a ‘groups’ attribute. Since <em>tbl_df</em> is assigned before <em>grouped_df</em>, the object is treated by the <em>dplyr</em> ecosystem like a normal tibble.</p>
<div class="sourceCode" id="cb8"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">GGDC10S</span>, <span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span><span class="op">)</span>
<span class="co"># [1] "grouped_df" "tbl_df"     "tbl"        "data.frame"</span>

<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_by</a></span><span class="op">(</span><span class="va">GGDC10S</span>, <span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span><span class="op">)</span>
<span class="co"># [1] "GRP_df"     "tbl_df"     "tbl"        "grouped_df" "data.frame"</span></pre></div>
<p>The function <code>fungroup</code> removes classes ‘GDP_df’ and ‘grouped_df’ and the ‘groups’ attribute (and can thus also be used for grouped tibbles created with <code><a href="https://dplyr.tidyverse.org/reference/group_by.html">dplyr::group_by</a></code>).</p>
<p>Note that any kind of data frame based class can be grouped with <code>fgroup_by</code>, and still retain full responsiveness to all methods defined for that class. Functions performing aggregation on the grouped data frame remove the grouping object and classes afterwards, yielding an object with the same class and attributes as the input.</p>
<p>The print method shown below reports the grouping variables, and then in square brackets the information <code>[number of groups | average group size (standard-deviation of group sizes)]</code>:</p>
<div class="sourceCode" id="cb9"><pre class="downlit">
<span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_by</a></span><span class="op">(</span><span class="va">GGDC10S</span>, <span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span>
<span class="co"># # A tibble: 5,027 x 16</span>
<span class="co">#    Country Regioncode Region Variable  Year   AGR   MIN    MAN     PU    CON   WRT   TRA  FIRE   GOV</span>
<span class="co">#    &lt;chr&gt;   &lt;chr&gt;      &lt;chr&gt;  &lt;chr&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co">#  1 BWA     SSA        Sub-s~ VA        1960  NA   NA    NA     NA     NA     NA    NA    NA    NA   </span>
<span class="co">#  2 BWA     SSA        Sub-s~ VA        1961  NA   NA    NA     NA     NA     NA    NA    NA    NA   </span>
<span class="co">#  3 BWA     SSA        Sub-s~ VA        1962  NA   NA    NA     NA     NA     NA    NA    NA    NA   </span>
<span class="co">#  4 BWA     SSA        Sub-s~ VA        1963  NA   NA    NA     NA     NA     NA    NA    NA    NA   </span>
<span class="co">#  5 BWA     SSA        Sub-s~ VA        1964  16.3  3.49  0.737  0.104  0.660  6.24  1.66  1.12  4.82</span>
<span class="co">#  6 BWA     SSA        Sub-s~ VA        1965  15.7  2.50  1.02   0.135  1.35   7.06  1.94  1.25  5.70</span>
<span class="co">#  7 BWA     SSA        Sub-s~ VA        1966  17.7  1.97  0.804  0.203  1.35   8.27  2.15  1.36  6.37</span>
<span class="co">#  8 BWA     SSA        Sub-s~ VA        1967  19.1  2.30  0.938  0.203  0.897  4.31  1.72  1.54  7.04</span>
<span class="co">#  9 BWA     SSA        Sub-s~ VA        1968  21.1  1.84  0.750  0.203  1.22   5.17  2.44  1.03  5.03</span>
<span class="co"># 10 BWA     SSA        Sub-s~ VA        1969  21.9  5.24  2.14   0.578  3.47   5.75  2.72  1.23  5.59</span>
<span class="co"># # ... with 5,017 more rows, and 2 more variables: OTH &lt;dbl&gt;, SUM &lt;dbl&gt;</span>
<span class="co"># </span>
<span class="co"># Grouped by:  Variable, Country  [85 | 59 (7.7)]</span></pre></div>
<p>Note further that <code>fselect</code> and <code>get_vars</code> are not full drop-in replacements for <code>select</code> because they do not have a grouped_df method:</p>
<div class="sourceCode" id="cb10"><pre class="downlit">
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select_all.html">select_at</a></span><span class="op">(</span><span class="fl">6</span><span class="op">:</span><span class="fl">16</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span>
<span class="co"># # A tibble: 3 x 13</span>
<span class="co"># # Groups:   Variable, Country [1]</span>
<span class="co">#   Variable Country   AGR   MIN   MAN    PU   CON   WRT   TRA  FIRE   GOV   OTH    SUM</span>
<span class="co">#   &lt;chr&gt;    &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;</span>
<span class="co"># 1 EMP      EGY     5206.  29.0 2436.  307. 2733. 2977. 1992.  801. 5539.    NA 22020.</span>
<span class="co"># 2 EMP      EGY     5186.  27.6 2374.  318. 2795. 3020. 2048.  815. 5636.    NA 22219.</span>
<span class="co"># 3 EMP      EGY     5161.  24.8 2348.  325. 2931. 3110. 2065.  832. 5736.    NA 22533.</span>
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">get_vars</a></span><span class="op">(</span><span class="fl">6</span><span class="op">:</span><span class="fl">16</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span>
<span class="co"># # A tibble: 3 x 11</span>
<span class="co">#     AGR   MIN   MAN    PU   CON   WRT   TRA  FIRE   GOV   OTH    SUM</span>
<span class="co">#   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;</span>
<span class="co"># 1 5206.  29.0 2436.  307. 2733. 2977. 1992.  801. 5539.    NA 22020.</span>
<span class="co"># 2 5186.  27.6 2374.  318. 2795. 3020. 2048.  815. 5636.    NA 22219.</span>
<span class="co"># 3 5161.  24.8 2348.  325. 2931. 3110. 2065.  832. 5736.    NA 22533.</span></pre></div>
<p>Since by default <code>keep.group_vars = TRUE</code> in the <em>Fast Statistical Functions</em>, the end result is nevertheless the same:</p>
<div class="sourceCode" id="cb11"><pre class="downlit">
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select_all.html">select_at</a></span><span class="op">(</span><span class="fl">6</span><span class="op">:</span><span class="fl">16</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">fmean</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span>
<span class="co"># # A tibble: 3 x 13</span>
<span class="co">#   Variable Country     AGR     MIN     MAN      PU    CON    WRT    TRA   FIRE     GOV    OTH    SUM</span>
<span class="co">#   &lt;chr&gt;    &lt;chr&gt;     &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;</span>
<span class="co"># 1 VA       VEN      6.86e3  3.55e4  19553.   1064. 1.17e4 1.93e4 8.03e3 5.60e3 NA      19986. 1.28e5</span>
<span class="co"># 2 VA       ZAF      1.64e4  4.29e4  87572.  13826. 1.64e4 6.83e4 4.53e4 6.64e4  7.58e4 30167. 4.63e5</span>
<span class="co"># 3 VA       ZMB      1.27e6  1.01e6 899510. 219164. 8.66e5 2.10e6 7.05e5 9.10e5  1.10e6 81871. 9.16e6</span>
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">get_vars</a></span><span class="op">(</span><span class="fl">6</span><span class="op">:</span><span class="fl">16</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">fmean</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span>
<span class="co"># # A tibble: 3 x 13</span>
<span class="co">#   Variable Country     AGR     MIN     MAN      PU    CON    WRT    TRA   FIRE     GOV    OTH    SUM</span>
<span class="co">#   &lt;chr&gt;    &lt;chr&gt;     &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;</span>
<span class="co"># 1 VA       VEN      6.86e3  3.55e4  19553.   1064. 1.17e4 1.93e4 8.03e3 5.60e3 NA      19986. 1.28e5</span>
<span class="co"># 2 VA       ZAF      1.64e4  4.29e4  87572.  13826. 1.64e4 6.83e4 4.53e4 6.64e4  7.58e4 30167. 4.63e5</span>
<span class="co"># 3 VA       ZMB      1.27e6  1.01e6 899510. 219164. 8.66e5 2.10e6 7.05e5 9.10e5  1.10e6 81871. 9.16e6</span></pre></div>
<p>Another useful verb introduced by <em>collapse</em> is <code>fgroup_vars</code>, which can be used to efficiently obtain the grouping columns or grouping variables from a grouped tibble:</p>
<div class="sourceCode" id="cb12"><pre class="downlit">
<span class="co"># fgroup_by fully supports grouped tibbles created with group_by or fgroup_by: </span>
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">fgroup_vars</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span>
<span class="co"># # A tibble: 3 x 2</span>
<span class="co">#   Variable Country</span>
<span class="co">#   &lt;chr&gt;    &lt;chr&gt;  </span>
<span class="co"># 1 VA       BWA    </span>
<span class="co"># 2 VA       BWA    </span>
<span class="co"># 3 VA       BWA</span>
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">fgroup_vars</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span>
<span class="co"># # A tibble: 3 x 2</span>
<span class="co">#   Variable Country</span>
<span class="co">#   &lt;chr&gt;    &lt;chr&gt;  </span>
<span class="co"># 1 VA       BWA    </span>
<span class="co"># 2 VA       BWA    </span>
<span class="co"># 3 VA       BWA</span>

<span class="co"># The other possibilities:</span>
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_vars</a></span><span class="op">(</span><span class="st">"unique"</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span>
<span class="co"># # A tibble: 3 x 2</span>
<span class="co">#   Variable Country</span>
<span class="co">#   &lt;chr&gt;    &lt;chr&gt;  </span>
<span class="co"># 1 EMP      ARG    </span>
<span class="co"># 2 EMP      BOL    </span>
<span class="co"># 3 EMP      BRA</span>
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_vars</a></span><span class="op">(</span><span class="st">"names"</span><span class="op">)</span>
<span class="co"># [1] "Variable" "Country"</span>
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_vars</a></span><span class="op">(</span><span class="st">"indices"</span><span class="op">)</span>
<span class="co"># [1] 4 1</span>
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_vars</a></span><span class="op">(</span><span class="st">"named_indices"</span><span class="op">)</span>
<span class="co"># Variable  Country </span>
<span class="co">#        4        1</span>
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_vars</a></span><span class="op">(</span><span class="st">"logical"</span><span class="op">)</span>
<span class="co">#  [1]  TRUE FALSE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE</span>
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_vars</a></span><span class="op">(</span><span class="st">"named_logical"</span><span class="op">)</span>
<span class="co">#    Country Regioncode     Region   Variable       Year        AGR        MIN        MAN         PU </span>
<span class="co">#       TRUE      FALSE      FALSE       TRUE      FALSE      FALSE      FALSE      FALSE      FALSE </span>
<span class="co">#        CON        WRT        TRA       FIRE        GOV        OTH        SUM </span>
<span class="co">#      FALSE      FALSE      FALSE      FALSE      FALSE      FALSE      FALSE</span></pre></div>
<p>Another <em>collapse</em> verb to mention here is <code>fsubset</code>, a faster alternative to <code><a href="https://dplyr.tidyverse.org/reference/filter.html">dplyr::filter</a></code> which also provides an option to flexibly subset columns after the select argument:</p>
<div class="sourceCode" id="cb13"><pre class="downlit">
<span class="co"># Two equivalent calls, the first is substantially faster</span>
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/fsubset.html">fsubset</a></span><span class="op">(</span><span class="va">Variable</span> <span class="op">==</span> <span class="st">"VA"</span> <span class="op">&amp;</span> <span class="va">Year</span> <span class="op">&gt;</span> <span class="fl">1990</span>, <span class="va">Country</span>, <span class="va">Year</span>, <span class="va">AGR</span><span class="op">:</span><span class="va">GOV</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span>
<span class="co"># # A tibble: 3 x 11</span>
<span class="co">#   Country  Year   AGR   MIN   MAN    PU   CON   WRT   TRA  FIRE   GOV</span>
<span class="co">#   &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co"># 1 BWA      1991  303. 2647.  473.  161.  580.  807.  233.  433. 1073.</span>
<span class="co"># 2 BWA      1992  333. 2691.  537.  178.  679.  725.  285.  517. 1234.</span>
<span class="co"># 3 BWA      1993  405. 2625.  567.  219.  634.  772.  350.  673. 1487.</span>

<span class="va">GGDC10S</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">Variable</span> <span class="op">==</span> <span class="st">"VA"</span> <span class="op">&amp;</span> <span class="va">Year</span> <span class="op">&gt;</span> <span class="fl">1990</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">Country</span>, <span class="va">Year</span>, <span class="va">AGR</span><span class="op">:</span><span class="va">GOV</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span>
<span class="co"># # A tibble: 3 x 11</span>
<span class="co">#   Country  Year   AGR   MIN   MAN    PU   CON   WRT   TRA  FIRE   GOV</span>
<span class="co">#   &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co"># 1 BWA      1991  303. 2647.  473.  161.  580.  807.  233.  433. 1073.</span>
<span class="co"># 2 BWA      1992  333. 2691.  537.  178.  679.  725.  285.  517. 1234.</span>
<span class="co"># 3 BWA      1993  405. 2625.  567.  219.  634.  772.  350.  673. 1487.</span></pre></div>
<p><em>collapse</em> also offers <code>roworder</code>, <code>frename</code>, <code>colorder</code> and <code>ftransform</code>/<code>TRA</code> as fast replacements for <code><a href="https://dplyr.tidyverse.org/reference/arrange.html">dplyr::arrange</a></code>, <code><a href="https://dplyr.tidyverse.org/reference/rename.html">dplyr::rename</a></code>, <code><a href="https://dplyr.tidyverse.org/reference/relocate.html">dplyr::relocate</a></code> and <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">dplyr::mutate</a></code>.</p>
</div>
<div id="multi-function-aggregations" class="section level3">
<h3 class="hasAnchor">
<a href="#multi-function-aggregations" class="anchor"></a>1.3 Multi-Function Aggregations</h3>
<p>One can also aggregate with multiple functions at the same time. For such operations it is often necessary to use curly braces <code>{</code> to prevent first argument injection so that <code>%&gt;% cbind(FUN1(.), FUN2(.))</code> does not evaluate as <code>%&gt;% cbind(., FUN1(.), FUN2(.))</code>:</p>
<div class="sourceCode" id="cb14"><pre class="downlit">
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">get_vars</a></span><span class="op">(</span><span class="fl">6</span><span class="op">:</span><span class="fl">16</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fu"><a href="../reference/fmedian.html">fmedian</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>,
          <span class="fu"><a href="../reference/AA2-small-helpers.html">add_stub</a></span><span class="op">(</span><span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="va">.</span>, keep.group_vars <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, <span class="st">"mean_"</span><span class="op">)</span><span class="op">)</span>
    <span class="op">}</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span>
<span class="co">#   Variable Country        AGR       MIN       MAN         PU        CON      WRT        TRA</span>
<span class="co"># 1      EMP     ARG  1324.5255  47.35255 1987.5912 104.738825  782.40283 1854.612  579.93982</span>
<span class="co"># 2      EMP     BOL   943.1612  53.53538  167.1502   4.457895   65.97904  132.225   96.96828</span>
<span class="co"># 3      EMP     BRA 17480.9810 225.43693 7207.7915 375.851832 4054.66103 6454.523 1580.81120</span>
<span class="co">#         FIRE      GOV       OTH       SUM   mean_AGR  mean_MIN  mean_MAN    mean_PU  mean_CON</span>
<span class="co"># 1  464.39920 1738.836  866.1119  9743.223  1419.8013  52.08903 1931.7602 101.720936  742.4044</span>
<span class="co"># 2   15.34259       NA  384.0678  1842.055   964.2103  56.03295  235.0332   5.346433  122.7827</span>
<span class="co"># 3 4354.86210 4449.942 4478.6927 51881.110 17191.3529 206.02389 6991.3710 364.573404 3524.7384</span>
<span class="co">#    mean_WRT  mean_TRA  mean_FIRE mean_GOV  mean_OTH  mean_SUM</span>
<span class="co"># 1 1982.1775  648.5119  627.79291 2043.471  992.4475 10542.177</span>
<span class="co"># 2  281.5164  115.4728   44.56442       NA  395.5650  2220.524</span>
<span class="co"># 3 8509.4612 2054.3731 4413.54448 5307.280 5710.2665 54272.985</span></pre></div>
<p>The function <code>add_stub</code> used above is a <em>collapse</em> function adding a prefix (default) or suffix to variables names. The <em>collapse</em> predicate <code>add_vars</code> provides a more efficient alternative to <code>cbind.data.frame</code>. The idea here is ‘adding’ variables to the data.frame in the first argument i.e. the attributes of the first argument are preserved, so the expression below still gives a tibble instead of a data.frame:</p>
<!-- A slightly more elegant solution to such multi-function aggregations can be found using `get_vars`, a collapse predicate to efficiently select variables. In contrast to `select_at`, `get_vars` does not automatically add the grouping columns to the selection. -->
<div class="sourceCode" id="cb15"><pre class="downlit">
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="op">{</span>
   <span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">add_vars</a></span><span class="op">(</span><span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">get_vars</a></span><span class="op">(</span><span class="va">.</span>, <span class="st">"Reg"</span>, regex <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">ffirst</span>, <span class="co"># Regular expression matching column names</span>
            <span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">num_vars</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span>keep.group_vars <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/AA2-small-helpers.html">add_stub</a></span><span class="op">(</span><span class="st">"mean_"</span><span class="op">)</span>, <span class="co"># num_vars selects all numeric variables</span>
            <span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">fselect</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">PU</span><span class="op">:</span><span class="va">TRA</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/fmedian.html">fmedian</a></span><span class="op">(</span>keep.group_vars <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/AA2-small-helpers.html">add_stub</a></span><span class="op">(</span><span class="st">"median_"</span><span class="op">)</span>, 
            <span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">fselect</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">PU</span><span class="op">:</span><span class="va">CON</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/fmin,%20fmax.html">fmin</a></span><span class="op">(</span>keep.group_vars <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/AA2-small-helpers.html">add_stub</a></span><span class="op">(</span><span class="st">"min_"</span><span class="op">)</span><span class="op">)</span>      
  <span class="op">}</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span>
<span class="co"># # A tibble: 3 x 22</span>
<span class="co">#   Variable Country Regioncode Region mean_Year mean_AGR mean_MIN mean_MAN mean_PU mean_CON mean_WRT</span>
<span class="co">#   &lt;chr&gt;    &lt;chr&gt;   &lt;chr&gt;      &lt;chr&gt;      &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;</span>
<span class="co"># 1 EMP      ARG     LAM        Latin~     1980.    1420.     52.1    1932.  102.       742.    1982.</span>
<span class="co"># 2 EMP      BOL     LAM        Latin~     1980      964.     56.0     235.    5.35     123.     282.</span>
<span class="co"># 3 EMP      BRA     LAM        Latin~     1980.   17191.    206.     6991.  365.      3525.    8509.</span>
<span class="co"># # ... with 11 more variables: mean_TRA &lt;dbl&gt;, mean_FIRE &lt;dbl&gt;, mean_GOV &lt;dbl&gt;, mean_OTH &lt;dbl&gt;,</span>
<span class="co"># #   mean_SUM &lt;dbl&gt;, median_PU &lt;dbl&gt;, median_CON &lt;dbl&gt;, median_WRT &lt;dbl&gt;, median_TRA &lt;dbl&gt;,</span>
<span class="co"># #   min_PU &lt;dbl&gt;, min_CON &lt;dbl&gt;</span></pre></div>
<p>Another nice feature of <code>add_vars</code> is that it can also very efficiently reorder columns i.e. bind columns in a different order than they are passed. This can be done by simply specifying the positions the added columns should have in the final data frame, and then <code>add_vars</code> shifts the first argument columns to the right to fill in the gaps.</p>
<div class="sourceCode" id="cb16"><pre class="downlit">
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/fsubset.html">fsubset</a></span><span class="op">(</span><span class="va">Variable</span> <span class="op">==</span> <span class="st">"VA"</span>, <span class="va">Country</span>, <span class="va">AGR</span>, <span class="va">SUM</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_by</a></span><span class="op">(</span><span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="op">{</span>
   <span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">add_vars</a></span><span class="op">(</span><span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_vars</a></span><span class="op">(</span><span class="va">.</span>,<span class="st">"unique"</span><span class="op">)</span>,
            <span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="va">.</span>, keep.group_vars <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/AA2-small-helpers.html">add_stub</a></span><span class="op">(</span><span class="st">"mean_"</span><span class="op">)</span>,
            <span class="fu"><a href="../reference/fvar,%20fsd.html">fsd</a></span><span class="op">(</span><span class="va">.</span>, keep.group_vars <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/AA2-small-helpers.html">add_stub</a></span><span class="op">(</span><span class="st">"sd_"</span><span class="op">)</span>, 
            pos <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">4</span>,<span class="fl">3</span>,<span class="fl">5</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span>
<span class="co"># # A tibble: 3 x 5</span>
<span class="co">#   Country mean_AGR sd_AGR mean_SUM  sd_SUM</span>
<span class="co">#   &lt;chr&gt;      &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;</span>
<span class="co"># 1 ARG       14951. 33061.  152534. 301316.</span>
<span class="co"># 2 BOL        3300.  4456.   22619.  33173.</span>
<span class="co"># 3 BRA       76870. 59442. 1200563. 976963.</span></pre></div>
<p>A much more compact solution to multi-function and multi-type aggregation is offered by the function <em>collapg</em>:</p>
<div class="sourceCode" id="cb17"><pre class="downlit">
<span class="co"># This aggregates numeric colums using the mean (fmean) and categorical columns with the mode (fmode)</span>
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">collapg</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span>
<span class="co"># # A tibble: 3 x 16</span>
<span class="co">#   Variable Country Regioncode Region  Year    AGR   MIN   MAN     PU   CON   WRT   TRA   FIRE   GOV</span>
<span class="co">#   &lt;chr&gt;    &lt;chr&gt;   &lt;chr&gt;      &lt;chr&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co"># 1 EMP      ARG     LAM        Latin~ 1980.  1420.  52.1 1932. 102.    742. 1982.  649.  628.  2043.</span>
<span class="co"># 2 EMP      BOL     LAM        Latin~ 1980    964.  56.0  235.   5.35  123.  282.  115.   44.6   NA </span>
<span class="co"># 3 EMP      BRA     LAM        Latin~ 1980. 17191. 206.  6991. 365.   3525. 8509. 2054. 4414.  5307.</span>
<span class="co"># # ... with 2 more variables: OTH &lt;dbl&gt;, SUM &lt;dbl&gt;</span></pre></div>
<p>By default it aggregates numeric columns using the <code>fmean</code> and categorical columns using <code>fmode</code>, and preserves the order of all columns. Changing these defaults is very easy:</p>
<div class="sourceCode" id="cb18"><pre class="downlit">
<span class="co"># This aggregates numeric colums using the median and categorical columns using the first value</span>
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/collap.html">collapg</a></span><span class="op">(</span><span class="va">fmedian</span>, <span class="va">flast</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span>
<span class="co"># # A tibble: 3 x 16</span>
<span class="co">#   Variable Country Regioncode Region  Year    AGR   MIN   MAN     PU    CON   WRT    TRA   FIRE</span>
<span class="co">#   &lt;chr&gt;    &lt;chr&gt;   &lt;chr&gt;      &lt;chr&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;</span>
<span class="co"># 1 EMP      ARG     LAM        Latin~ 1980.  1325.  47.4 1988. 105.    782.  1855.  580.   464. </span>
<span class="co"># 2 EMP      BOL     LAM        Latin~ 1980    943.  53.5  167.   4.46   66.0  132.   97.0   15.3</span>
<span class="co"># 3 EMP      BRA     LAM        Latin~ 1980. 17481. 225.  7208. 376.   4055.  6455. 1581.  4355. </span>
<span class="co"># # ... with 3 more variables: GOV &lt;dbl&gt;, OTH &lt;dbl&gt;, SUM &lt;dbl&gt;</span></pre></div>
<p>One can apply multiple functions to both numeric and/or categorical data:</p>
<div class="sourceCode" id="cb19"><pre class="downlit">
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/collap.html">collapg</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">fmean</span>, <span class="va">fmedian</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">first</span>, <span class="va">fmode</span>, <span class="va">flast</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span>
<span class="co"># # A tibble: 3 x 32</span>
<span class="co">#   Variable Country first.Regioncode fmode.Regioncode flast.Regioncode first.Region fmode.Region</span>
<span class="co">#   &lt;chr&gt;    &lt;chr&gt;   &lt;chr&gt;            &lt;chr&gt;            &lt;chr&gt;            &lt;chr&gt;        &lt;chr&gt;       </span>
<span class="co"># 1 EMP      ARG     LAM              LAM              LAM              Latin Ameri~ Latin Ameri~</span>
<span class="co"># 2 EMP      BOL     LAM              LAM              LAM              Latin Ameri~ Latin Ameri~</span>
<span class="co"># 3 EMP      BRA     LAM              LAM              LAM              Latin Ameri~ Latin Ameri~</span>
<span class="co"># # ... with 25 more variables: flast.Region &lt;chr&gt;, fmean.Year &lt;dbl&gt;, fmedian.Year &lt;dbl&gt;,</span>
<span class="co"># #   fmean.AGR &lt;dbl&gt;, fmedian.AGR &lt;dbl&gt;, fmean.MIN &lt;dbl&gt;, fmedian.MIN &lt;dbl&gt;, fmean.MAN &lt;dbl&gt;,</span>
<span class="co"># #   fmedian.MAN &lt;dbl&gt;, fmean.PU &lt;dbl&gt;, fmedian.PU &lt;dbl&gt;, fmean.CON &lt;dbl&gt;, fmedian.CON &lt;dbl&gt;,</span>
<span class="co"># #   fmean.WRT &lt;dbl&gt;, fmedian.WRT &lt;dbl&gt;, fmean.TRA &lt;dbl&gt;, fmedian.TRA &lt;dbl&gt;, fmean.FIRE &lt;dbl&gt;,</span>
<span class="co"># #   fmedian.FIRE &lt;dbl&gt;, fmean.GOV &lt;dbl&gt;, fmedian.GOV &lt;dbl&gt;, fmean.OTH &lt;dbl&gt;, fmedian.OTH &lt;dbl&gt;,</span>
<span class="co"># #   fmean.SUM &lt;dbl&gt;, fmedian.SUM &lt;dbl&gt;</span></pre></div>
<p>Applying multiple functions to only numeric (or only categorical) data allows return in a long format:</p>
<div class="sourceCode" id="cb20"><pre class="downlit">
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/collap.html">collapg</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">fmean</span>, <span class="va">fmedian</span><span class="op">)</span>, cols <span class="op">=</span> <span class="va">is.numeric</span>, return <span class="op">=</span> <span class="st">"long"</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span>
<span class="co"># # A tibble: 3 x 15</span>
<span class="co">#   Function Variable Country  Year    AGR   MIN   MAN     PU   CON   WRT   TRA   FIRE   GOV   OTH</span>
<span class="co">#   &lt;chr&gt;    &lt;chr&gt;    &lt;chr&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co"># 1 fmean    EMP      ARG     1980.  1420.  52.1 1932. 102.    742. 1982.  649.  628.  2043.  992.</span>
<span class="co"># 2 fmean    EMP      BOL     1980    964.  56.0  235.   5.35  123.  282.  115.   44.6   NA   396.</span>
<span class="co"># 3 fmean    EMP      BRA     1980. 17191. 206.  6991. 365.   3525. 8509. 2054. 4414.  5307. 5710.</span>
<span class="co"># # ... with 1 more variable: SUM &lt;dbl&gt;</span></pre></div>
<p>Finally, <code>collapg</code> also makes it very easy to apply aggregator functions to certain columns only:</p>
<div class="sourceCode" id="cb21"><pre class="downlit">
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/collap.html">collapg</a></span><span class="op">(</span>custom <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>fmean <span class="op">=</span> <span class="fl">6</span><span class="op">:</span><span class="fl">8</span>, fmedian <span class="op">=</span> <span class="fl">10</span><span class="op">:</span><span class="fl">12</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span>
<span class="co"># # A tibble: 3 x 8</span>
<span class="co">#   Variable Country    AGR   MIN   MAN    CON   WRT    TRA</span>
<span class="co">#   &lt;chr&gt;    &lt;chr&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;</span>
<span class="co"># 1 EMP      ARG      1420.  52.1 1932.  782.  1855.  580. </span>
<span class="co"># 2 EMP      BOL       964.  56.0  235.   66.0  132.   97.0</span>
<span class="co"># 3 EMP      BRA     17191. 206.  6991. 4055.  6455. 1581.</span></pre></div>
<p>To understand more about <code>collapg</code>, look it up in the documentation (<code><a href="../reference/collap.html">?collapg</a></code>).</p>
</div>
<div id="weighted-aggregations" class="section level3">
<h3 class="hasAnchor">
<a href="#weighted-aggregations" class="anchor"></a>1.4 Weighted Aggregations</h3>
<p>Weighted aggregations are possible with the functions <code>fsum, fprod, fmean, fmedian, fnth, fmode, fvar</code> and <code>fsd</code>. The implementation is such that by default (option <code>keep.w = TRUE</code>) these functions also aggregate the weights, so that further weighted computations can be performed on the aggregated data. <code>fprod</code> saves the product of the weights, whereas the other functions save the sum of the weights in a column next to the grouping variables. If <code>na.rm = TRUE</code> (the default), rows with missing weights are omitted from the computation.</p>
<div class="sourceCode" id="cb22"><pre class="downlit">
<span class="co"># This computes a frequency-weighted grouped standard-deviation, taking the total EMP / VA as weight</span>
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">fselect</a></span><span class="op">(</span><span class="va">AGR</span><span class="op">:</span><span class="va">SUM</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/fvar,%20fsd.html">fsd</a></span><span class="op">(</span><span class="va">SUM</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span>
<span class="co"># # A tibble: 3 x 13</span>
<span class="co">#   Variable Country  sum.SUM    AGR   MIN   MAN    PU   CON   WRT    TRA   FIRE   GOV   OTH</span>
<span class="co">#   &lt;chr&gt;    &lt;chr&gt;      &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co"># 1 EMP      ARG      653615.  225.   22.2  176. 20.5   285.  856.  195.   493.  1123.  506.</span>
<span class="co"># 2 EMP      BOL      135452.   99.7  17.1  168.  4.87  123.  324.   98.1   69.8   NA   258.</span>
<span class="co"># 3 EMP      BRA     3364925. 1587.   73.8 2952. 93.8  1861. 6285. 1306.  3003.  3621. 4257.</span>

<span class="co"># This computes a weighted grouped mode, taking the total EMP / VA as weight</span>
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">fselect</a></span><span class="op">(</span><span class="va">AGR</span><span class="op">:</span><span class="va">SUM</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/fmode.html">fmode</a></span><span class="op">(</span><span class="va">SUM</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span>
<span class="co"># # A tibble: 3 x 13</span>
<span class="co">#   Variable Country  sum.SUM    AGR   MIN    MAN    PU   CON    WRT   TRA   FIRE    GOV    OTH</span>
<span class="co">#   &lt;chr&gt;    &lt;chr&gt;      &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;</span>
<span class="co"># 1 EMP      ARG      653615.  1162. 127.   2164. 152.  1415.  3768. 1060.  1748.  4336.  1999.</span>
<span class="co"># 2 EMP      BOL      135452.   819.  37.6   604.  10.8  433.   893.  333.   321.    NA   1057.</span>
<span class="co"># 3 EMP      BRA     3364925. 16451. 313.  11841. 388.  8154. 21860. 5169. 12011. 12149. 14235.</span></pre></div>
<p>The weighted variance / standard deviation is currently only implemented with frequency weights. <!-- Reliability weights may be implemented in a future update of *collapse*, if this is a strongly requested feature. --></p>
<p>Weighted aggregations may also be performed with <code>collapg</code>. By default <code>fsum</code> is used to compute a sum of the weights, but it is also possible here to aggregate the weights with other functions:</p>
<div class="sourceCode" id="cb23"><pre class="downlit">
<span class="co"># This aggregates numeric colums using the weighted mean (the default) and categorical columns using the weighted mode (the default).</span>
<span class="co"># Weights (column SUM) are aggregated using both the sum and the maximum. </span>
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../reference/collap.html">collapg</a></span><span class="op">(</span>w <span class="op">=</span> <span class="va">SUM</span>, wFUN <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">fsum</span>, <span class="va">fmax</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span>
<span class="co"># # A tibble: 3 x 17</span>
<span class="co">#   Variable Country fsum.SUM fmax.SUM Regioncode Region  Year    AGR   MIN   MAN     PU   CON    WRT</span>
<span class="co">#   &lt;chr&gt;    &lt;chr&gt;      &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;</span>
<span class="co"># 1 EMP      ARG      653615.   17929. LAM        Latin~ 1985.  1361.  56.5 1935. 105.    811.  2217.</span>
<span class="co"># 2 EMP      BOL      135452.    4508. LAM        Latin~ 1987.   977.  57.9  296.   7.07  167.   400.</span>
<span class="co"># 3 EMP      BRA     3364925.  102572. LAM        Latin~ 1989. 17746. 238.  8466. 389.   4436. 11376.</span>
<span class="co"># # ... with 4 more variables: TRA &lt;dbl&gt;, FIRE &lt;dbl&gt;, GOV &lt;dbl&gt;, OTH &lt;dbl&gt;</span></pre></div>
<!-- Thus to aggregate the entire data and save the weights one would need to opt for a manual solution: -->
<!-- ```{r} -->
<!-- GGDC10S %>% -->
<!--   fgroup_by(Variable, Country) %>% { -->
<!--     add_vars(fmean(get_vars(., 6:16), SUM), -->
<!--              fmode(get_vars(., c(2:3,16)), SUM, keep.group_vars = FALSE), -->
<!--              pos = c(5, 2:3)) -->
<!--   } -->
<!-- ``` -->
<!-- <!-- ```{r} -->
<!-- <!-- GGDC10S %>%  -->
<!-- <!--   group_by(Variable, Country) %>% collapg(w = .$SUM) -->
<!-- ``` -->
</div>
</div>
<div id="fast-transformations" class="section level2">
<h2 class="hasAnchor">
<a href="#fast-transformations" class="anchor"></a>2. Fast Transformations</h2>
<p><em>collapse</em> also provides some fast transformations that significantly extend the scope and speed of manipulations that can be performed with <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">dplyr::mutate</a></code>. <!-- bring to *dplyr* in terms of grouped transformations. --></p>
<div id="fast-transform-and-compute-variables" class="section level3">
<h3 class="hasAnchor">
<a href="#fast-transform-and-compute-variables" class="anchor"></a>2.1 Fast Transform and Compute Variables</h3>
<p>The function <code>ftransform</code> can be used to manipulate columns in the same ways as <code>mutate</code>:</p>
<div class="sourceCode" id="cb24"><pre class="downlit">
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/fsubset.html">fsubset</a></span><span class="op">(</span><span class="va">Variable</span> <span class="op">==</span> <span class="st">"VA"</span>, <span class="va">Country</span>, <span class="va">Year</span>, <span class="va">AGR</span>, <span class="va">SUM</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/ftransform.html">ftransform</a></span><span class="op">(</span>AGR_perc <span class="op">=</span> <span class="va">AGR</span> <span class="op">/</span> <span class="va">SUM</span> <span class="op">*</span> <span class="fl">100</span>,  <span class="co"># Computing % of VA in Agriculture</span>
             AGR_mean <span class="op">=</span> <span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="va">AGR</span><span class="op">)</span>,       <span class="co"># Average Agricultural VA</span>
             AGR <span class="op">=</span> <span class="cn">NULL</span>, SUM <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">%&gt;%</span>  <span class="co"># Deleting columns AGR and SUM</span>
             <span class="va">head</span>
<span class="co"># # A tibble: 6 x 4</span>
<span class="co">#   Country  Year AGR_perc AGR_mean</span>
<span class="co">#   &lt;chr&gt;   &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;</span>
<span class="co"># 1 BWA      1960     NA   5137561.</span>
<span class="co"># 2 BWA      1961     NA   5137561.</span>
<span class="co"># 3 BWA      1962     NA   5137561.</span>
<span class="co"># 4 BWA      1963     NA   5137561.</span>
<span class="co"># 5 BWA      1964     43.5 5137561.</span>
<span class="co"># 6 BWA      1965     40.0 5137561.</span></pre></div>
<p>The modification brought by <code>ftransformv</code> enables transformations of groups of columns like <code><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">dplyr::mutate_at</a></code> and <code><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">dplyr::mutate_if</a></code>:</p>
<div class="sourceCode" id="cb25"><pre class="downlit">
<span class="co"># This replaces variables mpg, carb and wt by their log (.c turns expressions into character vectors)</span>
<span class="va">mtcars</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/ftransform.html">ftransformv</a></span><span class="op">(</span><span class="fu"><a href="../reference/AA2-small-helpers.html">.c</a></span><span class="op">(</span><span class="va">mpg</span>, <span class="va">carb</span>, <span class="va">wt</span><span class="op">)</span>, <span class="va">log</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">head</span>
<span class="co">#                        mpg cyl disp  hp drat        wt  qsec vs am gear      carb</span>
<span class="co"># Mazda RX4         3.044522   6  160 110 3.90 0.9631743 16.46  0  1    4 1.3862944</span>
<span class="co"># Mazda RX4 Wag     3.044522   6  160 110 3.90 1.0560527 17.02  0  1    4 1.3862944</span>
<span class="co"># Datsun 710        3.126761   4  108  93 3.85 0.8415672 18.61  1  1    4 0.0000000</span>
<span class="co"># Hornet 4 Drive    3.063391   6  258 110 3.08 1.1678274 19.44  1  0    3 0.0000000</span>
<span class="co"># Hornet Sportabout 2.928524   8  360 175 3.15 1.2354715 17.02  0  0    3 0.6931472</span>
<span class="co"># Valiant           2.895912   6  225 105 2.76 1.2412686 20.22  1  0    3 0.0000000</span>

<span class="co"># Logging numeric variables</span>
<span class="va">iris</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/ftransform.html">ftransformv</a></span><span class="op">(</span><span class="va">is.numeric</span>, <span class="va">log</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">head</span>
<span class="co">#   Sepal.Length Sepal.Width Petal.Length Petal.Width Species</span>
<span class="co"># 1     1.629241    1.252763    0.3364722  -1.6094379  setosa</span>
<span class="co"># 2     1.589235    1.098612    0.3364722  -1.6094379  setosa</span>
<span class="co"># 3     1.547563    1.163151    0.2623643  -1.6094379  setosa</span>
<span class="co"># 4     1.526056    1.131402    0.4054651  -1.6094379  setosa</span>
<span class="co"># 5     1.609438    1.280934    0.3364722  -1.6094379  setosa</span>
<span class="co"># 6     1.686399    1.360977    0.5306283  -0.9162907  setosa</span></pre></div>
<p>Instead of <code>column = value</code> type arguments, it is also possible to pass a single list of transformed variables to <code>ftransform</code>, which will be regarded in the same way as an evaluated list of <code>column = value</code> arguments. It can be used for more complex transformations:</p>
<div class="sourceCode" id="cb26"><pre class="downlit">
<span class="co"># Logging values and replacing generated Inf values</span>
<span class="va">mtcars</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/ftransform.html">ftransform</a></span><span class="op">(</span><span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">fselect</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">mpg</span>, <span class="va">cyl</span>, <span class="va">vs</span><span class="op">:</span><span class="va">gear</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">log</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">replace_Inf</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">head</span>
<span class="co">#                        mpg      cyl disp  hp drat    wt  qsec vs am     gear carb</span>
<span class="co"># Mazda RX4         3.044522 1.791759  160 110 3.90 2.620 16.46 NA  0 1.386294    4</span>
<span class="co"># Mazda RX4 Wag     3.044522 1.791759  160 110 3.90 2.875 17.02 NA  0 1.386294    4</span>
<span class="co"># Datsun 710        3.126761 1.386294  108  93 3.85 2.320 18.61  0  0 1.386294    1</span>
<span class="co"># Hornet 4 Drive    3.063391 1.791759  258 110 3.08 3.215 19.44  0 NA 1.098612    1</span>
<span class="co"># Hornet Sportabout 2.928524 2.079442  360 175 3.15 3.440 17.02 NA NA 1.098612    2</span>
<span class="co"># Valiant           2.895912 1.791759  225 105 2.76 3.460 20.22  0 NA 1.098612    1</span></pre></div>
<p>If only the computed columns need to be returned, <code>fcompute</code> provides an efficient alternative:</p>
<div class="sourceCode" id="cb27"><pre class="downlit">
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/fsubset.html">fsubset</a></span><span class="op">(</span><span class="va">Variable</span> <span class="op">==</span> <span class="st">"VA"</span>, <span class="va">Country</span>, <span class="va">Year</span>, <span class="va">AGR</span>, <span class="va">SUM</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/ftransform.html">fcompute</a></span><span class="op">(</span>AGR_perc <span class="op">=</span> <span class="va">AGR</span> <span class="op">/</span> <span class="va">SUM</span> <span class="op">*</span> <span class="fl">100</span>,
           AGR_mean <span class="op">=</span> <span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="va">AGR</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">head</span>
<span class="co"># # A tibble: 6 x 2</span>
<span class="co">#   AGR_perc AGR_mean</span>
<span class="co">#      &lt;dbl&gt;    &lt;dbl&gt;</span>
<span class="co"># 1     NA   5137561.</span>
<span class="co"># 2     NA   5137561.</span>
<span class="co"># 3     NA   5137561.</span>
<span class="co"># 4     NA   5137561.</span>
<span class="co"># 5     43.5 5137561.</span>
<span class="co"># 6     40.0 5137561.</span></pre></div>
<p><code>ftransform</code> and <code>fcompute</code> are an order of magnitude faster than <code>mutate</code>, but they do not support grouped computations using arbitrary functions. We will see that this is hardly a limitation as <em>collapse</em> provides very efficient and elegant alternative programming mechanisms…</p>
</div>
<div id="replacing-and-sweeping-out-statistics" class="section level3">
<h3 class="hasAnchor">
<a href="#replacing-and-sweeping-out-statistics" class="anchor"></a>2.2 Replacing and Sweeping out Statistics</h3>
<!-- using Fast Statistical Functions -->
<p>All statistical (scalar-valued) functions in the collapse package (<code>fsum, fprod, fmean, fmedian, fmode, fvar, fsd, fmin, fmax, fnth, ffirst, flast, fNobs, fNdistinct</code>) have a <code>TRA</code> argument which can be used to efficiently transform data by either (column-wise) replacing data values with computed statistics or sweeping the statistics out of the data. Operations can be specified using either an integer or quoted operator / string. The 10 operations supported by <code>TRA</code> are:</p>
<ul>
<li><p>1 - “replace_fill” : replace and overwrite missing values (same as <code>mutate</code>)</p></li>
<li><p>2 - “replace” : replace but preserve missing values</p></li>
<li><p>3 - “-” : subtract (center)</p></li>
<li><p>4 - “-+” : subtract group-statistics but add average of group statistics</p></li>
<li><p>5 - “/” : divide (scale)</p></li>
<li><p>6 - “%” : compute percentages (divide and multiply by 100)</p></li>
<li><p>7 - “+” : add</p></li>
<li><p>8 - "*" : multiply</p></li>
<li><p>9 - “%%” : modulus</p></li>
<li><p>10 - “-%%” : subtract modulus</p></li>
</ul>
<!-- For functions supporting weights (`fsum, fprod, fmean, fmode, fvar` and `fsd`) the `TRA` argument is in the third position following the data and weight vector (in the *grouped_df* method), whereas functions not supporting weights have the argument in the second position. --><p>Simple transformations are again straightforward to specify:</p>
<div class="sourceCode" id="cb28"><pre class="downlit">
<span class="co"># This subtracts the median value from all data points i.e. centers on the median</span>
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span> <span class="va">num_vars</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/fmedian.html">fmedian</a></span><span class="op">(</span>TRA <span class="op">=</span> <span class="st">"-"</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">head</span>
<span class="co"># # A tibble: 6 x 12</span>
<span class="co">#    Year    AGR   MIN    MAN    PU    CON    WRT    TRA  FIRE    GOV    OTH     SUM</span>
<span class="co">#   &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;</span>
<span class="co"># 1   -22    NA    NA     NA    NA     NA     NA     NA    NA     NA     NA      NA </span>
<span class="co"># 2   -21    NA    NA     NA    NA     NA     NA     NA    NA     NA     NA      NA </span>
<span class="co"># 3   -20    NA    NA     NA    NA     NA     NA     NA    NA     NA     NA      NA </span>
<span class="co"># 4   -19    NA    NA     NA    NA     NA     NA     NA    NA     NA     NA      NA </span>
<span class="co"># 5   -18 -4378. -170. -3717. -168. -1473. -3767. -1173. -959. -3924. -1431. -23149.</span>
<span class="co"># 6   -17 -4379. -171. -3717. -168. -1472. -3767. -1173. -959. -3923. -1430. -23147.</span>

<span class="co"># This replaces all data points with the mode</span>
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span> <span class="va">char_vars</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/fmode.html">fmode</a></span><span class="op">(</span>TRA <span class="op">=</span> <span class="st">"replace"</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">head</span>
<span class="co"># # A tibble: 6 x 4</span>
<span class="co">#   Country Regioncode Region Variable</span>
<span class="co">#   &lt;chr&gt;   &lt;chr&gt;      &lt;chr&gt;  &lt;chr&gt;   </span>
<span class="co"># 1 USA     ASI        Asia   EMP     </span>
<span class="co"># 2 USA     ASI        Asia   EMP     </span>
<span class="co"># 3 USA     ASI        Asia   EMP     </span>
<span class="co"># 4 USA     ASI        Asia   EMP     </span>
<span class="co"># 5 USA     ASI        Asia   EMP     </span>
<span class="co"># 6 USA     ASI        Asia   EMP</span></pre></div>
<p>Similarly for grouped transformations:</p>
<!-- We can also easily specify code to grouped demean, scale or compute percentages by groups: -->
<!-- ^[100% being the median of all annual VA/EMP values in a given sector and country across all years, not the sectoral output share which would have to be obtained using `sweep(GGDC10S[6:16], 1, GGDC10S$SUM, "/")`] -->
<div class="sourceCode" id="cb29"><pre class="downlit">
<span class="co"># Replacing data with the 2nd quartile (25%)</span>
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">fselect</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span>, <span class="va">AGR</span><span class="op">:</span><span class="va">SUM</span><span class="op">)</span> <span class="op">%&gt;%</span> 
   <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/fnth.html">fnth</a></span><span class="op">(</span><span class="fl">0.25</span>, TRA <span class="op">=</span> <span class="st">"replace_fill"</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span>
<span class="co"># # A tibble: 3 x 13</span>
<span class="co">#   Variable Country   AGR   MIN   MAN    PU   CON   WRT   TRA  FIRE   GOV   OTH   SUM</span>
<span class="co">#   &lt;chr&gt;    &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co"># 1 VA       BWA      61.3  21.7  23.1  6.31  23.2  26.7  8.98  11.3  27.0  10.1  220.</span>
<span class="co"># 2 VA       BWA      61.3  21.7  23.1  6.31  23.2  26.7  8.98  11.3  27.0  10.1  220.</span>
<span class="co"># 3 VA       BWA      61.3  21.7  23.1  6.31  23.2  26.7  8.98  11.3  27.0  10.1  220.</span>

<span class="co"># Scaling sectoral data by Variable and Country</span>
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">fselect</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span>, <span class="va">AGR</span><span class="op">:</span><span class="va">SUM</span><span class="op">)</span> <span class="op">%&gt;%</span> 
   <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/fvar,%20fsd.html">fsd</a></span><span class="op">(</span>TRA <span class="op">=</span> <span class="st">"/"</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">head</span>
<span class="co"># # A tibble: 6 x 13</span>
<span class="co">#   Variable Country     AGR      MIN      MAN       PU      CON      WRT      TRA     FIRE      GOV</span>
<span class="co">#   &lt;chr&gt;    &lt;chr&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;</span>
<span class="co"># 1 VA       BWA     NA      NA       NA       NA       NA       NA       NA       NA       NA      </span>
<span class="co"># 2 VA       BWA     NA      NA       NA       NA       NA       NA       NA       NA       NA      </span>
<span class="co"># 3 VA       BWA     NA      NA       NA       NA       NA       NA       NA       NA       NA      </span>
<span class="co"># 4 VA       BWA     NA      NA       NA       NA       NA       NA       NA       NA       NA      </span>
<span class="co"># 5 VA       BWA      0.0270  5.56e-4  5.23e-4  3.88e-4  5.11e-4  0.00194  0.00154  5.23e-4  0.00134</span>
<span class="co"># 6 VA       BWA      0.0260  3.97e-4  7.23e-4  5.03e-4  1.04e-3  0.00220  0.00180  5.83e-4  0.00158</span>
<span class="co"># # ... with 2 more variables: OTH &lt;dbl&gt;, SUM &lt;dbl&gt;</span></pre></div>
<!-- # Normalizing Data by expressing them in percentages of the median value within each country and sector (i.e. the median is 100%) -->
<!-- GGDC10S %>% -->
<!--   fselect(Variable, Country, AGR:SUM) %>%   -->
<!--    fgroup_by(Variable, Country) %>% fmedian(TRA = "%") %>% head(3) -->
<p>The benchmarks below will demonstrate that these internal sweeping and replacement operations fully performed in C++ compute significantly faster than using <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">dplyr::mutate</a></code>, especially as the number of groups grows large. The S3 generic nature of the <em>Fast Statistical Functions</em> further allows us to perform grouped mutations on the fly (together with <code>ftransform</code> or <code>fcompute</code>), without the need of first creating a grouped tibble:</p>
<div class="sourceCode" id="cb30"><pre class="downlit">
<span class="co"># AGR_gmed = TRUE if AGR is greater than it's median value, grouped by Variable and Country</span>
<span class="co"># Note: This calls fmedian.default</span>
<span class="fu"><a href="../reference/ftransform.html">settransform</a></span><span class="op">(</span><span class="va">GGDC10S</span>, AGR_gmed <span class="op">=</span> <span class="va">AGR</span> <span class="op">&gt;</span> <span class="fu"><a href="../reference/fmedian.html">fmedian</a></span><span class="op">(</span><span class="va">AGR</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span>, TRA <span class="op">=</span> <span class="st">"replace"</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span><span class="op">(</span><span class="va">GGDC10S</span>, <span class="fl">3</span><span class="op">)</span>
<span class="co"># # A tibble: 3 x 17</span>
<span class="co">#   Country Regioncode Region Variable  Year   AGR   MIN   MAN    PU   CON   WRT   TRA  FIRE   GOV</span>
<span class="co">#   &lt;chr&gt;   &lt;chr&gt;      &lt;chr&gt;  &lt;chr&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co"># 1 EGY     MENA       Middl~ EMP       2010 5206.  29.0 2436.  307. 2733. 2977. 1992.  801. 5539.</span>
<span class="co"># 2 EGY     MENA       Middl~ EMP       2011 5186.  27.6 2374.  318. 2795. 3020. 2048.  815. 5636.</span>
<span class="co"># 3 EGY     MENA       Middl~ EMP       2012 5161.  24.8 2348.  325. 2931. 3110. 2065.  832. 5736.</span>
<span class="co"># # ... with 3 more variables: OTH &lt;dbl&gt;, SUM &lt;dbl&gt;, AGR_gmed &lt;lgl&gt;</span>

<span class="co"># Dividing (scaling) the sectoral data (columns 6 through 16) by their grouped standard deviation</span>
<span class="fu"><a href="../reference/ftransform.html">settransformv</a></span><span class="op">(</span><span class="va">GGDC10S</span>, <span class="fl">6</span><span class="op">:</span><span class="fl">16</span>, <span class="va">fsd</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span>, TRA <span class="op">=</span> <span class="st">"/"</span>, apply <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span><span class="op">(</span><span class="va">GGDC10S</span>, <span class="fl">3</span><span class="op">)</span>
<span class="co"># # A tibble: 3 x 17</span>
<span class="co">#   Country Regioncode Region Variable  Year   AGR   MIN   MAN    PU   CON   WRT   TRA  FIRE   GOV</span>
<span class="co">#   &lt;chr&gt;   &lt;chr&gt;      &lt;chr&gt;  &lt;chr&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co"># 1 EGY     MENA       Middl~ EMP       2010  8.41  2.28  4.32  3.56  3.62  3.75  3.75  3.14  3.80</span>
<span class="co"># 2 EGY     MENA       Middl~ EMP       2011  8.38  2.17  4.21  3.68  3.70  3.81  3.86  3.19  3.86</span>
<span class="co"># 3 EGY     MENA       Middl~ EMP       2012  8.34  1.95  4.17  3.76  3.88  3.92  3.89  3.26  3.93</span>
<span class="co"># # ... with 3 more variables: OTH &lt;dbl&gt;, SUM &lt;dbl&gt;, AGR_gmed &lt;lgl&gt;</span>
<span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">GGDC10S</span><span class="op">)</span></pre></div>
<p>Weights are easily added to any grouped transformation:</p>
<div class="sourceCode" id="cb31"><pre class="downlit">
<span class="co"># This subtracts weighted group means from the data, using SUM column as weights.. </span>
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">fselect</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span>, <span class="va">AGR</span><span class="op">:</span><span class="va">SUM</span><span class="op">)</span> <span class="op">%&gt;%</span> 
   <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="va">SUM</span>, <span class="st">"-"</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">head</span>
<span class="co"># # A tibble: 6 x 13</span>
<span class="co">#   Variable Country   SUM    AGR     MIN    MAN    PU    CON    WRT    TRA   FIRE    GOV    OTH</span>
<span class="co">#   &lt;chr&gt;    &lt;chr&gt;   &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;</span>
<span class="co"># 1 VA       BWA      NA      NA      NA     NA    NA     NA     NA     NA     NA     NA     NA </span>
<span class="co"># 2 VA       BWA      NA      NA      NA     NA    NA     NA     NA     NA     NA     NA     NA </span>
<span class="co"># 3 VA       BWA      NA      NA      NA     NA    NA     NA     NA     NA     NA     NA     NA </span>
<span class="co"># 4 VA       BWA      NA      NA      NA     NA    NA     NA     NA     NA     NA     NA     NA </span>
<span class="co"># 5 VA       BWA      37.5 -1301. -13317. -2965. -529. -2746. -6540. -2157. -4431. -7551. -2613.</span>
<span class="co"># 6 VA       BWA      39.3 -1302. -13318. -2964. -529. -2745. -6540. -2156. -4431. -7550. -2613.</span></pre></div>
<!-- # Weighted scaling, weighted by SUM -->
<!-- GGDC10S %>% -->
<!--   fselect(Variable, Country, AGR:SUM) %>%  -->
<!--    fgroup_by(Variable, Country) %>% fsd(SUM, "/") %>% head(3) -->
<!-- Alternatively we could also replace data points with their groupwise weighted mean or standard deviation: -->
<!-- ```{r} -->
<!-- # This conducts a weighted between transformation (replacing with weighted mean) -->
<!-- GGDC10S %>% -->
<!--   fselect(Variable, Country, AGR:SUM) %>%  -->
<!--    fgroup_by(Variable, Country) %>% fmean(SUM, "replace") -->
<!-- # This also replaces missing values in each group -->
<!-- GGDC10S %>% -->
<!--   fselect(Variable, Country, AGR:SUM) %>%  -->
<!--    fgroup_by(Variable, Country) %>% fmean(SUM, "replace_fill") -->
<!-- ``` -->
<!-- It is also possible to center data points on the overall mean, which is achieved by subtracting out group means and adding the overall mean of the data again: -->
<!-- ```{r} -->
<!-- # This group-centers data on the overall mean of the data -->
<!-- GGDC10S %>% -->
<!--   group_by(Variable, Country) %>% -->
<!--     select_at(6:16) %>% fmean(TRA = "-+") -->
<!-- ``` -->
<p>Sequential operations are also easily performed:</p>
<div class="sourceCode" id="cb32"><pre class="downlit">
<span class="co"># This scales and then subtracts the median</span>
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">fselect</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span>, <span class="va">AGR</span><span class="op">:</span><span class="va">SUM</span><span class="op">)</span> <span class="op">%&gt;%</span> 
   <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/fvar,%20fsd.html">fsd</a></span><span class="op">(</span>TRA <span class="op">=</span> <span class="st">"/"</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/fmedian.html">fmedian</a></span><span class="op">(</span>TRA <span class="op">=</span> <span class="st">"-"</span><span class="op">)</span>
<span class="co"># # A tibble: 5,027 x 13</span>
<span class="co">#    Variable Country    AGR    MIN    MAN     PU    CON     WRT     TRA    FIRE    GOV     OTH    SUM</span>
<span class="co">#  * &lt;chr&gt;    &lt;chr&gt;    &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;</span>
<span class="co">#  1 VA       BWA     NA     NA     NA     NA     NA     NA      NA      NA      NA     NA      NA    </span>
<span class="co">#  2 VA       BWA     NA     NA     NA     NA     NA     NA      NA      NA      NA     NA      NA    </span>
<span class="co">#  3 VA       BWA     NA     NA     NA     NA     NA     NA      NA      NA      NA     NA      NA    </span>
<span class="co">#  4 VA       BWA     NA     NA     NA     NA     NA     NA      NA      NA      NA     NA      NA    </span>
<span class="co">#  5 VA       BWA     -0.182 -0.235 -0.183 -0.245 -0.118 -0.0820 -0.0724 -0.0661 -0.108 -0.0848 -0.146</span>
<span class="co">#  6 VA       BWA     -0.183 -0.235 -0.183 -0.245 -0.117 -0.0817 -0.0722 -0.0660 -0.108 -0.0846 -0.146</span>
<span class="co">#  7 VA       BWA     -0.180 -0.235 -0.183 -0.245 -0.117 -0.0813 -0.0720 -0.0659 -0.107 -0.0843 -0.145</span>
<span class="co">#  8 VA       BWA     -0.177 -0.235 -0.183 -0.245 -0.117 -0.0826 -0.0724 -0.0659 -0.107 -0.0841 -0.146</span>
<span class="co">#  9 VA       BWA     -0.174 -0.235 -0.183 -0.245 -0.117 -0.0823 -0.0717 -0.0661 -0.108 -0.0848 -0.146</span>
<span class="co"># 10 VA       BWA     -0.173 -0.234 -0.182 -0.243 -0.115 -0.0821 -0.0715 -0.0660 -0.108 -0.0846 -0.145</span>
<span class="co"># # ... with 5,017 more rows</span>
<span class="co"># </span>
<span class="co"># Grouped by:  Variable, Country  [85 | 59 (7.7)]</span></pre></div>
<p>Of course it is also possible to combine multiple functions as in the aggregation section, or to add variables to existing data:</p>
<div class="sourceCode" id="cb33"><pre class="downlit">
<span class="co"># This adds a groupwise observation count next to each column</span>
<span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">add_vars</a></span><span class="op">(</span><span class="va">GGDC10S</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">7</span>,<span class="fl">27</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">GGDC10S</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">fselect</a></span><span class="op">(</span><span class="va">AGR</span><span class="op">:</span><span class="va">SUM</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/fNobs.html">fNobs</a></span><span class="op">(</span><span class="st">"replace_fill"</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/AA2-small-helpers.html">add_stub</a></span><span class="op">(</span><span class="st">"N_"</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">GGDC10S</span><span class="op">)</span>
<span class="co"># # A tibble: 6 x 27</span>
<span class="co">#   Country Regioncode Region Variable  Year   AGR N_AGR   MIN N_MIN    MAN N_MAN     PU  N_PU    CON</span>
<span class="co">#   &lt;chr&gt;   &lt;chr&gt;      &lt;chr&gt;  &lt;chr&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt; &lt;int&gt;  &lt;dbl&gt; &lt;int&gt;  &lt;dbl&gt; &lt;int&gt;  &lt;dbl&gt;</span>
<span class="co"># 1 BWA     SSA        Sub-s~ VA        1960  NA      47 NA       47 NA        47 NA        47 NA    </span>
<span class="co"># 2 BWA     SSA        Sub-s~ VA        1961  NA      47 NA       47 NA        47 NA        47 NA    </span>
<span class="co"># 3 BWA     SSA        Sub-s~ VA        1962  NA      47 NA       47 NA        47 NA        47 NA    </span>
<span class="co"># 4 BWA     SSA        Sub-s~ VA        1963  NA      47 NA       47 NA        47 NA        47 NA    </span>
<span class="co"># 5 BWA     SSA        Sub-s~ VA        1964  16.3    47  3.49    47  0.737    47  0.104    47  0.660</span>
<span class="co"># 6 BWA     SSA        Sub-s~ VA        1965  15.7    47  2.50    47  1.02     47  0.135    47  1.35 </span>
<span class="co"># # ... with 13 more variables: N_CON &lt;int&gt;, WRT &lt;dbl&gt;, N_WRT &lt;int&gt;, TRA &lt;dbl&gt;, N_TRA &lt;int&gt;,</span>
<span class="co"># #   FIRE &lt;dbl&gt;, N_FIRE &lt;int&gt;, GOV &lt;dbl&gt;, N_GOV &lt;int&gt;, OTH &lt;dbl&gt;, N_OTH &lt;int&gt;, SUM &lt;dbl&gt;,</span>
<span class="co"># #   N_SUM &lt;int&gt;</span>
<span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">GGDC10S</span><span class="op">)</span></pre></div>
<p>There are lots of other examples one could construct using the 10 operations and 14 functions listed above, the examples provided just outline the suggested programming basics. Performance considerations make it very much worthwhile to spend some time and think how complex operations can be implemented in this programming framework, before defining some function in R and applying it to data using <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">dplyr::mutate</a></code>.</p>
<!-- ***could add add_vars example again*** -->
</div>
<div id="more-control-using-the-tra-function" class="section level3">
<h3 class="hasAnchor">
<a href="#more-control-using-the-tra-function" class="anchor"></a>2.3 More Control using the <code>TRA</code> Function</h3>
<p>Towards this end, calling <code><a href="../reference/TRA.html">TRA()</a></code> directly also facilitates more complex and customized operations. Behind the scenes of the <code>TRA = ...</code> argument, the <em>Fast Statistical Functions</em> first compute the grouped statistics on all columns of the data, and these statistics are then directly fed into a C++ function that uses them to replace or sweep them out of data points in one of the 10 ways described above. This function can also be called directly by the name of <code>TRA</code>. <!-- (shorthand for 'transforming' data by replacing or sweeping out statistics).  --></p>
<p>Fundamentally, <code>TRA</code> is a generalization of <code><a href="https://rdrr.io/r/base/sweep.html">base::sweep</a></code> for column-wise grouped operations<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>. Direct calls to <code>TRA</code> enable more control over inputs and outputs.</p>
<p>The two operations below are equivalent, although the first is slightly more efficient as it only requires one method dispatch and one check of the inputs:</p>
<div class="sourceCode" id="cb34"><pre class="downlit">
<span class="co"># This divides by the product</span>
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">get_vars</a></span><span class="op">(</span><span class="fl">6</span><span class="op">:</span><span class="fl">16</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/fprod.html">fprod</a></span><span class="op">(</span>TRA <span class="op">=</span> <span class="st">"/"</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">head</span>
<span class="co"># # A tibble: 6 x 11</span>
<span class="co">#          AGR        MIN        MAN        PU        CON        WRT       TRA      FIRE        GOV</span>
<span class="co">#        &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt;</span>
<span class="co"># 1 NA         NA         NA         NA        NA         NA         NA        NA        NA        </span>
<span class="co"># 2 NA         NA         NA         NA        NA         NA         NA        NA        NA        </span>
<span class="co"># 3 NA         NA         NA         NA        NA         NA         NA        NA        NA        </span>
<span class="co"># 4 NA         NA         NA         NA        NA         NA         NA        NA        NA        </span>
<span class="co"># 5  1.29e-105  2.81e-127  1.40e-101  4.44e-74  4.19e-102  3.97e-113  6.91e-92  1.01e-97  2.51e-117</span>
<span class="co"># 6  1.24e-105  2.00e-127  1.94e-101  5.75e-74  8.55e-102  4.49e-113  8.08e-92  1.13e-97  2.96e-117</span>
<span class="co"># # ... with 2 more variables: OTH &lt;dbl&gt;, SUM &lt;dbl&gt;</span>

<span class="co"># Same thing</span>
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">get_vars</a></span><span class="op">(</span><span class="fl">6</span><span class="op">:</span><span class="fl">16</span><span class="op">)</span> <span class="op">%&gt;%</span> 
     <span class="fu"><a href="../reference/TRA.html">TRA</a></span><span class="op">(</span><span class="fu"><a href="../reference/fprod.html">fprod</a></span><span class="op">(</span><span class="va">.</span>, keep.group_vars <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, <span class="st">"/"</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">head</span> <span class="co"># [same as TRA(.,fprod(., keep.group_vars = FALSE),"/")]</span>
<span class="co"># # A tibble: 6 x 11</span>
<span class="co">#          AGR        MIN        MAN        PU        CON        WRT       TRA      FIRE        GOV</span>
<span class="co">#        &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt;</span>
<span class="co"># 1 NA         NA         NA         NA        NA         NA         NA        NA        NA        </span>
<span class="co"># 2 NA         NA         NA         NA        NA         NA         NA        NA        NA        </span>
<span class="co"># 3 NA         NA         NA         NA        NA         NA         NA        NA        NA        </span>
<span class="co"># 4 NA         NA         NA         NA        NA         NA         NA        NA        NA        </span>
<span class="co"># 5  1.29e-105  2.81e-127  1.40e-101  4.44e-74  4.19e-102  3.97e-113  6.91e-92  1.01e-97  2.51e-117</span>
<span class="co"># 6  1.24e-105  2.00e-127  1.94e-101  5.75e-74  8.55e-102  4.49e-113  8.08e-92  1.13e-97  2.96e-117</span>
<span class="co"># # ... with 2 more variables: OTH &lt;dbl&gt;, SUM &lt;dbl&gt;</span></pre></div>
<p><code>TRA.grouped_df</code> was designed such that it matches the columns of the statistics (aggregated columns) to those of the original data, and only transforms matching columns while returning the whole data frame. Thus it is easily possible to only apply a transformation to the first two sectors:</p>
<div class="sourceCode" id="cb35"><pre class="downlit">
<span class="co"># This only demeans Agriculture (AGR) and Mining (MIN)</span>
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/TRA.html">TRA</a></span><span class="op">(</span><span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">fselect</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">AGR</span>, <span class="va">MIN</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span>keep.group_vars <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, <span class="st">"-"</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">head</span>
<span class="co"># # A tibble: 6 x 16</span>
<span class="co">#   Country Regioncode Region Variable  Year   AGR    MIN    MAN     PU    CON   WRT   TRA  FIRE   GOV</span>
<span class="co">#   &lt;chr&gt;   &lt;chr&gt;      &lt;chr&gt;  &lt;chr&gt;    &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co"># 1 BWA     SSA        Sub-s~ VA        1960   NA     NA  NA     NA     NA     NA    NA    NA    NA   </span>
<span class="co"># 2 BWA     SSA        Sub-s~ VA        1961   NA     NA  NA     NA     NA     NA    NA    NA    NA   </span>
<span class="co"># 3 BWA     SSA        Sub-s~ VA        1962   NA     NA  NA     NA     NA     NA    NA    NA    NA   </span>
<span class="co"># 4 BWA     SSA        Sub-s~ VA        1963   NA     NA  NA     NA     NA     NA    NA    NA    NA   </span>
<span class="co"># 5 BWA     SSA        Sub-s~ VA        1964 -446. -4505.  0.737  0.104  0.660  6.24  1.66  1.12  4.82</span>
<span class="co"># 6 BWA     SSA        Sub-s~ VA        1965 -446. -4506.  1.02   0.135  1.35   7.06  1.94  1.25  5.70</span>
<span class="co"># # ... with 2 more variables: OTH &lt;dbl&gt;, SUM &lt;dbl&gt;</span></pre></div>
<p>Since <code>TRA</code> is already built into all <em>Fast Statistical Functions</em> as an argument, it is best used in computations where grouped statistics are computed using some other function.</p>
<div class="sourceCode" id="cb36"><pre class="downlit">
<span class="co"># Same as above, with one line of code using fmean.data.frame and ftransform...</span>
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/ftransform.html">ftransform</a></span><span class="op">(</span><span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>AGR <span class="op">=</span> <span class="va">AGR</span>, MIN <span class="op">=</span> <span class="va">MIN</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span>, TRA <span class="op">=</span> <span class="st">"-"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">head</span>
<span class="co"># # A tibble: 6 x 16</span>
<span class="co">#   Country Regioncode Region Variable  Year   AGR    MIN    MAN     PU    CON   WRT   TRA  FIRE   GOV</span>
<span class="co">#   &lt;chr&gt;   &lt;chr&gt;      &lt;chr&gt;  &lt;chr&gt;    &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co"># 1 BWA     SSA        Sub-s~ VA        1960   NA     NA  NA     NA     NA     NA    NA    NA    NA   </span>
<span class="co"># 2 BWA     SSA        Sub-s~ VA        1961   NA     NA  NA     NA     NA     NA    NA    NA    NA   </span>
<span class="co"># 3 BWA     SSA        Sub-s~ VA        1962   NA     NA  NA     NA     NA     NA    NA    NA    NA   </span>
<span class="co"># 4 BWA     SSA        Sub-s~ VA        1963   NA     NA  NA     NA     NA     NA    NA    NA    NA   </span>
<span class="co"># 5 BWA     SSA        Sub-s~ VA        1964 -446. -4505.  0.737  0.104  0.660  6.24  1.66  1.12  4.82</span>
<span class="co"># 6 BWA     SSA        Sub-s~ VA        1965 -446. -4506.  1.02   0.135  1.35   7.06  1.94  1.25  5.70</span>
<span class="co"># # ... with 2 more variables: OTH &lt;dbl&gt;, SUM &lt;dbl&gt;</span></pre></div>
<!-- # Get grouped tibble -->
<!-- gGGDC <- GGDC10S %>% group_by(Variable, Country) -->
<!-- library(microbenchmark) -->
<!-- microbenchmark(TRA = gGGDC %>% TRA(summarise_at(., c("AGR","SUM"), sum, na.rm = TRUE), "replace_fill"), -->
<!--                mutate = gGGDC %>% mutate_at(c("AGR","SUM"), sum, na.rm = TRUE)) -->
<p>Another potential use of <code>TRA</code> is to do computations in two- or more steps, for example if both aggregated and transformed data are needed, or if computations are more complex and involve other manipulations in-between the aggregating and sweeping part:</p>
<div class="sourceCode" id="cb37"><pre class="downlit">
<span class="co"># Get grouped tibble</span>
<span class="va">gGGDC</span> <span class="op">&lt;-</span> <span class="va">GGDC10S</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span>

<span class="co"># Get aggregated data</span>
<span class="va">gsumGGDC</span> <span class="op">&lt;-</span> <span class="va">gGGDC</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">fselect</a></span><span class="op">(</span><span class="va">AGR</span><span class="op">:</span><span class="va">SUM</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">fsum</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">gsumGGDC</span><span class="op">)</span>
<span class="co"># # A tibble: 6 x 13</span>
<span class="co">#   Variable Country     AGR     MIN     MAN     PU     CON    WRT    TRA   FIRE     GOV    OTH    SUM</span>
<span class="co">#   &lt;chr&gt;    &lt;chr&gt;     &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;</span>
<span class="co"># 1 EMP      ARG      8.80e4   3230.  1.20e5  6307.  4.60e4 1.23e5 4.02e4 3.89e4  1.27e5 6.15e4 6.54e5</span>
<span class="co"># 2 EMP      BOL      5.88e4   3418.  1.43e4   326.  7.49e3 1.72e4 7.04e3 2.72e3 NA      2.41e4 1.35e5</span>
<span class="co"># 3 EMP      BRA      1.07e6  12773.  4.33e5 22604.  2.19e5 5.28e5 1.27e5 2.74e5  3.29e5 3.54e5 3.36e6</span>
<span class="co"># 4 EMP      BWA      8.84e3    493.  8.49e2   145.  1.19e3 1.71e3 3.93e2 7.21e2  2.87e3 1.30e3 1.85e4</span>
<span class="co"># 5 EMP      CHL      4.42e4   6389.  3.94e4  1850.  1.86e4 4.38e4 1.63e4 1.72e4 NA      6.32e4 2.51e5</span>
<span class="co"># 6 EMP      CHN      1.73e7 422972.  4.03e6 96364.  1.25e6 1.73e6 8.36e5 2.96e5  1.36e6 1.86e6 2.91e7</span>

<span class="co"># Get transformed (scaled) data</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fu"><a href="../reference/TRA.html">TRA</a></span><span class="op">(</span><span class="va">gGGDC</span>, <span class="va">gsumGGDC</span>, <span class="st">"/"</span><span class="op">)</span><span class="op">)</span>
<span class="co"># # A tibble: 6 x 16</span>
<span class="co">#   Country Regioncode Region Variable  Year      AGR      MIN      MAN       PU      CON      WRT</span>
<span class="co">#   &lt;chr&gt;   &lt;chr&gt;      &lt;chr&gt;  &lt;chr&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;</span>
<span class="co"># 1 BWA     SSA        Sub-s~ VA        1960 NA       NA       NA       NA       NA       NA      </span>
<span class="co"># 2 BWA     SSA        Sub-s~ VA        1961 NA       NA       NA       NA       NA       NA      </span>
<span class="co"># 3 BWA     SSA        Sub-s~ VA        1962 NA       NA       NA       NA       NA       NA      </span>
<span class="co"># 4 BWA     SSA        Sub-s~ VA        1963 NA       NA       NA       NA       NA       NA      </span>
<span class="co"># 5 BWA     SSA        Sub-s~ VA        1964  7.50e-4  1.65e-5  1.66e-5  1.03e-5  1.57e-5  6.82e-5</span>
<span class="co"># 6 BWA     SSA        Sub-s~ VA        1965  7.24e-4  1.18e-5  2.30e-5  1.33e-5  3.20e-5  7.72e-5</span>
<span class="co"># # ... with 5 more variables: TRA &lt;dbl&gt;, FIRE &lt;dbl&gt;, GOV &lt;dbl&gt;, OTH &lt;dbl&gt;, SUM &lt;dbl&gt;</span></pre></div>
<p>As discussed, whether using the argument to fast statistical functions or <code>TRA</code> directly, these data transformations are essentially a two-step process: Statistics are first computed and then used to transform the original data.</p>
<!-- This process is already very efficient since all functions are written in C++, and programmatically separating the computation of statistics and data transformation tasks allows for unlimited combinations and drastically simplifies the code base of this package. -->
<!-- Nonetheless there are of course more memory efficient and faster ways to program such data transformations, which principally involve doing them column-by-column with a single C++ function.  -->
<p>Although both steps are efficiently done in C++, it would be even more efficient to do them in a single step without materializing all the statistics before transforming the data. Such slightly more efficient functions are provided for the very commonly applied tasks of centering and averaging data by groups (widely known as ‘between’-group and ‘within’-group transformations), and scaling and centering data by groups (also known as ‘standardizing’ data).</p>
<!-- To ensure that this *collapse* lives up to the highest standards of performance for common uses, it also provides ... -->
</div>
<div id="faster-centering-averaging-and-standardizing" class="section level3">
<h3 class="hasAnchor">
<a href="#faster-centering-averaging-and-standardizing" class="anchor"></a>2.4 Faster Centering, Averaging and Standardizing</h3>
<!-- Between and Within Transformations and Standardization -->
<p>The functions <code>fbetween</code> and <code>fwithin</code> are slightly more memory efficient implementations of <code>fmean</code> invoked with different <code>TRA</code> options:</p>
<div class="sourceCode" id="cb38"><pre class="downlit">
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span> <span class="co"># Same as ... %&gt;% fmean(TRA = "replace")</span>
  <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">get_vars</a></span><span class="op">(</span><span class="fl">6</span><span class="op">:</span><span class="fl">16</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">fbetween</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>
<span class="co"># # A tibble: 2 x 11</span>
<span class="co">#     AGR   MIN   MAN    PU   CON   WRT   TRA  FIRE   GOV   OTH    SUM</span>
<span class="co">#   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;</span>
<span class="co"># 1 4444.  34.9 1614.  131.  997. 1307.  799.  320. 2958.    NA 12605.</span>
<span class="co"># 2 4444.  34.9 1614.  131.  997. 1307.  799.  320. 2958.    NA 12605.</span>

<span class="va">GGDC10S</span> <span class="op">%&gt;%</span> <span class="co"># Same as ... %&gt;% fmean(TRA = "replace_fill")</span>
  <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">get_vars</a></span><span class="op">(</span><span class="fl">6</span><span class="op">:</span><span class="fl">16</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/fbetween,%20fwithin.html">fbetween</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>
<span class="co"># # A tibble: 2 x 11</span>
<span class="co">#     AGR   MIN   MAN    PU   CON   WRT   TRA  FIRE   GOV   OTH    SUM</span>
<span class="co">#   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;</span>
<span class="co"># 1 4444.  34.9 1614.  131.  997. 1307.  799.  320. 2958.    NA 12605.</span>
<span class="co"># 2 4444.  34.9 1614.  131.  997. 1307.  799.  320. 2958.    NA 12605.</span>

<span class="va">GGDC10S</span> <span class="op">%&gt;%</span> <span class="co"># Same as ... %&gt;% fmean(TRA = "-")</span>
  <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">get_vars</a></span><span class="op">(</span><span class="fl">6</span><span class="op">:</span><span class="fl">16</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">fwithin</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>
<span class="co"># # A tibble: 2 x 11</span>
<span class="co">#     AGR    MIN   MAN    PU   CON   WRT   TRA  FIRE   GOV   OTH   SUM</span>
<span class="co">#   &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co"># 1  742.  -7.35  760.  187. 1798. 1713. 1249.  495. 2678.    NA 9614.</span>
<span class="co"># 2  717. -10.1   734.  194. 1934. 1803. 1266.  512. 2778.    NA 9928.</span></pre></div>
<p>Apart from higher speed, <code>fwithin</code> has a <code>mean</code> argument to assign an arbitrary mean to centered data, the default being <code>mean = 0</code>. A very common choice for such an added mean is just the overall mean of the data, which can be added in by invoking <code>mean = "overall.mean"</code>:</p>
<div class="sourceCode" id="cb39"><pre class="downlit">
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">fselect</a></span><span class="op">(</span><span class="va">Country</span>, <span class="va">Variable</span>, <span class="va">AGR</span><span class="op">:</span><span class="va">SUM</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/fbetween,%20fwithin.html">fwithin</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="st">"overall.mean"</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span>
<span class="co"># # A tibble: 3 x 13</span>
<span class="co">#   Country Variable     AGR     MIN     MAN      PU     CON     WRT    TRA   FIRE    GOV   OTH    SUM</span>
<span class="co">#   &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;</span>
<span class="co"># 1 EGY     EMP       2.53e6  1.87e6  5.54e6 335856.  1.80e6  3.39e6 1.47e6 1.66e6 1.71e6    NA 2.16e7</span>
<span class="co"># 2 EGY     EMP       2.53e6  1.87e6  5.54e6 335867.  1.80e6  3.39e6 1.47e6 1.66e6 1.71e6    NA 2.16e7</span>
<span class="co"># 3 EGY     EMP       2.53e6  1.87e6  5.54e6 335873.  1.80e6  3.39e6 1.47e6 1.66e6 1.72e6    NA 2.16e7</span></pre></div>
<!-- in particular, which regards the joint use of weights and the `mean = "overall.mean"` option: `... %>% fmean(w = SUM, TRA = "-+")` will not properly group-center the data on the overall weighted mean. Instead, it will group-center data on a frequency weighted average of the weighted group-means, thus not taking into account different aggregated weights attached to those weighted group-means themselves. The reason for this shortcoming is simply that `TRA` was not designed to take a separate weight vector as input. `fwithin(w = SUM, mean = "overall.mean")` does a better job and properly centers data on the weighted overall mean after subtracting out weighted group means: -->
<!-- ```{r} -->
<!-- GGDC10S %>% # This does not center data on a properly computed weighted overall mean -->
<!--   group_by(Variable, Country) %>% select_at(6:16) %>% fmean(SUM, TRA = "-+") -->
<!-- GGDC10S %>% # This does a proper job by both subtracting weighted group-means and adding a weighted overall mean -->
<!--   group_by(Variable, Country) %>% select_at(6:16) %>% fwithin(SUM, mean = "overall.mean") -->
<!-- ``` -->
<p>This can also be done using weights. The code below uses the <code>SUM</code> column as weights, and then for each variable and each group subtracts out the weighted mean, and then adds the overall weighted column mean back to the centered columns. The <code>SUM</code> column is just kept as it is and added after the grouping columns.</p>
<div class="sourceCode" id="cb40"><pre class="downlit">
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">fselect</a></span><span class="op">(</span><span class="va">Country</span>, <span class="va">Variable</span>, <span class="va">AGR</span><span class="op">:</span><span class="va">SUM</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/fbetween,%20fwithin.html">fwithin</a></span><span class="op">(</span><span class="va">SUM</span>, mean <span class="op">=</span> <span class="st">"overall.mean"</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span>
<span class="co"># # A tibble: 3 x 13</span>
<span class="co">#   Country Variable    SUM     AGR     MIN     MAN      PU     CON     WRT    TRA   FIRE    GOV   OTH</span>
<span class="co">#   &lt;chr&gt;   &lt;chr&gt;     &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co"># 1 EGY     EMP      22020.  4.29e8  3.70e8  7.38e8  2.73e7  2.83e8  4.33e8 1.97e8 1.55e8 2.10e8    NA</span>
<span class="co"># 2 EGY     EMP      22219.  4.29e8  3.70e8  7.38e8  2.73e7  2.83e8  4.33e8 1.97e8 1.55e8 2.10e8    NA</span>
<span class="co"># 3 EGY     EMP      22533.  4.29e8  3.70e8  7.38e8  2.73e7  2.83e8  4.33e8 1.97e8 1.55e8 2.10e8    NA</span></pre></div>
<p>Another argument to <code>fwithin</code> is the <code>theta</code> parameter, allowing partial- or quasi-demeaning operations, e.g. <code><a href="../reference/fbetween,%20fwithin.html">fwithin(gdata, theta = theta)</a></code> is equal to <code>gdata - theta * fbetween(gdata)</code>. This is particularly useful to prepare data for variance components (also known as ‘random-effects’) estimation.</p>
<p>Apart from <code>fbetween</code> and <code>fwithin</code>, the function <code>fscale</code> exists to efficiently scale and center data, to avoid sequential calls such as <code>... %&gt;% fsd(TRA = "/") %&gt;% fmean(TRA = "-")</code>.</p>
<div class="sourceCode" id="cb41"><pre class="downlit">
<span class="co"># This efficiently scales and centers (i.e. standardizes) the data</span>
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">fselect</a></span><span class="op">(</span><span class="va">Country</span>, <span class="va">Variable</span>, <span class="va">AGR</span><span class="op">:</span><span class="va">SUM</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">fscale</span>
<span class="co"># # A tibble: 5,027 x 13</span>
<span class="co">#    Country Variable    AGR    MIN    MAN     PU    CON    WRT    TRA   FIRE    GOV    OTH    SUM</span>
<span class="co">#  * &lt;chr&gt;   &lt;chr&gt;     &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;</span>
<span class="co">#  1 BWA     VA       NA     NA     NA     NA     NA     NA     NA     NA     NA     NA     NA    </span>
<span class="co">#  2 BWA     VA       NA     NA     NA     NA     NA     NA     NA     NA     NA     NA     NA    </span>
<span class="co">#  3 BWA     VA       NA     NA     NA     NA     NA     NA     NA     NA     NA     NA     NA    </span>
<span class="co">#  4 BWA     VA       NA     NA     NA     NA     NA     NA     NA     NA     NA     NA     NA    </span>
<span class="co">#  5 BWA     VA       -0.738 -0.717 -0.668 -0.805 -0.692 -0.603 -0.589 -0.635 -0.656 -0.596 -0.676</span>
<span class="co">#  6 BWA     VA       -0.739 -0.717 -0.668 -0.805 -0.692 -0.603 -0.589 -0.635 -0.656 -0.596 -0.676</span>
<span class="co">#  7 BWA     VA       -0.736 -0.717 -0.668 -0.805 -0.692 -0.603 -0.589 -0.635 -0.656 -0.595 -0.676</span>
<span class="co">#  8 BWA     VA       -0.734 -0.717 -0.668 -0.805 -0.692 -0.604 -0.589 -0.635 -0.655 -0.595 -0.676</span>
<span class="co">#  9 BWA     VA       -0.730 -0.717 -0.668 -0.805 -0.692 -0.604 -0.588 -0.635 -0.656 -0.596 -0.676</span>
<span class="co"># 10 BWA     VA       -0.729 -0.716 -0.667 -0.803 -0.690 -0.603 -0.588 -0.635 -0.656 -0.596 -0.675</span>
<span class="co"># # ... with 5,017 more rows</span>
<span class="co"># </span>
<span class="co"># Grouped by:  Variable, Country  [85 | 59 (7.7)]</span></pre></div>
<p><code>fscale</code> also has additional <code>mean</code> and <code>sd</code> arguments allowing the user to (group-) scale data to an arbitrary mean and standard deviation. Setting <code>mean = FALSE</code> just scales the data but preserves the means, and is thus different from <code><a href="../reference/fvar,%20fsd.html">fsd(..., TRA = "/")</a></code> which simply divides all values by the standard deviation:</p>
<div class="sourceCode" id="cb42"><pre class="downlit">
<span class="co"># Saving grouped tibble</span>
<span class="va">gGGDC</span> <span class="op">&lt;-</span> <span class="va">GGDC10S</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">fselect</a></span><span class="op">(</span><span class="va">Country</span>, <span class="va">Variable</span>, <span class="va">AGR</span><span class="op">:</span><span class="va">SUM</span><span class="op">)</span>

<span class="co"># Original means</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="va">gGGDC</span><span class="op">)</span><span class="op">)</span> 
<span class="co"># # A tibble: 6 x 13</span>
<span class="co">#   Variable Country     AGR    MIN     MAN      PU     CON    WRT    TRA   FIRE     GOV    OTH    SUM</span>
<span class="co">#   &lt;chr&gt;    &lt;chr&gt;     &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;</span>
<span class="co"># 1 EMP      ARG       1420.   52.1  1932.   102.     742.  1.98e3 6.49e2  628.   2043.  9.92e2 1.05e4</span>
<span class="co"># 2 EMP      BOL        964.   56.0   235.     5.35   123.  2.82e2 1.15e2   44.6    NA   3.96e2 2.22e3</span>
<span class="co"># 3 EMP      BRA      17191.  206.   6991.   365.    3525.  8.51e3 2.05e3 4414.   5307.  5.71e3 5.43e4</span>
<span class="co"># 4 EMP      BWA        188.   10.5    18.1    3.09    25.3 3.63e1 8.36e0   15.3    61.1 2.76e1 3.94e2</span>
<span class="co"># 5 EMP      CHL        702.  101.    625.    29.4    296.  6.95e2 2.58e2  272.     NA   1.00e3 3.98e3</span>
<span class="co"># 6 EMP      CHN     287744. 7050.  67144.  1606.   20852.  2.89e4 1.39e4 4929.  22669.  3.10e4 4.86e5</span>

<span class="co"># Mean Preserving Scaling</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="fu"><a href="../reference/fscale.html">fscale</a></span><span class="op">(</span><span class="va">gGGDC</span>, mean <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="co"># # A tibble: 6 x 13</span>
<span class="co">#   Variable Country     AGR    MIN     MAN      PU     CON    WRT    TRA   FIRE     GOV    OTH    SUM</span>
<span class="co">#   &lt;chr&gt;    &lt;chr&gt;     &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;</span>
<span class="co"># 1 EMP      ARG       1420.   52.1  1932.   102.     742.  1.98e3 6.49e2  628.   2043.  9.92e2 1.05e4</span>
<span class="co"># 2 EMP      BOL        964.   56.0   235.     5.35   123.  2.82e2 1.15e2   44.6    NA   3.96e2 2.22e3</span>
<span class="co"># 3 EMP      BRA      17191.  206.   6991.   365.    3525.  8.51e3 2.05e3 4414.   5307.  5.71e3 5.43e4</span>
<span class="co"># 4 EMP      BWA        188.   10.5    18.1    3.09    25.3 3.63e1 8.36e0   15.3    61.1 2.76e1 3.94e2</span>
<span class="co"># 5 EMP      CHL        702.  101.    625.    29.4    296.  6.95e2 2.58e2  272.     NA   1.00e3 3.98e3</span>
<span class="co"># 6 EMP      CHN     287744. 7050.  67144.  1606.   20852.  2.89e4 1.39e4 4929.  22669.  3.10e4 4.86e5</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fu"><a href="../reference/fvar,%20fsd.html">fsd</a></span><span class="op">(</span><span class="fu"><a href="../reference/fscale.html">fscale</a></span><span class="op">(</span><span class="va">gGGDC</span>, mean <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="co"># # A tibble: 6 x 13</span>
<span class="co">#   Variable Country   AGR   MIN   MAN    PU   CON   WRT   TRA  FIRE   GOV   OTH   SUM</span>
<span class="co">#   &lt;chr&gt;    &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co"># 1 EMP      ARG      1.    1.    1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.  </span>
<span class="co"># 2 EMP      BOL      1.    1.00  1.    1.00  1.00  1.    1.    1.   NA     1.    1.  </span>
<span class="co"># 3 EMP      BRA      1.    1.    1.    1.00  1.    1.00  1.00  1.00  1.    1.00  1.00</span>
<span class="co"># 4 EMP      BWA      1.00  1.00  1.    1.    1.    1.00  1.    1.00  1.    1.00  1.00</span>
<span class="co"># 5 EMP      CHL      1.    1.    1.00  1.    1.    1.    1.00  1.   NA     1.    1.00</span>
<span class="co"># 6 EMP      CHN      1.    1.    1.    1.00  1.00  1.    1.    1.    1.00  1.00  1.</span></pre></div>
<p>One can also set <code>mean = "overall.mean"</code>, which group-centers columns on the overall mean as illustrated with <code>fwithin</code>. Another interesting option is setting <code>sd = "within.sd"</code>. This group-scales data such that every group has a standard deviation equal to the within-standard deviation of the data:</p>
<div class="sourceCode" id="cb43"><pre class="downlit">
<span class="co"># Just using VA data for this example</span>
<span class="va">gGGDC</span> <span class="op">&lt;-</span> <span class="va">GGDC10S</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/fsubset.html">fsubset</a></span><span class="op">(</span><span class="va">Variable</span> <span class="op">==</span> <span class="st">"VA"</span>, <span class="va">Country</span>, <span class="va">AGR</span><span class="op">:</span><span class="va">SUM</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_by</a></span><span class="op">(</span><span class="va">Country</span><span class="op">)</span>

<span class="co"># This calculates the within- standard deviation for all columns</span>
<span class="fu"><a href="../reference/fvar,%20fsd.html">fsd</a></span><span class="op">(</span><span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">num_vars</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="fu"><a href="../reference/fbetween,%20fwithin.html">fwithin</a></span><span class="op">(</span><span class="va">gGGDC</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="co">#       AGR       MIN       MAN        PU       CON       WRT       TRA      FIRE       GOV       OTH </span>
<span class="co">#  45046972  40122220  75608708   3062688  30811572  44125207  20676901  16030868  20358973  18780869 </span>
<span class="co">#       SUM </span>
<span class="co"># 306429102</span>

<span class="co"># This scales all groups to take on the within- standard deviation while preserving group means </span>
<span class="fu"><a href="../reference/fvar,%20fsd.html">fsd</a></span><span class="op">(</span><span class="fu"><a href="../reference/fscale.html">fscale</a></span><span class="op">(</span><span class="va">gGGDC</span>, mean <span class="op">=</span> <span class="cn">FALSE</span>, sd <span class="op">=</span> <span class="st">"within.sd"</span><span class="op">)</span><span class="op">)</span>
<span class="co"># # A tibble: 43 x 12</span>
<span class="co">#    Country      AGR      MIN      MAN     PU     CON     WRT     TRA    FIRE     GOV     OTH     SUM</span>
<span class="co">#    &lt;chr&gt;      &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;</span>
<span class="co">#  1 ARG       4.50e7   4.01e7   7.56e7 3.06e6  3.08e7  4.41e7  2.07e7  1.60e7  2.04e7  1.88e7  3.06e8</span>
<span class="co">#  2 BOL       4.50e7   4.01e7   7.56e7 3.06e6  3.08e7  4.41e7  2.07e7  1.60e7 NA       1.88e7  3.06e8</span>
<span class="co">#  3 BRA       4.50e7   4.01e7   7.56e7 3.06e6  3.08e7  4.41e7  2.07e7  1.60e7  2.04e7  1.88e7  3.06e8</span>
<span class="co">#  4 BWA       4.50e7   4.01e7   7.56e7 3.06e6  3.08e7  4.41e7  2.07e7  1.60e7  2.04e7  1.88e7  3.06e8</span>
<span class="co">#  5 CHL       4.50e7   4.01e7   7.56e7 3.06e6  3.08e7  4.41e7  2.07e7  1.60e7 NA       1.88e7  3.06e8</span>
<span class="co">#  6 CHN       4.50e7   4.01e7   7.56e7 3.06e6  3.08e7  4.41e7  2.07e7  1.60e7  2.04e7  1.88e7  3.06e8</span>
<span class="co">#  7 COL       4.50e7   4.01e7   7.56e7 3.06e6  3.08e7  4.41e7  2.07e7  1.60e7 NA       1.88e7  3.06e8</span>
<span class="co">#  8 CRI       4.50e7   4.01e7   7.56e7 3.06e6  3.08e7  4.41e7  2.07e7  1.60e7  2.04e7  1.88e7  3.06e8</span>
<span class="co">#  9 DEW       4.50e7   4.01e7   7.56e7 3.06e6  3.08e7  4.41e7  2.07e7  1.60e7  2.04e7  1.88e7  3.06e8</span>
<span class="co"># 10 DNK       4.50e7   4.01e7   7.56e7 3.06e6  3.08e7  4.41e7  2.07e7  1.60e7  2.04e7  1.88e7  3.06e8</span>
<span class="co"># # ... with 33 more rows</span></pre></div>
<p>A grouped scaling operation with both <code>mean = "overall.mean"</code> and <code>sd = "within.sd"</code> thus efficiently achieves a harmonization of all groups in the first two moments without changing the fundamental properties (in terms of level and scale) of the data.</p>
</div>
<div id="lags-leads-differences-and-growth-rates" class="section level3">
<h3 class="hasAnchor">
<a href="#lags-leads-differences-and-growth-rates" class="anchor"></a>2.5 Lags / Leads, Differences and Growth Rates</h3>
<!-- It was suggested some time ago that leaving the best wine for the end is not the best strategy when giving a feast. Considering the marriage of *collapse* and *dplyr* the 3 functions for time-computations introduced in this section combine great flexibility with precision and computing power, and feature amongst the highlights of *collapse*. -->
<p>This section introduces 3 further powerful <em>collapse</em> functions: <code>flag</code>, <code>fdiff</code> and <code>fgrowth</code>. The first function, <code>flag</code>, efficiently computes sequences of fully identified lags and leads on time series and panel data. The following code computes 1 fully-identified panel-lag and 1 fully identified panel-lead of each variable in the data:</p>
<!-- In addition: None of these functions require the data to be sorted, they can carry out fast computations on completely unordered data as long as a time-variable is supplied that uniquely identifies the data. -->
<div class="sourceCode" id="cb44"><pre class="downlit">
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">fselect</a></span><span class="op">(</span><span class="op">-</span><span class="va">Region</span>, <span class="op">-</span><span class="va">Regioncode</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/flag.html">flag</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">:</span><span class="fl">1</span>, <span class="va">Year</span><span class="op">)</span>
<span class="co"># # A tibble: 5,027 x 36</span>
<span class="co">#    Country Variable  Year F1.AGR   AGR L1.AGR F1.MIN   MIN L1.MIN F1.MAN    MAN L1.MAN  F1.PU     PU</span>
<span class="co">#  * &lt;chr&gt;   &lt;chr&gt;    &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;</span>
<span class="co">#  1 BWA     VA        1960   NA    NA     NA    NA    NA     NA    NA     NA     NA     NA     NA    </span>
<span class="co">#  2 BWA     VA        1961   NA    NA     NA    NA    NA     NA    NA     NA     NA     NA     NA    </span>
<span class="co">#  3 BWA     VA        1962   NA    NA     NA    NA    NA     NA    NA     NA     NA     NA     NA    </span>
<span class="co">#  4 BWA     VA        1963   16.3  NA     NA     3.49 NA     NA     0.737 NA     NA      0.104 NA    </span>
<span class="co">#  5 BWA     VA        1964   15.7  16.3   NA     2.50  3.49  NA     1.02   0.737 NA      0.135  0.104</span>
<span class="co">#  6 BWA     VA        1965   17.7  15.7   16.3   1.97  2.50   3.49  0.804  1.02   0.737  0.203  0.135</span>
<span class="co">#  7 BWA     VA        1966   19.1  17.7   15.7   2.30  1.97   2.50  0.938  0.804  1.02   0.203  0.203</span>
<span class="co">#  8 BWA     VA        1967   21.1  19.1   17.7   1.84  2.30   1.97  0.750  0.938  0.804  0.203  0.203</span>
<span class="co">#  9 BWA     VA        1968   21.9  21.1   19.1   5.24  1.84   2.30  2.14   0.750  0.938  0.578  0.203</span>
<span class="co"># 10 BWA     VA        1969   23.1  21.9   21.1  10.2   5.24   1.84  4.15   2.14   0.750  1.12   0.578</span>
<span class="co"># # ... with 5,017 more rows, and 22 more variables: L1.PU &lt;dbl&gt;, F1.CON &lt;dbl&gt;, CON &lt;dbl&gt;,</span>
<span class="co"># #   L1.CON &lt;dbl&gt;, F1.WRT &lt;dbl&gt;, WRT &lt;dbl&gt;, L1.WRT &lt;dbl&gt;, F1.TRA &lt;dbl&gt;, TRA &lt;dbl&gt;, L1.TRA &lt;dbl&gt;,</span>
<span class="co"># #   F1.FIRE &lt;dbl&gt;, FIRE &lt;dbl&gt;, L1.FIRE &lt;dbl&gt;, F1.GOV &lt;dbl&gt;, GOV &lt;dbl&gt;, L1.GOV &lt;dbl&gt;, F1.OTH &lt;dbl&gt;,</span>
<span class="co"># #   OTH &lt;dbl&gt;, L1.OTH &lt;dbl&gt;, F1.SUM &lt;dbl&gt;, SUM &lt;dbl&gt;, L1.SUM &lt;dbl&gt;</span>
<span class="co"># </span>
<span class="co"># Grouped by:  Variable, Country  [85 | 59 (7.7)]</span></pre></div>
<p>If the time-variable passed does not exactly identify the data (i.e. because of repeated values in each group), all 3 functions will issue appropriate error messages. <code>flag</code>, <code>fdiff</code> and <code>fgrowth</code> support irregular time series and unbalanced panels. <!-- with different start and end periods and duration of coverage for each individual, but not irregular panels. A workaround for such panels exists with the function `seqid` which generates a new panel-id identifying consecutive time-sequences at the sub-individual level, see `?seqid`. --></p>
<p>It is also possible to omit the time-variable if one is certain that the data is sorted:</p>
<div class="sourceCode" id="cb45"><pre class="downlit">
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">fselect</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span>,<span class="va">AGR</span><span class="op">:</span><span class="va">SUM</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">flag</span>
<span class="co"># # A tibble: 5,027 x 13</span>
<span class="co">#    Variable Country   AGR   MIN    MAN     PU    CON   WRT   TRA  FIRE   GOV   OTH   SUM</span>
<span class="co">#  * &lt;chr&gt;    &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co">#  1 VA       BWA      NA   NA    NA     NA     NA     NA    NA    NA    NA    NA     NA  </span>
<span class="co">#  2 VA       BWA      NA   NA    NA     NA     NA     NA    NA    NA    NA    NA     NA  </span>
<span class="co">#  3 VA       BWA      NA   NA    NA     NA     NA     NA    NA    NA    NA    NA     NA  </span>
<span class="co">#  4 VA       BWA      NA   NA    NA     NA     NA     NA    NA    NA    NA    NA     NA  </span>
<span class="co">#  5 VA       BWA      NA   NA    NA     NA     NA     NA    NA    NA    NA    NA     NA  </span>
<span class="co">#  6 VA       BWA      16.3  3.49  0.737  0.104  0.660  6.24  1.66  1.12  4.82  2.34  37.5</span>
<span class="co">#  7 VA       BWA      15.7  2.50  1.02   0.135  1.35   7.06  1.94  1.25  5.70  2.68  39.3</span>
<span class="co">#  8 VA       BWA      17.7  1.97  0.804  0.203  1.35   8.27  2.15  1.36  6.37  2.99  43.1</span>
<span class="co">#  9 VA       BWA      19.1  2.30  0.938  0.203  0.897  4.31  1.72  1.54  7.04  3.31  41.4</span>
<span class="co"># 10 VA       BWA      21.1  1.84  0.750  0.203  1.22   5.17  2.44  1.03  5.03  2.36  41.1</span>
<span class="co"># # ... with 5,017 more rows</span>
<span class="co"># </span>
<span class="co"># Grouped by:  Variable, Country  [85 | 59 (7.7)]</span></pre></div>
<p><code>fdiff</code> computes sequences of lagged-leaded and iterated differences as well as quasi-differences and log-differences on time series and panel data. The code below computes the 1 and 10 year first and second differences of each variable in the data:</p>
<div class="sourceCode" id="cb46"><pre class="downlit">
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">fselect</a></span><span class="op">(</span><span class="op">-</span><span class="va">Region</span>, <span class="op">-</span><span class="va">Regioncode</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/fdiff.html">fdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="va">Year</span><span class="op">)</span>
<span class="co"># # A tibble: 5,027 x 47</span>
<span class="co">#    Country Variable  Year D1.AGR D2.AGR L10D1.AGR L10D2.AGR D1.MIN D2.MIN L10D1.MIN L10D2.MIN D1.MAN</span>
<span class="co">#  * &lt;chr&gt;   &lt;chr&gt;    &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;</span>
<span class="co">#  1 BWA     VA        1960 NA     NA            NA        NA NA     NA            NA        NA NA    </span>
<span class="co">#  2 BWA     VA        1961 NA     NA            NA        NA NA     NA            NA        NA NA    </span>
<span class="co">#  3 BWA     VA        1962 NA     NA            NA        NA NA     NA            NA        NA NA    </span>
<span class="co">#  4 BWA     VA        1963 NA     NA            NA        NA NA     NA            NA        NA NA    </span>
<span class="co">#  5 BWA     VA        1964 NA     NA            NA        NA NA     NA            NA        NA NA    </span>
<span class="co">#  6 BWA     VA        1965 -0.575 NA            NA        NA -0.998 NA            NA        NA  0.282</span>
<span class="co">#  7 BWA     VA        1966  1.95   2.53         NA        NA -0.525  0.473        NA        NA -0.214</span>
<span class="co">#  8 BWA     VA        1967  1.47  -0.488        NA        NA  0.328  0.854        NA        NA  0.134</span>
<span class="co">#  9 BWA     VA        1968  1.95   0.488        NA        NA -0.460 -0.788        NA        NA -0.188</span>
<span class="co"># 10 BWA     VA        1969  0.763 -1.19         NA        NA  3.41   3.87         NA        NA  1.39 </span>
<span class="co"># # ... with 5,017 more rows, and 35 more variables: D2.MAN &lt;dbl&gt;, L10D1.MAN &lt;dbl&gt;, L10D2.MAN &lt;dbl&gt;,</span>
<span class="co"># #   D1.PU &lt;dbl&gt;, D2.PU &lt;dbl&gt;, L10D1.PU &lt;dbl&gt;, L10D2.PU &lt;dbl&gt;, D1.CON &lt;dbl&gt;, D2.CON &lt;dbl&gt;,</span>
<span class="co"># #   L10D1.CON &lt;dbl&gt;, L10D2.CON &lt;dbl&gt;, D1.WRT &lt;dbl&gt;, D2.WRT &lt;dbl&gt;, L10D1.WRT &lt;dbl&gt;, L10D2.WRT &lt;dbl&gt;,</span>
<span class="co"># #   D1.TRA &lt;dbl&gt;, D2.TRA &lt;dbl&gt;, L10D1.TRA &lt;dbl&gt;, L10D2.TRA &lt;dbl&gt;, D1.FIRE &lt;dbl&gt;, D2.FIRE &lt;dbl&gt;,</span>
<span class="co"># #   L10D1.FIRE &lt;dbl&gt;, L10D2.FIRE &lt;dbl&gt;, D1.GOV &lt;dbl&gt;, D2.GOV &lt;dbl&gt;, L10D1.GOV &lt;dbl&gt;,</span>
<span class="co"># #   L10D2.GOV &lt;dbl&gt;, D1.OTH &lt;dbl&gt;, D2.OTH &lt;dbl&gt;, L10D1.OTH &lt;dbl&gt;, L10D2.OTH &lt;dbl&gt;, D1.SUM &lt;dbl&gt;,</span>
<span class="co"># #   D2.SUM &lt;dbl&gt;, L10D1.SUM &lt;dbl&gt;, L10D2.SUM &lt;dbl&gt;</span>
<span class="co"># </span>
<span class="co"># Grouped by:  Variable, Country  [85 | 59 (7.7)]</span></pre></div>
<p>Log-differences of the form <span class="math inline">\(log(x_t) - log(x_{t-s})\)</span> are also easily computed.</p>
<div class="sourceCode" id="cb47"><pre class="downlit">
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">fselect</a></span><span class="op">(</span><span class="op">-</span><span class="va">Region</span>, <span class="op">-</span><span class="va">Regioncode</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/fdiff.html">fdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span>, <span class="fl">1</span>, <span class="va">Year</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co"># # A tibble: 5,027 x 25</span>
<span class="co">#    Country Variable  Year Dlog1.AGR L10Dlog1.AGR Dlog1.MIN L10Dlog1.MIN Dlog1.MAN L10Dlog1.MAN</span>
<span class="co">#  * &lt;chr&gt;   &lt;chr&gt;    &lt;dbl&gt;     &lt;dbl&gt;        &lt;dbl&gt;     &lt;dbl&gt;        &lt;dbl&gt;     &lt;dbl&gt;        &lt;dbl&gt;</span>
<span class="co">#  1 BWA     VA        1960   NA                NA    NA               NA    NA               NA</span>
<span class="co">#  2 BWA     VA        1961   NA                NA    NA               NA    NA               NA</span>
<span class="co">#  3 BWA     VA        1962   NA                NA    NA               NA    NA               NA</span>
<span class="co">#  4 BWA     VA        1963   NA                NA    NA               NA    NA               NA</span>
<span class="co">#  5 BWA     VA        1964   NA                NA    NA               NA    NA               NA</span>
<span class="co">#  6 BWA     VA        1965   -0.0359           NA    -0.336           NA     0.324           NA</span>
<span class="co">#  7 BWA     VA        1966    0.117            NA    -0.236           NA    -0.236           NA</span>
<span class="co">#  8 BWA     VA        1967    0.0796           NA     0.154           NA     0.154           NA</span>
<span class="co">#  9 BWA     VA        1968    0.0972           NA    -0.223           NA    -0.223           NA</span>
<span class="co"># 10 BWA     VA        1969    0.0355           NA     1.05            NA     1.05            NA</span>
<span class="co"># # ... with 5,017 more rows, and 16 more variables: Dlog1.PU &lt;dbl&gt;, L10Dlog1.PU &lt;dbl&gt;,</span>
<span class="co"># #   Dlog1.CON &lt;dbl&gt;, L10Dlog1.CON &lt;dbl&gt;, Dlog1.WRT &lt;dbl&gt;, L10Dlog1.WRT &lt;dbl&gt;, Dlog1.TRA &lt;dbl&gt;,</span>
<span class="co"># #   L10Dlog1.TRA &lt;dbl&gt;, Dlog1.FIRE &lt;dbl&gt;, L10Dlog1.FIRE &lt;dbl&gt;, Dlog1.GOV &lt;dbl&gt;, L10Dlog1.GOV &lt;dbl&gt;,</span>
<span class="co"># #   Dlog1.OTH &lt;dbl&gt;, L10Dlog1.OTH &lt;dbl&gt;, Dlog1.SUM &lt;dbl&gt;, L10Dlog1.SUM &lt;dbl&gt;</span>
<span class="co"># </span>
<span class="co"># Grouped by:  Variable, Country  [85 | 59 (7.7)]</span></pre></div>
<p>Finally, it is also possible to compute quasi-differences and quasi-log-differences of the form <span class="math inline">\(x_t - \rho x_{t-s}\)</span> or <span class="math inline">\(log(x_t) - \rho log(x_{t-s})\)</span>:</p>
<div class="sourceCode" id="cb48"><pre class="downlit">
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">fselect</a></span><span class="op">(</span><span class="op">-</span><span class="va">Region</span>, <span class="op">-</span><span class="va">Regioncode</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/fdiff.html">fdiff</a></span><span class="op">(</span>t <span class="op">=</span> <span class="va">Year</span>, rho <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span>
<span class="co"># # A tibble: 5,027 x 14</span>
<span class="co">#    Country Variable  Year    AGR    MIN    MAN      PU     CON    WRT    TRA   FIRE    GOV    OTH</span>
<span class="co">#  * &lt;chr&gt;   &lt;chr&gt;    &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;</span>
<span class="co">#  1 BWA     VA        1960 NA     NA     NA     NA      NA      NA     NA     NA     NA     NA    </span>
<span class="co">#  2 BWA     VA        1961 NA     NA     NA     NA      NA      NA     NA     NA     NA     NA    </span>
<span class="co">#  3 BWA     VA        1962 NA     NA     NA     NA      NA      NA     NA     NA     NA     NA    </span>
<span class="co">#  4 BWA     VA        1963 NA     NA     NA     NA      NA      NA     NA     NA     NA     NA    </span>
<span class="co">#  5 BWA     VA        1964 NA     NA     NA     NA      NA      NA     NA     NA     NA     NA    </span>
<span class="co">#  6 BWA     VA        1965  0.241 -0.824  0.318  0.0359  0.719   1.13   0.363  0.184  1.11   0.454</span>
<span class="co">#  7 BWA     VA        1966  2.74  -0.401 -0.163  0.0743  0.0673  1.56   0.312  0.174  0.955  0.449</span>
<span class="co">#  8 BWA     VA        1967  2.35   0.427  0.174  0.0101 -0.381  -3.55  -0.323  0.246  0.988  0.465</span>
<span class="co">#  9 BWA     VA        1968  2.91  -0.345 -0.141  0.0101  0.365   1.08   0.804 -0.427 -1.66  -0.780</span>
<span class="co"># 10 BWA     VA        1969  1.82   3.50   1.43   0.385   2.32    0.841  0.397  0.252  0.818  0.385</span>
<span class="co"># # ... with 5,017 more rows, and 1 more variable: SUM &lt;dbl&gt;</span>
<span class="co"># </span>
<span class="co"># Grouped by:  Variable, Country  [85 | 59 (7.7)]</span></pre></div>
<p>The quasi-differencing feature was added to <code>fdiff</code> to facilitate the preparation of time series and panel data for least-squares estimations suffering from serial correlation following Cochrane &amp; Orcutt (1949).</p>
<!-- and `fgrowth` computes lagged-leaded and iterated growth-rates obtained via the exact computation method or through log-differencing.  -->
<p>Finally, <code>fgrowth</code> computes growth rates in the same way. By default exact growth rates are computed in percentage terms using <span class="math inline">\((x_t-x_{t-s}) / x_{t-s} \times 100\)</span> (the default argument is <code>scale = 100</code>). The user can also request growth rates obtained by log-differencing using <span class="math inline">\(log(x_t/ x_{t-s}) \times 100\)</span>.</p>
<div class="sourceCode" id="cb49"><pre class="downlit">
<span class="co"># Exact growth rates, computed as: (x/lag(x) - 1) * 100</span>
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">fselect</a></span><span class="op">(</span><span class="op">-</span><span class="va">Region</span>, <span class="op">-</span><span class="va">Regioncode</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/fgrowth.html">fgrowth</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span>, <span class="fl">1</span>, <span class="va">Year</span><span class="op">)</span>
<span class="co"># # A tibble: 5,027 x 25</span>
<span class="co">#    Country Variable  Year G1.AGR L10G1.AGR G1.MIN L10G1.MIN G1.MAN L10G1.MAN G1.PU L10G1.PU G1.CON</span>
<span class="co">#  * &lt;chr&gt;   &lt;chr&gt;    &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;</span>
<span class="co">#  1 BWA     VA        1960  NA           NA   NA          NA   NA          NA  NA         NA   NA  </span>
<span class="co">#  2 BWA     VA        1961  NA           NA   NA          NA   NA          NA  NA         NA   NA  </span>
<span class="co">#  3 BWA     VA        1962  NA           NA   NA          NA   NA          NA  NA         NA   NA  </span>
<span class="co">#  4 BWA     VA        1963  NA           NA   NA          NA   NA          NA  NA         NA   NA  </span>
<span class="co">#  5 BWA     VA        1964  NA           NA   NA          NA   NA          NA  NA         NA   NA  </span>
<span class="co">#  6 BWA     VA        1965  -3.52        NA  -28.6        NA   38.2        NA  29.4       NA  104. </span>
<span class="co">#  7 BWA     VA        1966  12.4         NA  -21.1        NA  -21.1        NA  50.0       NA    0  </span>
<span class="co">#  8 BWA     VA        1967   8.29        NA   16.7        NA   16.7        NA   0         NA  -33.3</span>
<span class="co">#  9 BWA     VA        1968  10.2         NA  -20          NA  -20          NA   0         NA   35.7</span>
<span class="co"># 10 BWA     VA        1969   3.61        NA  185.         NA  185.         NA 185.        NA  185. </span>
<span class="co"># # ... with 5,017 more rows, and 13 more variables: L10G1.CON &lt;dbl&gt;, G1.WRT &lt;dbl&gt;, L10G1.WRT &lt;dbl&gt;,</span>
<span class="co"># #   G1.TRA &lt;dbl&gt;, L10G1.TRA &lt;dbl&gt;, G1.FIRE &lt;dbl&gt;, L10G1.FIRE &lt;dbl&gt;, G1.GOV &lt;dbl&gt;, L10G1.GOV &lt;dbl&gt;,</span>
<span class="co"># #   G1.OTH &lt;dbl&gt;, L10G1.OTH &lt;dbl&gt;, G1.SUM &lt;dbl&gt;, L10G1.SUM &lt;dbl&gt;</span>
<span class="co"># </span>
<span class="co"># Grouped by:  Variable, Country  [85 | 59 (7.7)]</span>

<span class="co"># Log-difference growth rates, computed as: log(x / lag(x)) * 100</span>
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">fselect</a></span><span class="op">(</span><span class="op">-</span><span class="va">Region</span>, <span class="op">-</span><span class="va">Regioncode</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/fgrowth.html">fgrowth</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span>, <span class="fl">1</span>, <span class="va">Year</span>, logdiff <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co"># # A tibble: 5,027 x 25</span>
<span class="co">#    Country Variable  Year Dlog1.AGR L10Dlog1.AGR Dlog1.MIN L10Dlog1.MIN Dlog1.MAN L10Dlog1.MAN</span>
<span class="co">#  * &lt;chr&gt;   &lt;chr&gt;    &lt;dbl&gt;     &lt;dbl&gt;        &lt;dbl&gt;     &lt;dbl&gt;        &lt;dbl&gt;     &lt;dbl&gt;        &lt;dbl&gt;</span>
<span class="co">#  1 BWA     VA        1960     NA              NA      NA             NA      NA             NA</span>
<span class="co">#  2 BWA     VA        1961     NA              NA      NA             NA      NA             NA</span>
<span class="co">#  3 BWA     VA        1962     NA              NA      NA             NA      NA             NA</span>
<span class="co">#  4 BWA     VA        1963     NA              NA      NA             NA      NA             NA</span>
<span class="co">#  5 BWA     VA        1964     NA              NA      NA             NA      NA             NA</span>
<span class="co">#  6 BWA     VA        1965     -3.59           NA     -33.6           NA      32.4           NA</span>
<span class="co">#  7 BWA     VA        1966     11.7            NA     -23.6           NA     -23.6           NA</span>
<span class="co">#  8 BWA     VA        1967      7.96           NA      15.4           NA      15.4           NA</span>
<span class="co">#  9 BWA     VA        1968      9.72           NA     -22.3           NA     -22.3           NA</span>
<span class="co"># 10 BWA     VA        1969      3.55           NA     105.            NA     105.            NA</span>
<span class="co"># # ... with 5,017 more rows, and 16 more variables: Dlog1.PU &lt;dbl&gt;, L10Dlog1.PU &lt;dbl&gt;,</span>
<span class="co"># #   Dlog1.CON &lt;dbl&gt;, L10Dlog1.CON &lt;dbl&gt;, Dlog1.WRT &lt;dbl&gt;, L10Dlog1.WRT &lt;dbl&gt;, Dlog1.TRA &lt;dbl&gt;,</span>
<span class="co"># #   L10Dlog1.TRA &lt;dbl&gt;, Dlog1.FIRE &lt;dbl&gt;, L10Dlog1.FIRE &lt;dbl&gt;, Dlog1.GOV &lt;dbl&gt;, L10Dlog1.GOV &lt;dbl&gt;,</span>
<span class="co"># #   Dlog1.OTH &lt;dbl&gt;, L10Dlog1.OTH &lt;dbl&gt;, Dlog1.SUM &lt;dbl&gt;, L10Dlog1.SUM &lt;dbl&gt;</span>
<span class="co"># </span>
<span class="co"># Grouped by:  Variable, Country  [85 | 59 (7.7)]</span></pre></div>
<p><code>fdiff</code> and <code>fgrowth</code> can also perform leaded (forward) differences and growth rates (i.e. <code>... %&gt;% fgrowth(-c(1, 10), 1:2, Year)</code> would compute one and 10-year leaded first and second differences). Again it is possible to perform sequential operations:</p>
<div class="sourceCode" id="cb50"><pre class="downlit">
<span class="co"># This computes the 1 and 10-year growth rates, for the current period and lagged by one period</span>
<span class="va">GGDC10S</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">fselect</a></span><span class="op">(</span><span class="op">-</span><span class="va">Region</span>, <span class="op">-</span><span class="va">Regioncode</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_by</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/fgrowth.html">fgrowth</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span>, <span class="fl">1</span>, <span class="va">Year</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/flag.html">flag</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">1</span>, <span class="va">Year</span><span class="op">)</span>
<span class="co"># # A tibble: 5,027 x 47</span>
<span class="co">#    Country Variable  Year G1.AGR L1.G1.AGR L10G1.AGR L1.L10G1.AGR G1.MIN L1.G1.MIN L10G1.MIN</span>
<span class="co">#  * &lt;chr&gt;   &lt;chr&gt;    &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;        &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span>
<span class="co">#  1 BWA     VA        1960  NA        NA           NA           NA   NA        NA          NA</span>
<span class="co">#  2 BWA     VA        1961  NA        NA           NA           NA   NA        NA          NA</span>
<span class="co">#  3 BWA     VA        1962  NA        NA           NA           NA   NA        NA          NA</span>
<span class="co">#  4 BWA     VA        1963  NA        NA           NA           NA   NA        NA          NA</span>
<span class="co">#  5 BWA     VA        1964  NA        NA           NA           NA   NA        NA          NA</span>
<span class="co">#  6 BWA     VA        1965  -3.52     NA           NA           NA  -28.6      NA          NA</span>
<span class="co">#  7 BWA     VA        1966  12.4      -3.52        NA           NA  -21.1     -28.6        NA</span>
<span class="co">#  8 BWA     VA        1967   8.29     12.4         NA           NA   16.7     -21.1        NA</span>
<span class="co">#  9 BWA     VA        1968  10.2       8.29        NA           NA  -20        16.7        NA</span>
<span class="co"># 10 BWA     VA        1969   3.61     10.2         NA           NA  185.      -20          NA</span>
<span class="co"># # ... with 5,017 more rows, and 37 more variables: L1.L10G1.MIN &lt;dbl&gt;, G1.MAN &lt;dbl&gt;,</span>
<span class="co"># #   L1.G1.MAN &lt;dbl&gt;, L10G1.MAN &lt;dbl&gt;, L1.L10G1.MAN &lt;dbl&gt;, G1.PU &lt;dbl&gt;, L1.G1.PU &lt;dbl&gt;,</span>
<span class="co"># #   L10G1.PU &lt;dbl&gt;, L1.L10G1.PU &lt;dbl&gt;, G1.CON &lt;dbl&gt;, L1.G1.CON &lt;dbl&gt;, L10G1.CON &lt;dbl&gt;,</span>
<span class="co"># #   L1.L10G1.CON &lt;dbl&gt;, G1.WRT &lt;dbl&gt;, L1.G1.WRT &lt;dbl&gt;, L10G1.WRT &lt;dbl&gt;, L1.L10G1.WRT &lt;dbl&gt;,</span>
<span class="co"># #   G1.TRA &lt;dbl&gt;, L1.G1.TRA &lt;dbl&gt;, L10G1.TRA &lt;dbl&gt;, L1.L10G1.TRA &lt;dbl&gt;, G1.FIRE &lt;dbl&gt;,</span>
<span class="co"># #   L1.G1.FIRE &lt;dbl&gt;, L10G1.FIRE &lt;dbl&gt;, L1.L10G1.FIRE &lt;dbl&gt;, G1.GOV &lt;dbl&gt;, L1.G1.GOV &lt;dbl&gt;,</span>
<span class="co"># #   L10G1.GOV &lt;dbl&gt;, L1.L10G1.GOV &lt;dbl&gt;, G1.OTH &lt;dbl&gt;, L1.G1.OTH &lt;dbl&gt;, L10G1.OTH &lt;dbl&gt;,</span>
<span class="co"># #   L1.L10G1.OTH &lt;dbl&gt;, G1.SUM &lt;dbl&gt;, L1.G1.SUM &lt;dbl&gt;, L10G1.SUM &lt;dbl&gt;, L1.L10G1.SUM &lt;dbl&gt;</span>
<span class="co"># </span>
<span class="co"># Grouped by:  Variable, Country  [85 | 59 (7.7)]</span></pre></div>
</div>
</div>
<div id="benchmarks" class="section level2">
<h2 class="hasAnchor">
<a href="#benchmarks" class="anchor"></a>3. Benchmarks</h2>
<p>This section seeks to demonstrate that the functionality introduced in the preceding 2 sections indeed produces code that evaluates substantially faster than native <em>dplyr</em>.</p>
<p>To do this properly, the different components of a typical piped call (selecting / subsetting, ordering, grouping, and performing some computation) are bechmarked separately on 2 different data sizes.</p>
<p>All benchmarks are run on a Windows 8.1 laptop with a 2x 2.2 GHZ Intel i5 processor, 8GB DDR3 RAM and a Samsung 850 EVO SSD hard drive.</p>
<div id="data" class="section level3">
<h3 class="hasAnchor">
<a href="#data" class="anchor"></a>3.1 Data</h3>
<p>Bechmarks are run on the original <code>GGDC10S</code> data used throughout this vignette and a larger dataset with approx. 1 million observations, obtained by replicating and row-binding <code>GGDC10S</code> 200 times while maintaining unique groups.</p>
<div class="sourceCode" id="cb51"><pre class="downlit">
<span class="co"># This shows the groups in GGDC10S</span>
<span class="fu"><a href="../reference/GRP,%20fgroup_by.html">GRP</a></span><span class="op">(</span><span class="va">GGDC10S</span>, <span class="op">~</span> <span class="va">Variable</span> <span class="op">+</span> <span class="va">Country</span><span class="op">)</span>
<span class="co"># collapse grouping object of length 5027 with 85 ordered groups</span>
<span class="co"># </span>
<span class="co"># Call: GRP.default(X = GGDC10S, by = ~Variable + Country), X is unordered</span>
<span class="co"># </span>
<span class="co"># Distribution of group sizes: </span>
<span class="co">#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span>
<span class="co">#    4.00   53.00   62.00   59.14   63.00   65.00 </span>
<span class="co"># </span>
<span class="co"># Groups with sizes: </span>
<span class="co"># EMP.ARG EMP.BOL EMP.BRA EMP.BWA EMP.CHL EMP.CHN </span>
<span class="co">#      62      61      62      52      63      62 </span>
<span class="co">#   ---</span>
<span class="co"># VA.TWN VA.TZA VA.USA VA.VEN VA.ZAF VA.ZMB </span>
<span class="co">#     63     52     65     63     52     52</span>

<span class="co"># This replicates the data 200 times </span>
<span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">replicate</a></span><span class="op">(</span><span class="fl">200</span>, <span class="va">GGDC10S</span>, simplify <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> 
<span class="co"># This function adds a number i to the country and variable columns of each dataset</span>
<span class="va">uniquify</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">i</span><span class="op">)</span> <span class="fu"><a href="../reference/ftransform.html">ftransform</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html">unclass</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">4</span><span class="op">)</span><span class="op">]</span>, <span class="va">paste0</span>, <span class="va">i</span><span class="op">)</span><span class="op">)</span>
<span class="co"># Making datasets unique and row-binding them</span>
<span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/unlist2d.html">unlist2d</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/funprog.html">Map</a></span><span class="op">(</span><span class="va">uniquify</span>, <span class="va">data</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">as.list</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">200</span><span class="op">)</span><span class="op">)</span>, idcols <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="fu"><a href="../reference/AA2-small-helpers.html">fdim</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>
<span class="co"># [1] 1005400      16</span>

<span class="co"># This shows the groups in the replicated data</span>
<span class="fu"><a href="../reference/GRP,%20fgroup_by.html">GRP</a></span><span class="op">(</span><span class="va">data</span>, <span class="op">~</span> <span class="va">Variable</span> <span class="op">+</span> <span class="va">Country</span><span class="op">)</span>
<span class="co"># collapse grouping object of length 1005400 with 17000 ordered groups</span>
<span class="co"># </span>
<span class="co"># Call: GRP.default(X = data, by = ~Variable + Country), X is unordered</span>
<span class="co"># </span>
<span class="co"># Distribution of group sizes: </span>
<span class="co">#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span>
<span class="co">#    4.00   53.00   62.00   59.14   63.00   65.00 </span>
<span class="co"># </span>
<span class="co"># Groups with sizes: </span>
<span class="co"># EMP1.ARG1 EMP1.BOL1 EMP1.BRA1 EMP1.BWA1 EMP1.CHL1 EMP1.CHN1 </span>
<span class="co">#        62        61        62        52        63        62 </span>
<span class="co">#   ---</span>
<span class="co"># VA99.TWN99 VA99.TZA99 VA99.USA99 VA99.VEN99 VA99.ZAF99 VA99.ZMB99 </span>
<span class="co">#         63         52         65         63         52         52</span>

<span class="fu"><a href="https://rdrr.io/r/base/gc.html">gc</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#            used  (Mb) gc trigger  (Mb) max used  (Mb)</span>
<span class="co"># Ncells  2302151 123.0    4243897 226.7  4243897 226.7</span>
<span class="co"># Vcells 20490773 156.4   33392469 254.8 23056172 176.0</span></pre></div>
</div>
<div id="selecting-subsetting-ordering-and-grouping" class="section level3">
<h3 class="hasAnchor">
<a href="#selecting-subsetting-ordering-and-grouping" class="anchor"></a>3.1 Selecting, Subsetting, Ordering and Grouping</h3>
<div class="sourceCode" id="cb52"><pre class="downlit">
<span class="co">## Selecting columns</span>
<span class="co"># Small</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>dplyr <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">GGDC10S</span>, <span class="va">Country</span>, <span class="va">Variable</span>, <span class="va">AGR</span><span class="op">:</span><span class="va">SUM</span><span class="op">)</span>,
               collapse <span class="op">=</span> <span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">fselect</a></span><span class="op">(</span><span class="va">GGDC10S</span>, <span class="va">Country</span>, <span class="va">Variable</span>, <span class="va">AGR</span><span class="op">:</span><span class="va">SUM</span><span class="op">)</span><span class="op">)</span>
<span class="co"># Unit: microseconds</span>
<span class="co">#      expr      min       lq       mean    median       uq      max neval cld</span>
<span class="co">#     dplyr 3090.270 3248.465 3661.88243 3536.0715 3786.640 6404.556   100   b</span>
<span class="co">#  collapse   11.157   16.958   29.17596   32.3535   38.378   73.185   100  a</span>

<span class="co"># Large</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>dplyr <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">Country</span>, <span class="va">Variable</span>, <span class="va">AGR</span><span class="op">:</span><span class="va">SUM</span><span class="op">)</span>,
               collapse <span class="op">=</span> <span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">fselect</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">Country</span>, <span class="va">Variable</span>, <span class="va">AGR</span><span class="op">:</span><span class="va">SUM</span><span class="op">)</span><span class="op">)</span>
<span class="co"># Unit: microseconds</span>
<span class="co">#      expr      min        lq       mean   median       uq       max neval cld</span>
<span class="co">#     dplyr 2754.691 2889.2350 8368.50765 5763.966 9659.937 58699.945   100   b</span>
<span class="co">#  collapse   11.603   25.6595   55.95086   36.147   66.937   475.701   100  a</span>

<span class="co">## Subsetting columns </span>
<span class="co"># Small</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>dplyr <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">GGDC10S</span>, <span class="va">Variable</span> <span class="op">==</span> <span class="st">"VA"</span><span class="op">)</span>,
               collapse <span class="op">=</span> <span class="fu"><a href="../reference/fsubset.html">fsubset</a></span><span class="op">(</span><span class="va">GGDC10S</span>, <span class="va">Variable</span> <span class="op">==</span> <span class="st">"VA"</span><span class="op">)</span><span class="op">)</span>
<span class="co"># Unit: microseconds</span>
<span class="co">#      expr      min        lq      mean   median        uq       max neval cld</span>
<span class="co">#     dplyr 2690.877 4656.6010 6438.2071 5563.824 7006.9905 21035.252   100   b</span>
<span class="co">#  collapse  226.248  407.4245  609.9681  536.167  592.8415  2983.616   100  a</span>

<span class="co"># Large</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>dplyr <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">Variable</span> <span class="op">==</span> <span class="st">"VA"</span><span class="op">)</span>,
               collapse <span class="op">=</span> <span class="fu"><a href="../reference/fsubset.html">fsubset</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">Variable</span> <span class="op">==</span> <span class="st">"VA"</span><span class="op">)</span><span class="op">)</span>
<span class="co"># Unit: milliseconds</span>
<span class="co">#      expr       min        lq     mean    median       uq       max neval cld</span>
<span class="co">#     dplyr 16.792323 17.895003 22.77324 18.831232 23.67950 120.14164   100   b</span>
<span class="co">#  collapse  7.738392  8.147379 13.18525  8.839063 11.82893  64.30482   100  a</span>

<span class="co">## Ordering rows</span>
<span class="co"># Small</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>dplyr <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">GGDC10S</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">Country</span><span class="op">)</span>, <span class="va">Variable</span>, <span class="va">Year</span><span class="op">)</span>,
               collapse <span class="op">=</span> <span class="fu"><a href="../reference/roworder.html">roworder</a></span><span class="op">(</span><span class="va">GGDC10S</span>, <span class="op">-</span><span class="va">Country</span>, <span class="va">Variable</span>, <span class="va">Year</span><span class="op">)</span><span class="op">)</span>
<span class="co"># Unit: microseconds</span>
<span class="co">#      expr       min        lq       mean  median       uq       max neval cld</span>
<span class="co">#     dplyr 24976.517 26012.482 29693.9499 26860.8 28740.17 75848.820   100   b</span>
<span class="co">#  collapse   641.259   821.097   985.8207   868.4   945.60  5745.893   100  a</span>

<span class="co"># Large</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>dplyr <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">data</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">Country</span><span class="op">)</span>, <span class="va">Variable</span>, <span class="va">Year</span><span class="op">)</span>,
               collapse <span class="op">=</span> <span class="fu"><a href="../reference/roworder.html">roworder</a></span><span class="op">(</span><span class="va">data</span>, <span class="op">-</span><span class="va">Country</span>, <span class="va">Variable</span>, <span class="va">Year</span><span class="op">)</span>, times <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="co"># Unit: milliseconds</span>
<span class="co">#      expr        min         lq       mean     median         uq        max neval cld</span>
<span class="co">#     dplyr 19761.3839 19761.3839 20073.6533 20073.6533 20385.9227 20385.9227     2   b</span>
<span class="co">#  collapse   219.3337   219.3337   250.1585   250.1585   280.9834   280.9834     2  a</span>


<span class="co">## Grouping </span>
<span class="co"># Small</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>dplyr <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">GGDC10S</span>, <span class="va">Country</span>, <span class="va">Variable</span><span class="op">)</span>,
               collapse <span class="op">=</span> <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_by</a></span><span class="op">(</span><span class="va">GGDC10S</span>, <span class="va">Country</span>, <span class="va">Variable</span><span class="op">)</span><span class="op">)</span>
<span class="co"># Unit: microseconds</span>
<span class="co">#      expr      min       lq      mean   median       uq      max neval cld</span>
<span class="co">#     dplyr 2945.685 3023.555 3147.8758 3095.848 3188.445 4213.477   100   b</span>
<span class="co">#  collapse  348.520  362.800  390.8334  392.475  409.433  649.291   100  a</span>

<span class="co"># Large</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>dplyr <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">Country</span>, <span class="va">Variable</span><span class="op">)</span>,
               collapse <span class="op">=</span> <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_by</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">Country</span>, <span class="va">Variable</span><span class="op">)</span>, times <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>
<span class="co"># Unit: milliseconds</span>
<span class="co">#      expr       min        lq      mean    median        uq       max neval cld</span>
<span class="co">#     dplyr 195.11314 198.33728 203.22878 201.86710 206.23230 217.56790    10   b</span>
<span class="co">#  collapse  67.23489  68.28447  70.03188  69.50495  70.84281  76.11835    10  a</span>

<span class="co">## Computing a new column </span>
<span class="co"># Small</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>dplyr <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">GGDC10S</span>, NEW <span class="op">=</span> <span class="va">AGR</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span>,
               collapse <span class="op">=</span> <span class="fu"><a href="../reference/ftransform.html">ftransform</a></span><span class="op">(</span><span class="va">GGDC10S</span>, NEW <span class="op">=</span> <span class="va">AGR</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="co"># Unit: microseconds</span>
<span class="co">#      expr      min       lq       mean   median        uq      max neval cld</span>
<span class="co">#     dplyr 3007.268 3155.868 3378.26033 3254.489 3391.0410 6666.057   100   b</span>
<span class="co">#  collapse   26.775   34.808   50.87266   43.287   60.9135  199.473   100  a</span>

<span class="co"># Large</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>dplyr <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">data</span>, NEW <span class="op">=</span> <span class="va">AGR</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span>,
               collapse <span class="op">=</span> <span class="fu"><a href="../reference/ftransform.html">ftransform</a></span><span class="op">(</span><span class="va">data</span>, NEW <span class="op">=</span> <span class="va">AGR</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="co"># Unit: milliseconds</span>
<span class="co">#      expr      min       lq     mean   median       uq      max neval cld</span>
<span class="co">#     dplyr 4.037655 6.412142 9.527133 7.036666 9.000605 65.98272   100   b</span>
<span class="co">#  collapse 1.270469 2.059881 4.785661 3.826580 4.584309 59.38627   100  a</span>

<span class="co">## All combined with pipes </span>
<span class="co"># Small</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>dplyr <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">GGDC10S</span>, <span class="va">Variable</span> <span class="op">==</span> <span class="st">"VA"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
                       <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">Country</span>, <span class="va">Year</span>, <span class="va">AGR</span><span class="op">:</span><span class="va">SUM</span><span class="op">)</span> <span class="op">%&gt;%</span> 
                       <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">Country</span><span class="op">)</span>, <span class="va">Year</span><span class="op">)</span> <span class="op">%&gt;%</span>
                       <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>NEW <span class="op">=</span> <span class="va">AGR</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>
                       <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">Country</span><span class="op">)</span>,
               collapse <span class="op">=</span> <span class="fu"><a href="../reference/fsubset.html">fsubset</a></span><span class="op">(</span><span class="va">GGDC10S</span>, <span class="va">Variable</span> <span class="op">==</span> <span class="st">"VA"</span>, <span class="va">Country</span>, <span class="va">Year</span>, <span class="va">AGR</span><span class="op">:</span><span class="va">SUM</span><span class="op">)</span> <span class="op">%&gt;%</span> 
                       <span class="fu"><a href="../reference/roworder.html">roworder</a></span><span class="op">(</span><span class="op">-</span><span class="va">Country</span>, <span class="va">Year</span><span class="op">)</span> <span class="op">%&gt;%</span>
                       <span class="fu"><a href="../reference/ftransform.html">ftransform</a></span><span class="op">(</span>NEW <span class="op">=</span> <span class="va">AGR</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>
                       <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_by</a></span><span class="op">(</span><span class="va">Country</span><span class="op">)</span><span class="op">)</span>
<span class="co"># Unit: microseconds</span>
<span class="co">#      expr       min         lq       mean    median         uq       max neval cld</span>
<span class="co">#     dplyr 22404.787 23159.3935 25073.1336 24354.446 25676.0105 37566.073   100   b</span>
<span class="co">#  collapse   432.861   493.9975   541.1744   542.861   577.4455   838.055   100  a</span>

<span class="co"># Large</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>dplyr <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">Variable</span> <span class="op">==</span> <span class="st">"VA"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
                       <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">Country</span>, <span class="va">Year</span>, <span class="va">AGR</span><span class="op">:</span><span class="va">SUM</span><span class="op">)</span> <span class="op">%&gt;%</span> 
                       <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">Country</span><span class="op">)</span>, <span class="va">Year</span><span class="op">)</span> <span class="op">%&gt;%</span>
                       <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>NEW <span class="op">=</span> <span class="va">AGR</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>
                       <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">Country</span><span class="op">)</span>,
               collapse <span class="op">=</span> <span class="fu"><a href="../reference/fsubset.html">fsubset</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">Variable</span> <span class="op">==</span> <span class="st">"VA"</span>, <span class="va">Country</span>, <span class="va">Year</span>, <span class="va">AGR</span><span class="op">:</span><span class="va">SUM</span><span class="op">)</span> <span class="op">%&gt;%</span> 
                       <span class="fu"><a href="../reference/roworder.html">roworder</a></span><span class="op">(</span><span class="op">-</span><span class="va">Country</span>, <span class="va">Year</span><span class="op">)</span> <span class="op">%&gt;%</span>
                       <span class="fu"><a href="../reference/ftransform.html">ftransform</a></span><span class="op">(</span>NEW <span class="op">=</span> <span class="va">AGR</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>
                       <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_by</a></span><span class="op">(</span><span class="va">Country</span><span class="op">)</span>, times <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>
<span class="co"># Unit: milliseconds</span>
<span class="co">#      expr       min        lq      mean    median        uq      max neval cld</span>
<span class="co">#     dplyr 22.216917 22.565437 26.111103 24.982094 29.705409 33.18168    10   b</span>
<span class="co">#  collapse  6.839201  7.054293  8.346583  8.210076  9.081599 10.25345    10  a</span>

<span class="fu"><a href="https://rdrr.io/r/base/gc.html">gc</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#            used  (Mb) gc trigger  (Mb) max used  (Mb)</span>
<span class="co"># Ncells  2307708 123.3    4243897 226.7  4243897 226.7</span>
<span class="co"># Vcells 22006745 167.9   73138358 558.1 73138358 558.1</span></pre></div>
</div>
<div id="aggregation" class="section level3">
<h3 class="hasAnchor">
<a href="#aggregation" class="anchor"></a>3.1 Aggregation</h3>
<div class="sourceCode" id="cb53"><pre class="downlit">
<span class="co">## Grouping the data</span>
<span class="va">cgGGDC10S</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_by</a></span><span class="op">(</span><span class="va">GGDC10S</span>, <span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">fselect</a></span><span class="op">(</span><span class="op">-</span><span class="va">Region</span>, <span class="op">-</span><span class="va">Regioncode</span><span class="op">)</span>
<span class="va">gGGDC10S</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">GGDC10S</span>, <span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">fselect</a></span><span class="op">(</span><span class="op">-</span><span class="va">Region</span>, <span class="op">-</span><span class="va">Regioncode</span><span class="op">)</span>
<span class="va">cgdata</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/GRP,%20fgroup_by.html">fgroup_by</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">fselect</a></span><span class="op">(</span><span class="op">-</span><span class="va">Region</span>, <span class="op">-</span><span class="va">Regioncode</span><span class="op">)</span>
<span class="va">gdata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">Variable</span>, <span class="va">Country</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/fselect,%20get_vars,%20add_vars.html">fselect</a></span><span class="op">(</span><span class="op">-</span><span class="va">Region</span>, <span class="op">-</span><span class="va">Regioncode</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">GGDC10S</span><span class="op">)</span> 
<span class="fu"><a href="https://rdrr.io/r/base/gc.html">gc</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#            used  (Mb) gc trigger  (Mb) max used  (Mb)</span>
<span class="co"># Ncells  2324701 124.2    4243897 226.7  4243897 226.7</span>
<span class="co"># Vcells 21107320 161.1   73138358 558.1 73138358 558.1</span>

<span class="co">## Conversion of Grouping object: This time would be required extra in all hybrid calls </span>
<span class="co">## i.e. when calling collapse functions on data grouped with dplyr::group_by</span>
<span class="co"># Small</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="../reference/GRP,%20fgroup_by.html">GRP</a></span><span class="op">(</span><span class="va">gGGDC10S</span><span class="op">)</span><span class="op">)</span>
<span class="co"># Unit: microseconds</span>
<span class="co">#           expr     min      lq     mean  median       uq      max neval</span>
<span class="co">#  GRP(gGGDC10S) 348.074 370.609 505.3809 385.782 440.4475 3243.779   100</span>

<span class="co"># Large</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="../reference/GRP,%20fgroup_by.html">GRP</a></span><span class="op">(</span><span class="va">gdata</span><span class="op">)</span><span class="op">)</span>
<span class="co"># Unit: milliseconds</span>
<span class="co">#        expr      min       lq    mean   median       uq     max neval</span>
<span class="co">#  GRP(gdata) 29.38188 31.45002 38.0206 33.77832 36.68629 117.656   100</span>


<span class="co">## Sum </span>
<span class="co"># Small</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>dplyr <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise_all.html">summarise_all</a></span><span class="op">(</span><span class="va">gGGDC10S</span>, <span class="va">sum</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
               collapse <span class="op">=</span> <span class="fu"><a href="../reference/fsum.html">fsum</a></span><span class="op">(</span><span class="va">cgGGDC10S</span><span class="op">)</span><span class="op">)</span>
<span class="co"># Unit: microseconds</span>
<span class="co">#      expr     min       lq       mean   median        uq       max neval cld</span>
<span class="co">#     dplyr 8284.60 8980.523 10514.0961 9480.768 10619.147 25634.732   100   b</span>
<span class="co">#  collapse  239.19  280.913   321.0804  302.556   340.711   590.833   100  a</span>

<span class="co"># Large</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>dplyr <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise_all.html">summarise_all</a></span><span class="op">(</span><span class="va">gdata</span>, <span class="va">sum</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
               collapse <span class="op">=</span> <span class="fu"><a href="../reference/fsum.html">fsum</a></span><span class="op">(</span><span class="va">cgdata</span><span class="op">)</span>, times <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>
<span class="co"># Unit: milliseconds</span>
<span class="co">#      expr       min        lq      mean    median        uq        max neval cld</span>
<span class="co">#     dplyr 573.20993 602.61769 803.86710 718.05677 970.63463 1268.85923    10   b</span>
<span class="co">#  collapse  41.60016  42.38511  47.29339  48.05893  50.62196   54.85953    10  a</span>

<span class="co">## Mean</span>
<span class="co"># Small</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>dplyr <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise_all.html">summarise_all</a></span><span class="op">(</span><span class="va">gGGDC10S</span>, <span class="va">mean.default</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
               collapse <span class="op">=</span> <span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="va">cgGGDC10S</span><span class="op">)</span><span class="op">)</span>
<span class="co"># Unit: microseconds</span>
<span class="co">#      expr       min         lq       mean    median       uq       max neval cld</span>
<span class="co">#     dplyr 10903.630 11145.2740 12220.4826 11411.238 11940.93 33783.673   100   b</span>
<span class="co">#  collapse   258.824   274.8895   303.3732   314.159   319.96   445.802   100  a</span>

<span class="co"># Large</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>dplyr <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise_all.html">summarise_all</a></span><span class="op">(</span><span class="va">gdata</span>, <span class="va">mean.default</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
               collapse <span class="op">=</span> <span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="va">cgdata</span><span class="op">)</span>, times <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>
<span class="co"># Unit: milliseconds</span>
<span class="co">#      expr        min         lq       mean     median         uq       max neval cld</span>
<span class="co">#     dplyr 1454.07280 1490.12386 1617.22808 1622.44629 1705.83358 1849.6304    10   b</span>
<span class="co">#  collapse   44.97067   45.07152   46.11673   45.24266   47.32374   48.8508    10  a</span>

<span class="co">## Median</span>
<span class="co"># Small</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>dplyr <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise_all.html">summarise_all</a></span><span class="op">(</span><span class="va">gGGDC10S</span>, <span class="va">median</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
               collapse <span class="op">=</span> <span class="fu"><a href="../reference/fmedian.html">fmedian</a></span><span class="op">(</span><span class="va">cgGGDC10S</span><span class="op">)</span><span class="op">)</span>
<span class="co"># Unit: microseconds</span>
<span class="co">#      expr       min        lq       mean     median        uq       max neval cld</span>
<span class="co">#     dplyr 48462.563 49467.291 53665.0865 50538.0640 55707.404 87132.655   100   b</span>
<span class="co">#  collapse   488.642   549.555   590.2751   584.3625   622.517   851.889   100  a</span>

<span class="co"># Large</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>dplyr <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise_all.html">summarise_all</a></span><span class="op">(</span><span class="va">gdata</span>, <span class="va">median</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
               collapse <span class="op">=</span> <span class="fu"><a href="../reference/fmedian.html">fmedian</a></span><span class="op">(</span><span class="va">cgdata</span><span class="op">)</span>, times <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="co"># Unit: milliseconds</span>
<span class="co">#      expr        min         lq       mean     median         uq        max neval cld</span>
<span class="co">#     dplyr 9288.16884 9288.16884 9355.06257 9355.06257 9421.95631 9421.95631     2   b</span>
<span class="co">#  collapse   93.17307   93.17307   94.58567   94.58567   95.99827   95.99827     2  a</span>

<span class="co">## Standard Deviation</span>
<span class="co"># Small</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>dplyr <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise_all.html">summarise_all</a></span><span class="op">(</span><span class="va">gGGDC10S</span>, <span class="va">sd</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
               collapse <span class="op">=</span> <span class="fu"><a href="../reference/fvar,%20fsd.html">fsd</a></span><span class="op">(</span><span class="va">cgGGDC10S</span><span class="op">)</span><span class="op">)</span>
<span class="co"># Unit: microseconds</span>
<span class="co">#      expr      min        lq       mean    median        uq       max neval cld</span>
<span class="co">#     dplyr 24275.46 24748.707 26379.4763 25031.851 26548.872 39034.229   100   b</span>
<span class="co">#  collapse   427.06   459.859   496.7192   485.965   512.739   970.144   100  a</span>

<span class="co"># Large</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>dplyr <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise_all.html">summarise_all</a></span><span class="op">(</span><span class="va">gdata</span>, <span class="va">sd</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
               collapse <span class="op">=</span> <span class="fu"><a href="../reference/fvar,%20fsd.html">fsd</a></span><span class="op">(</span><span class="va">cgdata</span><span class="op">)</span>, times <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="co"># Unit: milliseconds</span>
<span class="co">#      expr        min         lq       mean     median         uq        max neval cld</span>
<span class="co">#     dplyr 4155.64069 4155.64069 4328.76628 4328.76628 4501.89187 4501.89187     2   b</span>
<span class="co">#  collapse   81.51707   81.51707   82.09094   82.09094   82.66482   82.66482     2  a</span>

<span class="co">## Maximum</span>
<span class="co"># Small</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>dplyr <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise_all.html">summarise_all</a></span><span class="op">(</span><span class="va">gGGDC10S</span>, <span class="va">max</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
               collapse <span class="op">=</span> <span class="fu"><a href="../reference/fmin,%20fmax.html">fmax</a></span><span class="op">(</span><span class="va">cgGGDC10S</span><span class="op">)</span><span class="op">)</span>
<span class="co"># Unit: microseconds</span>
<span class="co">#      expr      min         lq       mean    median        uq       max neval cld</span>
<span class="co">#     dplyr 9887.077 10194.0955 10714.3232 10393.792 10629.411 19342.186   100   b</span>
<span class="co">#  collapse  182.516   196.5725   243.1297   244.098   251.238   973.267   100  a</span>

<span class="co"># Large</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>dplyr <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise_all.html">summarise_all</a></span><span class="op">(</span><span class="va">gdata</span>, <span class="va">max</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
               collapse <span class="op">=</span> <span class="fu"><a href="../reference/fmin,%20fmax.html">fmax</a></span><span class="op">(</span><span class="va">cgdata</span><span class="op">)</span>, times <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>
<span class="co"># Unit: milliseconds</span>
<span class="co">#      expr       min       lq      mean    median        uq      max neval cld</span>
<span class="co">#     dplyr 841.05663 867.9507 900.67790 883.18202 901.57102 1089.203    10   b</span>
<span class="co">#  collapse  25.78913  25.8583  26.28742  26.07406  26.86772   27.131    10  a</span>

<span class="co">## First Value</span>
<span class="co"># Small</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>dplyr <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise_all.html">summarise_all</a></span><span class="op">(</span><span class="va">gGGDC10S</span>, <span class="va">first</span><span class="op">)</span>,
               collapse <span class="op">=</span> <span class="fu"><a href="../reference/ffirst,%20flast.html">ffirst</a></span><span class="op">(</span><span class="va">cgGGDC10S</span>, na.rm <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span>
<span class="co"># Unit: microseconds</span>
<span class="co">#      expr       min        lq       mean   median       uq       max neval cld</span>
<span class="co">#     dplyr 10452.920 10847.627 11462.3425 11079.23 11362.15 20952.696   100   b</span>
<span class="co">#  collapse    57.566    68.276   117.0155   117.14   124.95  1543.573   100  a</span>

<span class="co"># Large</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>dplyr <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise_all.html">summarise_all</a></span><span class="op">(</span><span class="va">gdata</span>, <span class="va">first</span><span class="op">)</span>,
               collapse <span class="op">=</span> <span class="fu"><a href="../reference/ffirst,%20flast.html">ffirst</a></span><span class="op">(</span><span class="va">cgdata</span>, na.rm <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, times <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>
<span class="co"># Unit: milliseconds</span>
<span class="co">#      expr        min          lq        mean     median          uq         max neval cld</span>
<span class="co">#     dplyr 1186.05831 1228.879404 1365.678287 1409.77351 1427.809301 1515.277980    10   b</span>
<span class="co">#  collapse    4.45088    4.475871    4.548431    4.48658    4.652139    4.712828    10  a</span>

<span class="co">## Number of Distinct Values</span>
<span class="co"># Small</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>dplyr <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise_all.html">summarise_all</a></span><span class="op">(</span><span class="va">gGGDC10S</span>, <span class="va">n_distinct</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
               collapse <span class="op">=</span> <span class="fu"><a href="../reference/fNdistinct.html">fNdistinct</a></span><span class="op">(</span><span class="va">cgGGDC10S</span><span class="op">)</span><span class="op">)</span>
<span class="co"># Unit: milliseconds</span>
<span class="co">#      expr       min        lq      mean    median        uq      max neval cld</span>
<span class="co">#     dplyr 65.569491 67.342659 70.766485 68.975481 73.907195 82.63760   100   b</span>
<span class="co">#  collapse  1.311078  1.358826  1.531721  1.391179  1.463248 10.16554   100  a</span>

<span class="co"># Large</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>dplyr <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise_all.html">summarise_all</a></span><span class="op">(</span><span class="va">gdata</span>, <span class="va">n_distinct</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
               collapse <span class="op">=</span> <span class="fu"><a href="../reference/fNdistinct.html">fNdistinct</a></span><span class="op">(</span><span class="va">cgdata</span><span class="op">)</span>, times <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>
<span class="co"># Unit: milliseconds</span>
<span class="co">#      expr        min         lq       mean     median         uq        max neval cld</span>
<span class="co">#     dplyr 12894.1111 13107.1415 17884.8903 16243.7631 17612.7355 29566.7005     5   b</span>
<span class="co">#  collapse   311.8544   321.0761   332.4503   334.1387   334.6594   360.5231     5  a</span>

<span class="fu"><a href="https://rdrr.io/r/base/gc.html">gc</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#            used  (Mb) gc trigger  (Mb) max used  (Mb)</span>
<span class="co"># Ncells  2327929 124.4    4243897 226.7  4243897 226.7</span>
<span class="co"># Vcells 21114893 161.1   73138358 558.1 73138358 558.1</span></pre></div>
<!-- The benchmarks show that at this data size efficient primitives like `base::sum` or `base::max` can still deliver very decent performance with `summarize`. Less optimized base functions like `mean`, `median` and `sd` however take multiple seconds to compute, and here `collapse` fast functions really prove to be very useful complements to the *dplyr* system. -->
<!-- Weighted statistics are also performed extremely fast by *collapse* functions. I would not know how to compute weighted statistics by groups in *dplyr*, as it would require the weighting variable to be split as well, which seems impossible in native *dplyr*. -->
<!-- A further highlight of *collapse* is the extremely fast statistical mode function, which can also compute a weighted mode. Fast categorical aggregation has been an issue in R, and defining a mode function from base R and applying it to 17000 groups will probably let it run at least a minute. `fmode` reduces this time to half a second. -->
<!-- Thus in terms of data aggregation *collapse* fast functions are able to speed up *dplyr* to a level that makes it attractive again to R users working on medium-sized or larger data, and everyone programming with *dplyr*. I however strongly recommend *collapse* itself for easy and speedy programming as it does not rely on non-standard evaluation and has less R-overhead than *dplyr*. -->
<!-- In all of this the grouping system of *dplyr* remains the central bottleneck. For example grouping 10 million observations in 1 million groups takes around 10 second with `group_by`, whereas `GRP` takes around 1.5 seconds, and this difference grows exponentially as data get larger. Rewriting `group_by` using `GRP` / `radixorderv` and then writing a simple C++ conversion program for the grouping object could be a quick remedy for this issue, but that is at the discretion of Hadley Wickham and coauthors. -->
<!-- (If you need that speed program with *collapse* or use *data.table* with GeForce optimized functions). -->
<p>Below are some additional benchmarks for weighted aggregations and aggregations using the statistical mode, which cannot easily or efficiently be performed with <em>dplyr</em>.</p>
<div class="sourceCode" id="cb54"><pre class="downlit">
<span class="co">## Weighted Mean</span>
<span class="co"># Small</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="va">cgGGDC10S</span>, <span class="va">SUM</span><span class="op">)</span><span class="op">)</span> 
<span class="co"># Unit: microseconds</span>
<span class="co">#                   expr    min      lq     mean  median       uq     max neval</span>
<span class="co">#  fmean(cgGGDC10S, SUM) 319.96 332.232 369.2037 341.826 349.1895 765.762   100</span>

<span class="co"># Large </span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="../reference/fmean.html">fmean</a></span><span class="op">(</span><span class="va">cgdata</span>, <span class="va">SUM</span><span class="op">)</span>, times <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> 
<span class="co"># Unit: milliseconds</span>
<span class="co">#                expr      min       lq     mean   median       uq     max neval</span>
<span class="co">#  fmean(cgdata, SUM) 51.70009 53.60424 62.06417 56.69406 72.08695 82.5479    10</span>

<span class="co">## Weighted Standard-Deviation</span>
<span class="co"># Small</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="../reference/fvar,%20fsd.html">fsd</a></span><span class="op">(</span><span class="va">cgGGDC10S</span>, <span class="va">SUM</span><span class="op">)</span><span class="op">)</span> 
<span class="co"># Unit: microseconds</span>
<span class="co">#                 expr     min      lq     mean   median       uq      max neval</span>
<span class="co">#  fsd(cgGGDC10S, SUM) 440.001 558.034 1153.771 904.9915 1082.599 9133.364   100</span>

<span class="co"># Large </span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="../reference/fvar,%20fsd.html">fsd</a></span><span class="op">(</span><span class="va">cgdata</span>, <span class="va">SUM</span><span class="op">)</span>, times <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> 
<span class="co"># Unit: milliseconds</span>
<span class="co">#              expr      min       lq     mean   median       uq      max neval</span>
<span class="co">#  fsd(cgdata, SUM) 79.68343 90.06718 100.0621 99.64724 110.8909 127.8064    10</span>

<span class="co">## Statistical Mode</span>
<span class="co"># Small</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="../reference/fmode.html">fmode</a></span><span class="op">(</span><span class="va">cgGGDC10S</span><span class="op">)</span><span class="op">)</span> 
<span class="co"># Unit: milliseconds</span>
<span class="co">#              expr      min       lq    mean   median       uq      max neval</span>
<span class="co">#  fmode(cgGGDC10S) 1.571241 1.792579 2.05617 1.829842 2.013249 5.649057   100</span>

<span class="co"># Large </span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="../reference/fmode.html">fmode</a></span><span class="op">(</span><span class="va">cgdata</span><span class="op">)</span>, times <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> 
<span class="co"># Unit: milliseconds</span>
<span class="co">#           expr      min       lq     mean   median       uq      max neval</span>
<span class="co">#  fmode(cgdata) 412.6703 509.7057 585.4809 583.4205 618.5563 821.8684    10</span>

<span class="co">## Weighted Statistical Mode</span>
<span class="co"># Small</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="../reference/fmode.html">fmode</a></span><span class="op">(</span><span class="va">cgGGDC10S</span>, <span class="va">SUM</span><span class="op">)</span><span class="op">)</span> 
<span class="co"># Unit: milliseconds</span>
<span class="co">#                   expr      min       lq     mean   median       uq   max neval</span>
<span class="co">#  fmode(cgGGDC10S, SUM) 1.764466 1.995623 2.051703 2.031769 2.100714 3.271   100</span>

<span class="co"># Large </span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="../reference/fmode.html">fmode</a></span><span class="op">(</span><span class="va">cgdata</span>, <span class="va">SUM</span><span class="op">)</span>, times <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> 
<span class="co"># Unit: milliseconds</span>
<span class="co">#                expr      min       lq     mean  median       uq      max neval</span>
<span class="co">#  fmode(cgdata, SUM) 517.7212 553.4684 648.3746 656.759 740.7869 767.1949    10</span>

<span class="fu"><a href="https://rdrr.io/r/base/gc.html">gc</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#            used  (Mb) gc trigger  (Mb) max used  (Mb)</span>
<span class="co"># Ncells  2327383 124.3    4243897 226.7  4243897 226.7</span>
<span class="co"># Vcells 21111519 161.1   73138358 558.1 73138358 558.1</span></pre></div>
</div>
<div id="transformation" class="section level3">
<h3 class="hasAnchor">
<a href="#transformation" class="anchor"></a>3.2 Transformation</h3>
<div class="sourceCode" id="cb55"><pre class="downlit">

<span class="co">## Replacing with group sum</span>
<span class="co"># Small</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>dplyr <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">mutate_all</a></span><span class="op">(</span><span class="va">gGGDC10S</span>, <span class="va">sum</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
               collapse <span class="op">=</span> <span class="fu"><a href="../reference/fsum.html">fsum</a></span><span class="op">(</span><span class="va">cgGGDC10S</span>, TRA <span class="op">=</span> <span class="st">"replace_fill"</span><span class="op">)</span><span class="op">)</span>
<span class="co"># Unit: microseconds</span>
<span class="co">#      expr      min        lq       mean   median       uq       max neval cld</span>
<span class="co">#     dplyr 9952.676 14189.356 18875.7491 16204.61 21243.20 63585.917   100   b</span>
<span class="co">#  collapse  326.654   387.567   529.1079   434.20   547.77  1965.278   100  a</span>

<span class="co"># Large</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>dplyr <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">mutate_all</a></span><span class="op">(</span><span class="va">gdata</span>, <span class="va">sum</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
               collapse <span class="op">=</span> <span class="fu"><a href="../reference/fsum.html">fsum</a></span><span class="op">(</span><span class="va">cgdata</span>, TRA <span class="op">=</span> <span class="st">"replace_fill"</span><span class="op">)</span>, times <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>
<span class="co"># Unit: milliseconds</span>
<span class="co">#      expr       min        lq      mean    median        uq       max neval cld</span>
<span class="co">#     dplyr 931.38933 1062.2262 1257.1730 1245.4816 1373.6432 1783.5825    10   b</span>
<span class="co">#  collapse  60.55188   71.0048  172.5488  121.8175  300.3608  372.9703    10  a</span>

<span class="co">## Dividing by group sum</span>
<span class="co"># Small</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>dplyr <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">mutate_all</a></span><span class="op">(</span><span class="va">gGGDC10S</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,
               collapse <span class="op">=</span> <span class="fu"><a href="../reference/fsum.html">fsum</a></span><span class="op">(</span><span class="va">cgGGDC10S</span>, TRA <span class="op">=</span> <span class="st">"/"</span><span class="op">)</span><span class="op">)</span>
<span class="co"># Unit: microseconds</span>
<span class="co">#      expr      min        lq       mean     median        uq       max neval cld</span>
<span class="co">#     dplyr 9148.536 9726.2050 11421.2653 10392.8995 11773.592 23255.783   100   b</span>
<span class="co">#  collapse  548.440  565.8435   633.4541   613.8145   678.744  1003.166   100  a</span>

<span class="co"># Large</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>dplyr <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">mutate_all</a></span><span class="op">(</span><span class="va">gdata</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,
               collapse <span class="op">=</span> <span class="fu"><a href="../reference/fsum.html">fsum</a></span><span class="op">(</span><span class="va">cgdata</span>, TRA <span class="op">=</span> <span class="st">"/"</span><span class="op">)</span>, times <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>
<span class="co"># Unit: milliseconds</span>
<span class="co">#      expr       min        lq      mean    median        uq       max neval cld</span>
<span class="co">#     dplyr 1203.2906 1580.4784 1837.4117 1698.4015 2089.7419 2804.4906    10   b</span>
<span class="co">#  collapse  109.6271  115.0937  164.5631  128.1049  153.5871  463.0924    10  a</span>

<span class="co">## Centering</span>
<span class="co"># Small</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>dplyr <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">mutate_all</a></span><span class="op">(</span><span class="va">gGGDC10S</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean.default</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,
               collapse <span class="op">=</span> <span class="fu"><a href="../reference/fbetween,%20fwithin.html">fwithin</a></span><span class="op">(</span><span class="va">cgGGDC10S</span><span class="op">)</span><span class="op">)</span>
<span class="co"># Unit: microseconds</span>
<span class="co">#      expr       min        lq       mean     median        uq       max neval cld</span>
<span class="co">#     dplyr 11884.930 12263.349 13834.5448 12822.0520 13502.135 60464.857   100   b</span>
<span class="co">#  collapse   306.572   323.084   361.8897   359.6765   380.204   689.454   100  a</span>

<span class="co"># Large</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>dplyr <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">mutate_all</a></span><span class="op">(</span><span class="va">gdata</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean.default</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,
               collapse <span class="op">=</span> <span class="fu"><a href="../reference/fbetween,%20fwithin.html">fwithin</a></span><span class="op">(</span><span class="va">cgdata</span><span class="op">)</span>, times <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>
<span class="co"># Unit: milliseconds</span>
<span class="co">#      expr       min         lq      mean    median        uq      max neval cld</span>
<span class="co">#     dplyr 1920.4562 2827.10869 2798.1697 2872.0838 3033.6529 3205.626    10   b</span>
<span class="co">#  collapse   65.4856   76.23839  114.8372  100.1533  162.7168  173.388    10  a</span>

<span class="co">## Centering and Scaling (Standardizing)</span>
<span class="co"># Small</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>dplyr <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">mutate_all</a></span><span class="op">(</span><span class="va">gGGDC10S</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">(</span><span class="va">x</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean.default</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,
               collapse <span class="op">=</span> <span class="fu"><a href="../reference/fscale.html">fscale</a></span><span class="op">(</span><span class="va">cgGGDC10S</span><span class="op">)</span><span class="op">)</span>
<span class="co"># Unit: microseconds</span>
<span class="co">#      expr       min        lq      mean     median        uq       max neval cld</span>
<span class="co">#     dplyr 29655.429 32402.757 37043.271 34055.4375 39418.450 66339.269   100   b</span>
<span class="co">#  collapse   496.675   541.969   584.706   560.7115   605.113  1238.785   100  a</span>

<span class="co"># Large</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>dplyr <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">mutate_all</a></span><span class="op">(</span><span class="va">gdata</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">(</span><span class="va">x</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean.default</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,
               collapse <span class="op">=</span> <span class="fu"><a href="../reference/fscale.html">fscale</a></span><span class="op">(</span><span class="va">cgdata</span><span class="op">)</span>, times <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="co"># Unit: milliseconds</span>
<span class="co">#      expr       min        lq      mean    median       uq      max neval cld</span>
<span class="co">#     dplyr 6128.4079 6128.4079 6364.0317 6364.0317 6599.655 6599.655     2   b</span>
<span class="co">#  collapse  103.6416  103.6416  114.0488  114.0488  124.456  124.456     2  a</span>

<span class="co">## Lag</span>
<span class="co"># Small</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>dplyr_unordered <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">mutate_all</a></span><span class="op">(</span><span class="va">gGGDC10S</span>, <span class="fu">dplyr</span><span class="fu">::</span><span class="va"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">)</span>,
               collapse_unordered <span class="op">=</span> <span class="fu"><a href="../reference/flag.html">flag</a></span><span class="op">(</span><span class="va">cgGGDC10S</span><span class="op">)</span>,
               dplyr_ordered <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">mutate_all</a></span><span class="op">(</span><span class="va">gGGDC10S</span>, <span class="fu">dplyr</span><span class="fu">::</span><span class="va"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span>, order_by <span class="op">=</span> <span class="st">"Year"</span><span class="op">)</span>,
               collapse_ordered <span class="op">=</span> <span class="fu"><a href="../reference/flag.html">flag</a></span><span class="op">(</span><span class="va">cgGGDC10S</span>, t <span class="op">=</span> <span class="va">Year</span><span class="op">)</span><span class="op">)</span>
<span class="co"># Unit: microseconds</span>
<span class="co">#                expr        min          lq       mean      median          uq        max neval cld</span>
<span class="co">#     dplyr_unordered  44760.042  47003.5545  58805.844  50658.1050  60146.2355 183804.312   100  b </span>
<span class="co">#  collapse_unordered    404.747    466.1060    570.011    489.9805    518.3175   4665.080   100 a  </span>
<span class="co">#       dplyr_ordered 105484.168 114729.3165 138474.255 121829.7970 144656.9585 347953.171   100   c</span>
<span class="co">#    collapse_ordered    348.520    419.2505    553.308    445.5795    469.4535   5874.859   100 a</span>

<span class="co"># Large</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>dplyr_unordered <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">mutate_all</a></span><span class="op">(</span><span class="va">gdata</span>, <span class="fu">dplyr</span><span class="fu">::</span><span class="va"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">)</span>,
               collapse_unordered <span class="op">=</span> <span class="fu"><a href="../reference/flag.html">flag</a></span><span class="op">(</span><span class="va">cgdata</span><span class="op">)</span>,
               dplyr_ordered <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">mutate_all</a></span><span class="op">(</span><span class="va">gdata</span>, <span class="fu">dplyr</span><span class="fu">::</span><span class="va"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span>, order_by <span class="op">=</span> <span class="st">"Year"</span><span class="op">)</span>,
               collapse_ordered <span class="op">=</span> <span class="fu"><a href="../reference/flag.html">flag</a></span><span class="op">(</span><span class="va">cgdata</span>, t <span class="op">=</span> <span class="va">Year</span><span class="op">)</span>, times <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="co"># Unit: milliseconds</span>
<span class="co">#                expr         min          lq        mean      median         uq        max neval cld</span>
<span class="co">#     dplyr_unordered  9322.60181  9322.60181  9512.82317  9512.82317  9703.0445  9703.0445     2  b </span>
<span class="co">#  collapse_unordered    43.45878    43.45878    53.30324    53.30324    63.1477    63.1477     2 a  </span>
<span class="co">#       dplyr_ordered 24916.39806 24916.39806 24983.25163 24983.25163 25050.1052 25050.1052     2   c</span>
<span class="co">#    collapse_ordered   100.26351   100.26351   118.91758   118.91758   137.5717   137.5717     2 a</span>

<span class="co">## First-Difference (unordered)</span>
<span class="co"># Small</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>dplyr_unordered <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">mutate_all</a></span><span class="op">(</span><span class="va">gGGDC10S</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span> <span class="op">-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>,
               collapse_unordered <span class="op">=</span> <span class="fu"><a href="../reference/fdiff.html">fdiff</a></span><span class="op">(</span><span class="va">cgGGDC10S</span><span class="op">)</span><span class="op">)</span>
<span class="co"># Unit: microseconds</span>
<span class="co">#                expr       min        lq       mean    median       uq        max neval cld</span>
<span class="co">#     dplyr_unordered 60398.812 66697.384 82056.0223 75039.549 88612.19 199408.721   100   b</span>
<span class="co">#  collapse_unordered   447.141   506.939   621.4501   538.176   654.20   2415.988   100  a</span>

<span class="co"># Large</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>dplyr_unordered <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">mutate_all</a></span><span class="op">(</span><span class="va">gdata</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span> <span class="op">-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>,
               collapse_unordered <span class="op">=</span> <span class="fu"><a href="../reference/fdiff.html">fdiff</a></span><span class="op">(</span><span class="va">cgdata</span><span class="op">)</span>, times <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="co"># Unit: milliseconds</span>
<span class="co">#                expr         min          lq       mean     median         uq        max neval cld</span>
<span class="co">#     dplyr_unordered 12687.34061 12687.34061 13168.5915 13168.5915 13649.8424 13649.8424     2   b</span>
<span class="co">#  collapse_unordered    63.99022    63.99022   391.2529   391.2529   718.5155   718.5155     2  a</span>

<span class="fu"><a href="https://rdrr.io/r/base/gc.html">gc</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#            used  (Mb) gc trigger  (Mb) max used  (Mb)</span>
<span class="co"># Ncells  2329725 124.5    5577265 297.9  5577265 297.9</span>
<span class="co"># Vcells 22160371 169.1   73138358 558.1 73138358 558.1</span></pre></div>
<p>Below again some benchmarks for transformations not easily of efficiently performed with <em>dplyr</em>, such as centering on the overall mean, mean-preserving scaling, weighted scaling and centering, sequences of lags / leads, (iterated) panel-differences and growth rates.</p>
<div class="sourceCode" id="cb56"><pre class="downlit">
<span class="co"># Centering on overall mean</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="../reference/fbetween,%20fwithin.html">fwithin</a></span><span class="op">(</span><span class="va">cgdata</span>, mean <span class="op">=</span> <span class="st">"overall.mean"</span><span class="op">)</span>, times <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>
<span class="co"># Unit: milliseconds</span>
<span class="co">#                                    expr      min       lq     mean   median       uq      max neval</span>
<span class="co">#  fwithin(cgdata, mean = "overall.mean") 72.63048 91.55587 123.9617 116.3387 147.5185 206.2484    10</span>

<span class="co"># Weighted Centering</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="../reference/fbetween,%20fwithin.html">fwithin</a></span><span class="op">(</span><span class="va">cgdata</span>, <span class="va">SUM</span><span class="op">)</span>, times <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>
<span class="co"># Unit: milliseconds</span>
<span class="co">#                  expr      min       lq    mean   median       uq     max neval</span>
<span class="co">#  fwithin(cgdata, SUM) 73.07449 80.44161 92.4393 85.42308 103.6144 126.838    10</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="../reference/fbetween,%20fwithin.html">fwithin</a></span><span class="op">(</span><span class="va">cgdata</span>, <span class="va">SUM</span>, mean <span class="op">=</span> <span class="st">"overall.mean"</span><span class="op">)</span>, times <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>
<span class="co"># Unit: milliseconds</span>
<span class="co">#                                         expr      min       lq    mean   median       uq      max</span>
<span class="co">#  fwithin(cgdata, SUM, mean = "overall.mean") 63.72292 74.96703 86.8185 89.93889 96.73592 102.1511</span>
<span class="co">#  neval</span>
<span class="co">#     10</span>

<span class="co"># Weighted Scaling and Standardizing</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="../reference/fvar,%20fsd.html">fsd</a></span><span class="op">(</span><span class="va">cgdata</span>, <span class="va">SUM</span>, TRA <span class="op">=</span> <span class="st">"/"</span><span class="op">)</span>, times <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>
<span class="co"># Unit: milliseconds</span>
<span class="co">#                         expr      min       lq     mean median       uq      max neval</span>
<span class="co">#  fsd(cgdata, SUM, TRA = "/") 148.6587 165.4211 174.4325 173.45 180.4467 203.8864    10</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="../reference/fscale.html">fscale</a></span><span class="op">(</span><span class="va">cgdata</span>, <span class="va">SUM</span><span class="op">)</span>, times <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>
<span class="co"># Unit: milliseconds</span>
<span class="co">#                 expr      min       lq     mean   median       uq      max neval</span>
<span class="co">#  fscale(cgdata, SUM) 103.4488 109.1581 150.8876 138.2665 163.0167 286.4303    10</span>

<span class="co"># Sequence of lags and leads</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="../reference/flag.html">flag</a></span><span class="op">(</span><span class="va">cgdata</span>, <span class="op">-</span><span class="fl">1</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span>, times <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>
<span class="co"># Unit: milliseconds</span>
<span class="co">#                expr      min       lq     mean   median       uq      max neval</span>
<span class="co">#  flag(cgdata, -1:1) 45.29777 94.41766 119.5111 112.0534 132.4804 245.7396    10</span>

<span class="co"># Iterated difference</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="../reference/fdiff.html">fdiff</a></span><span class="op">(</span><span class="va">cgdata</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>, times <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>
<span class="co"># Unit: milliseconds</span>
<span class="co">#                 expr      min      lq     mean   median       uq      max neval</span>
<span class="co">#  fdiff(cgdata, 1, 2) 58.64149 61.9705 81.35423 80.24704 94.65238 107.5079    10</span>

<span class="co"># Growth Rate</span>
<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="../reference/fgrowth.html">fgrowth</a></span><span class="op">(</span><span class="va">cgdata</span>,<span class="fl">1</span><span class="op">)</span>, times <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>
<span class="co"># Unit: milliseconds</span>
<span class="co">#                expr      min       lq     mean   median       uq      max neval</span>
<span class="co">#  fgrowth(cgdata, 1) 64.37712 69.60224 87.20517 86.34525 105.3159 116.9287    10</span></pre></div>
<!-- Again the benchmarks show stunning performance gains using *collapse* functions. -->
</div>
</div>
<div id="references" class="section level2">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<p>Timmer, M. P., de Vries, G. J., &amp; de Vries, K. (2015). “Patterns of Structural Change in Developing Countries.” . In J. Weiss, &amp; M. Tribe (Eds.), <em>Routledge Handbook of Industry and Development.</em> (pp. 65-83). Routledge.</p>
<p>Cochrane, D. &amp; Orcutt, G. H. (1949). “Application of Least Squares Regression to Relationships Containing Auto-Correlated Error Terms”. <em>Journal of the American Statistical Association.</em> 44 (245): 32–61.</p>
<p>Prais, S. J. &amp; Winsten, C. B. (1954). “Trend Estimators and Serial Correlation”. <em>Cowles Commission Discussion Paper No. 383.</em> Chicago.</p>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>Row-wise operations are not supported by TRA.<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Sebastian Krantz.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
